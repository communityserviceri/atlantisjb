<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Joki LifeAfter Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      background-color: #1a1a2e; /* Darker background */
      color: #e0e0e0; /* Lighter text */
      display: flex; /* Use flexbox for body */
      flex-direction: column; /* Stack children vertically */
      min-height: 100vh; /* Full viewport height */
    }
    h1, h2, h3, h4 {
      font-family: 'Orbitron', sans-serif; /* Sci-fi/gaming font for headings */
    }
    .btn-primary {
      background-image: linear-gradient(to right, #e94560, #ff6b6b);
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(233, 69, 96, 0.4);
    }
    .btn-primary:hover {
      background-image: linear-gradient(to right, #ff6b6b, #e94560);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(233, 69, 96, 0.6);
    }
    .btn-secondary {
      background-color: #3f72af;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(63, 114, 175, 0.4);
    }
    .btn-secondary:hover {
      background-color: #528ecc;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(63, 114, 175, 0.6);
    }
    .btn-danger {
      background-color: #dc3545;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
    }
    .btn-danger:hover {
      background-color: #c82333;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(220, 53, 69, 0.6);
    }
    .card {
      background-color: #2e2e4a; /* Slightly lighter card background */
      border: 1px solid #4a4a6a;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover {
      transform: translateY(-2px); /* Slight hover for cards */
      box-shadow: 0 10px 28px rgba(0, 0, 0, 0.4);
    }
    input[type="text"], input[type="password"], input[type="email"], select, textarea, input[type="search"], input[type="number"], input[type="url"] {
      background-color: #1f1f3a;
      border: 1px solid #4a4a6a;
      color: #e0e0e0;
    }
    input[type="text"]:focus, input[type="password"]:focus, input[type="email"]:focus, select:focus, textarea:focus, input[type="search"]:focus, input[type="number"]:focus, input[type="url"]:focus {
      border-color: #e94560;
      box-shadow: 0 0 0 2px rgba(233, 69, 96, 0.5);
    }
    .status-pending { color: #ffc107; } /* Yellow */
    .status-in-progress { color: #00bcd4; } /* Cyan */
    .status-completed { color: #4CAF50; } /* Green */
    .status-cancelled { color: #dc3545; } /* Red */

    /* Progress Tracker Styles */
    .progress-tracker {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 1rem;
      position: relative;
      padding: 0 10px; /* Add padding to ensure circles are not cut off */
    }
    .progress-tracker::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 2px;
      background-color: #4a4a6a; /* Line color */
      transform: translateY(-50%);
      z-index: 0;
    }
    .progress-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 1;
      text-align: center;
      flex: 1; /* Distribute space evenly */
    }
    .progress-circle {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background-color: #4a4a6a; /* Default circle color */
      display: flex;
      justify-content: center;
      align-items: center;
      color: #e0e0e0;
      font-size: 0.75rem;
      font-weight: bold;
      border: 2px solid #4a4a6a;
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }
    .progress-label {
      font-size: 0.75rem;
      margin-top: 0.5rem;
      color: #9ca3af; /* Default label color */
      transition: color 0.3s ease;
    }

    /* Active/Completed/Cancelled states for progress tracker */
    .progress-step.active .progress-circle {
      background-color: #00bcd4; /* In Progress */
      border-color: #00bcd4;
    }
    .progress-step.active .progress-label {
      color: #00bcd4;
    }
    .progress-step.completed .progress-circle {
      background-color: #4CAF50; /* Completed */
      border-color: #4CAF50;
    }
    .progress-step.completed .progress-label {
      color: #4CAF50;
    }
    .progress-step.cancelled .progress-circle {
      background-color: #dc3545; /* Cancelled */
      border-color: #dc3545;
    }
    .progress-step.cancelled .progress-label {
      color: #dc3545;
    }
    .progress-step.pending .progress-circle {
      background-color: #ffc107; /* Pending */
      border-color: #ffc107;
    }
    .progress-step.pending .progress-label {
      color: #ffc107;
    }
    /* Style for copy icon */
    .copy-icon {
        cursor: pointer;
        margin-left: 0.5rem;
        color: #9ca3af; /* Light gray */
        transition: color 0.2s ease;
    }
    .copy-icon:hover {
        color: #e0e0e0; /* Lighter on hover */
    }

    /* Sidebar styles */
    .sidebar {
      width: 250px;
      background-color: #1f1f3a;
      border-right: 1px solid #4a4a6a;
      padding-top: 1.5rem; /* Adjusted padding-top */
      position: sticky; /* Make sidebar sticky */
      top: 0; /* Stick to the top */
      height: 100vh; /* Full viewport height */
      overflow-y: auto;
      z-index: 1000;
      flex-shrink: 0; /* Prevent sidebar from shrinking */
    }
    .sidebar-item {
      display: flex;
      align-items: center;
      padding: 0.75rem 1.5rem;
      color: #e0e0e0;
      font-weight: 500;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    .sidebar-item:hover, .sidebar-item.active {
      background-color: #2e2e4a;
      color: #e94560;
      border-left: 4px solid #e94560;
    }
    .sidebar-item i {
      margin-right: 1rem;
      font-size: 1.2rem;
    }
    .dashboard-main-content {
      flex-grow: 1; /* Allow main content to grow */
      display: flex;
      flex-direction: column;
    }
    .content-area {
      padding: 1.5rem;
      flex-grow: 1;
    }

    /* Header styles within dashboard */
    .dashboard-header {
      background-color: #1a1a2e; /* Darker background */
      padding: 1rem 1.5rem;
      border-bottom: 2px solid #e94560;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0; /* Prevent header from shrinking */
    }
    .dashboard-header .admin-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
        border-right: none;
        border-bottom: 1px solid #4a4a6a;
        padding-top: 0; /* Remove top padding on mobile */
      }
      .dashboard-main-content {
        margin-left: 0;
      }
      .sidebar-item {
        justify-content: center;
        padding: 0.75rem 1rem;
        border-left: none !important;
      }
      .sidebar-item.active {
        border-bottom: 4px solid #e94560;
      }
      .sidebar-nav {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
      }
      .dashboard-header {
        flex-direction: column;
        text-align: center;
        gap: 0.5rem;
      }
      .dashboard-header .admin-info {
        flex-direction: column;
        gap: 0.5rem;
      }
    }
  </style>
  <script type="text/javascript" src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script type="text/javascript" src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script type="text/javascript" src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script type="text/javascript" src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <!-- Chart.js for analytics -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    // --- Firebase Setup ---
    const firebaseConfig = {
      apiKey: "AIzaSyBdKELW2FNsL7H1zB8R765czcDPaSYybdg",
      authDomain: "atlantis-store.firebaseapp.com",
      databaseURL: "https://atlantis-store-default-rtdb.firebaseio.com",
      projectId: "atlantis-store",
      storageBucket: "atlantis-store.appspot.com",
      messagingSenderId: "566295949160",
      appId: "1:566295949160:web:3ad8956c753d2f05a5f0dd",
      measurementId: "G-F5RG09TFCK"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();

    // --- Admin Email Whitelist (Specific Emails) ---
    const ADMIN_EMAILS = ['admin@atlantis.com', 'itsupport@atlantis.com', 'service@atlantis.com'];

    // --- UI Elements ---
    const loginSection = document.getElementById("loginSection");
    const dashboardSection = document.getElementById("dashboardSection");
    const adminEmailDisplay = document.getElementById("adminEmailDisplay");
    const loginForm = document.getElementById("loginForm");

    // Main Content Sections
    const mainDashboardContent = document.getElementById("mainDashboardContent");
    const ordersManagementSection = document.getElementById("ordersManagementSection");
    const orderHistorySection = document.getElementById("orderHistorySection");
    const contentPromoSection = document.getElementById("contentPromoSection");
    const supportComplaintSection = document.getElementById("supportComplaintSection");
    // const settingsSection = document.getElementById("settingsSection"); // Removed

    // Order Management Specific
    const ordersList = document.getElementById("ordersList");
    const orderStatusFilter = document.getElementById("orderStatusFilter");
    const orderSearchInput = document.getElementById("orderSearchInput");

    // Order History Specific
    const historyList = document.getElementById("historyList");

    // Banner Management Specific (now inside contentPromoSection)
    const bannerForm = document.getElementById("bannerForm");
    const bannerList = document.getElementById("bannerList");
    const bannerImagePreview = document.getElementById("bannerImagePreview");
    const bannerSubmitButton = document.getElementById("bannerSubmitButton");
    const bannerCancelEditButton = document.getElementById("bannerCancelEditButton");

    // Dashboard Analytics Specific
    const totalOrdersCard = document.getElementById("totalOrdersCard");
    const totalRevenueCard = document.getElementById("totalRevenueCard");
    const activeJokisCard = document.getElementById("activeJokisCard");
    const ordersPerGameChartCtx = document.getElementById('ordersPerGameChart')?.getContext('2d');
    const monthlyRevenueChartCtx = document.getElementById('monthlyRevenueChart')?.getContext('2d');
    let ordersPerGameChart;
    let monthlyRevenueChart;

    // Support & Complaints Specific
    const complaintList = document.getElementById("complaintList");

    // Settings Specific (Removed elements)
    // const settingsForm = document.getElementById("settingsForm");
    // const brightnessRange = document.getElementById("brightnessRange");
    // const brightnessValueSpan = document.getElementById("brightnessValue");
    // const themeSelect = document.getElementById("themeSelect");


    let editingBannerId = null; // To store the ID of the banner being edited
    let currentFilterStatus = 'all'; // Default filter status for orders
    let currentSearchTerm = ''; // Default search term for orders
    let isViewingHistory = false; // State to track if currently viewing history

    // --- Auth State Listener ---
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        if (ADMIN_EMAILS.includes(user.email)) {
          loginSection.classList.add("hidden");
          dashboardSection.classList.remove("hidden");
          adminEmailDisplay.textContent = user.email;
          cleanOldOrders(); // Call cleanOldOrders on login
          showSection('mainDashboardContent'); // Show main dashboard by default
          // Initial fetches for sections that might be shown first
          fetchOrders(currentFilterStatus, currentSearchTerm);
          fetchBanners();
          fetchComplaints();
          fetchDashboardAnalytics();
          // No settings to apply on login
        } else {
          alert("Akses ditolak. Email Anda tidak terdaftar sebagai admin yang diizinkan.");
          await auth.signOut();
        }
      } else {
        loginSection.classList.remove("hidden");
        dashboardSection.classList.add("hidden");
        adminEmailDisplay.textContent = "";
        ordersList.innerHTML = "";
        bannerList.innerHTML = "";
        historyList.innerHTML = "";
        complaintList.innerHTML = "";
      }
    });

    // --- Handle Admin Login ---
    async function handleLogin(e) {
      e.preventDefault();
      const email = loginForm.adminEmail.value;
      const password = loginForm.adminPassword.value;

      if (!email || !password) {
        alert("Email dan password harus diisi.");
        return;
      }

      if (!ADMIN_EMAILS.includes(email)) {
        alert("Akses ditolak. Email Anda tidak terdaftar sebagai admin yang diizinkan.");
        return;
      }

      try {
        await auth.signInWithEmailAndPassword(email, password);
      } catch (error) {
        console.error("Login gagal:", error);
        alert("Login gagal: " + error.message);
      }
    }

    // --- Handle Admin Logout ---
    async function handleLogout() {
      try {
        await auth.signOut();
        alert("Anda telah logout dari dashboard admin.");
      } catch (error) {
        console.error("Logout gagal:", error);
        alert("Logout gagal: " + error.message);
      }
    }

    // --- Section Visibility Manager ---
    function showSection(sectionId) {
      const sections = [
        mainDashboardContent, ordersManagementSection, orderHistorySection,
        contentPromoSection, supportComplaintSection
        // settingsSection Removed
      ];

      sections.forEach(section => {
        if (section) { // Check if element exists
          section.classList.add('hidden');
        }
      });

      const targetSection = document.getElementById(sectionId);
      if (targetSection) {
        targetSection.classList.remove('hidden');
      }

      // Update active state in sidebar
      document.querySelectorAll('.sidebar-item').forEach(item => {
        item.classList.remove('active');
      });
      const activeItem = document.querySelector(`.sidebar-item[data-section="${sectionId}"]`);
      if (activeItem) {
        activeItem.classList.add('active');
      }

      // Specific actions for sections
      if (sectionId === 'ordersManagementSection') {
        isViewingHistory = false;
        fetchOrders(currentFilterStatus, currentSearchTerm);
      } else if (sectionId === 'orderHistorySection') {
        isViewingHistory = true;
        fetchOrderHistory();
      } else if (sectionId === 'contentPromoSection') {
        fetchBanners();
      } else if (sectionId === 'mainDashboardContent') {
        fetchDashboardAnalytics();
      } else if (sectionId === 'supportComplaintSection') {
        fetchComplaints();
      }
      // else if (sectionId === 'settingsSection') { Removed
      //   fetchSettings();
      // }
    }

    // --- Function to clean old orders and move them to history ---
    async function cleanOldOrders() {
        const oneMonthAgo = Date.now() - (30 * 24 * 60 * 60 * 1000); // 30 days in milliseconds
        const ordersRef = db.ref('orders');
        const orderHistoryRef = db.ref('orderHistory');

        ordersRef.orderByChild('waktu').endAt(oneMonthAgo).once('value', async (snapshot) => {
            if (snapshot.exists()) {
                console.log("Mendeteksi pesanan lama untuk diarsipkan:", snapshot.numChildren());
                const updates = {};
                const historyEntries = {};

                snapshot.forEach((childSnapshot) => {
                    const orderId = childSnapshot.key;
                    const orderData = childSnapshot.val();

                    historyEntries[orderId] = {
                        ...orderData,
                        archivedAt: firebase.database.ServerValue.TIMESTAMP
                    };

                    updates[`/orders/${orderId}`] = null;
                });

                try {
                    await orderHistoryRef.update(historyEntries);
                    console.log("Pesanan lama berhasil diarsipkan ke riwayat.");

                    await db.ref().update(updates);
                    console.log("Pesanan lama berhasil dihapus dari daftar aktif.");

                    if (!isViewingHistory && ordersManagementSection && !ordersManagementSection.classList.contains('hidden')) {
                        fetchOrders(currentFilterStatus, currentSearchTerm);
                    }
                } catch (error) {
                    console.error("Gagal mengarsipkan atau menghapus pesanan lama:", error);
                }
            } else {
                console.log("Tidak ada pesanan yang lebih dari 1 bulan.");
            }
        });
    }

    // --- Function to copy text to clipboard ---
    async function copyToClipboard(text) {
        try {
            await navigator.clipboard.writeText(text);
            alert('Teks berhasil disalin!');
        } catch (err) {
            console.error('Gagal menyalin teks:', err);
            alert('Gagal menyalin teks. Silakan salin secara manual.');
        }
    }

    // --- Fetch All Orders ---
    function fetchOrders(filterStatus = 'all', searchTerm = '') {
      ordersList.innerHTML = '<p class="text-gray-400 text-center py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Memuat pesanan...</p>';
      let ordersRef = db.ref('orders');

      ordersRef.on('value', (snapshot) => {
        if (snapshot.exists()) {
          ordersList.innerHTML = '';
          let orders = [];
          snapshot.forEach((childSnapshot) => {
            orders.push({ id: childSnapshot.key, ...childSnapshot.val() });
          });

          if (filterStatus !== 'all') {
            orders = orders.filter(order => order.status === filterStatus);
          }

          if (searchTerm) {
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            orders = orders.filter(order =>
              (order.nama && order.nama.toLowerCase().includes(lowerCaseSearchTerm)) ||
              (order.email && order.email.toLowerCase().includes(lowerCaseSearchTerm)) ||
              (order.whatsapp && order.whatsapp.includes(lowerCaseSearchTerm)) ||
              (order.id && order.id.toLowerCase().includes(lowerCaseSearchTerm)) ||
              (order.jenis && order.jenis.toLowerCase().includes(lowerCaseSearchTerm))
            );
          }

          orders.sort((a, b) => b.waktu - a.waktu);

          if (orders.length === 0) {
            ordersList.innerHTML = '<p class="text-gray-400 text-center py-4">Tidak ada pesanan joki yang cocok dengan filter/pencarian ini.</p>';
            return;
          }

          orders.forEach((order) => {
            const orderElement = document.createElement('div');
            orderElement.className = 'card p-6 rounded-xl mb-4';
            let statusClass = '';
            switch (order.status) {
              case 'pending': statusClass = 'status-pending'; break;
              case 'in progress': statusClass = 'status-in-progress'; break;
              case 'completed': statusClass = 'status-completed'; break;
              case 'cancelled': statusClass = 'status-cancelled'; break;
              default: statusClass = 'text-gray-400';
            }

            let pendingClass = '';
            let inProgressClass = '';
            let completedClass = '';
            let cancelledClass = '';

            if (order.status === 'pending') {
                pendingClass = 'pending';
            } else if (order.status === 'in progress') {
                pendingClass = 'completed';
                inProgressClass = 'active';
            } else if (order.status === 'completed') {
                pendingClass = 'completed';
                inProgressClass = 'completed';
                completedClass = 'completed';
            } else if (order.status === 'cancelled') {
                pendingClass = 'completed';
                inProgressClass = 'completed';
                cancelledClass = 'cancelled';
            }

            let orderSpecificDetails = '';
            let imageButtons = '';
            let lifeAfterCredentialsDisplay = '';

            if (order.jenis === 'full') {
                orderSpecificDetails = `
                    <p><i class="fas fa-dollar-sign mr-2 text-blue-400"></i>Harga: <span class="font-medium text-green-400">Rp ${order.price ? order.price.toLocaleString('id-ID') : 'N/A'}</span></p>
                `;
                if (order.proofURL) {
                    imageButtons += `<a href="${order.proofURL}" target="_blank" class="btn-secondary inline-block text-white px-4 py-2 rounded-lg text-sm mt-2 mr-2"><i class="fas fa-image mr-1"></i>Lihat Bukti Pembayaran</a>`;
                }
                lifeAfterCredentialsDisplay = `
                    <p><i class="fas fa-key mr-2 text-yellow-400"></i>Transfer Code: <span class="font-medium">${order.transferCode || 'N/A'}</span> <i class="fas fa-copy copy-icon" onclick="copyToClipboard('${order.transferCode || ''}')"></i></p>
                    <p><i class="fas fa-lock mr-2 text-yellow-400"></i>Password: <span class="font-medium">${order.password || 'N/A'}</span> <i class="fas fa-copy copy-icon" onclick="copyToClipboard('${order.password || ''}')"></i></p>
                `;
            } else if (order.jenis === 'floor') {
                orderSpecificDetails = `
                    <p><i class="fas fa-layer-group mr-2 text-blue-400"></i>Target Floor: <span class="font-medium">${order.floorTarget || 'N/A'}</span></p>
                    <p><i class="fas fa-hashtag mr-2 text-blue-400"></i>Jumlah Floor: <span class="font-medium">${order.floorCount || 'N/A'}</span></p>
                    <p><i class="fas fa-dollar-sign mr-2 text-blue-400"></i>Harga: <span class="font-medium text-yellow-400">${order.priceInfo || 'Akan diinformasikan via WhatsApp'}</span></p>
                    <div class="mt-3">
                        <h6 class="font-semibold text-gray-300 mb-2">Input Harga per Floor:</h6>
                        <div id="floorPriceInputs-${order.id}" class="space-y-2">
                            <!-- Dynamic floor price inputs will be rendered here -->
                        </div>
                        <button onclick="renderFloorPriceInputs('${order.id}', ${order.floorCount || 0})" class="btn-secondary px-3 py-1 rounded-lg text-sm mt-2"><i class="fas fa-plus-circle mr-1"></i>Atur Harga Floor</button>
                        <button onclick="saveFloorPrices('${order.id}')" class="btn-primary px-3 py-1 rounded-lg text-sm mt-2 ml-2"><i class="fas fa-save mr-1"></i>Simpan Harga</button>
                        <button onclick="generateWhatsAppOffer('${order.id}')" class="btn-primary px-3 py-1 rounded-lg text-sm mt-2 ml-2"><i class="fab fa-whatsapp mr-1"></i>Buat Penawaran WA</button>
                    </div>
                `;
                if (order.statProofURL) {
                    imageButtons += `<a href="${order.statProofURL}" target="_blank" class="btn-secondary inline-block text-white px-4 py-2 rounded-lg text-sm mt-2 mr-2"><i class="fas fa-chart-bar mr-1"></i>Lihat Screenshot Stat Akun</a>`;
                }
                lifeAfterCredentialsDisplay = `
                    <p><i class="fas fa-key mr-2 text-yellow-400"></i>Transfer Code: <span class="font-medium">${order.transferCode || 'N/A'}</span> <i class="fas fa-copy copy-icon" onclick="copyToClipboard('${order.transferCode || ''}')"></i></p>
                    <p><i class="fas fa-lock mr-2 text-yellow-400"></i>Password: <span class="font-medium">${order.password || 'N/A'}</span> <i class="fas fa-copy copy-icon" onclick="copyToClipboard('${order.password || ''}')"></i></p>
                `;
            } else if (order.jenis === 'roblox_mountain') {
                orderSpecificDetails = `
                    <p><i class="fab fa-roblox mr-2 text-blue-400"></i>Username Roblox: <span class="font-medium">${order.robloxUsername || 'N/A'}</span></p>
                    <p><i class="fas fa-mountain mr-2 text-blue-400"></i>Nama Gunung: <span class="font-medium">${order.mountainName || 'N/A'}</span></p>
                    <p><i class="fas fa-hashtag mr-2 text-blue-400"></i>Jumlah Gunung: <span class="font-medium">${order.mountainQty || 'N/A'}</span></p>
                    <p><i class="fas fa-dollar-sign mr-2 text-blue-400"></i>Harga: <span class="font-medium text-green-400">Rp ${order.price ? order.price.toLocaleString('id-ID') : 'N/A'}</span></p>
                `;
                if (order.proofURL) {
                    imageButtons += `<a href="${order.proofURL}" target="_blank" class="btn-secondary inline-block text-white px-4 py-2 rounded-lg text-sm mt-2 mr-2"><i class="fas fa-image mr-1"></i>Lihat Bukti Pembayaran</a>`;
                }
                lifeAfterCredentialsDisplay = '';
            }


            orderElement.innerHTML = `
              <div class="flex justify-between items-center mb-4 border-b border-gray-600 pb-3">
                <h5 class="text-xl font-bold text-red-400">Order ID: <span class="text-gray-300 text-base">${order.id}</span></h5>
                <span class="text-sm font-semibold ${statusClass}">${order.status ? order.status.toUpperCase() : 'N/A'}</span>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-y-2 gap-x-4 text-gray-300 mb-4">
                <p><i class="fas fa-user mr-2 text-blue-400"></i>Nama Pemesan: <span class="font-medium">${order.nama || 'N/A'}</span></p>
                <p><i class="fas fa-envelope mr-2 text-blue-400"></i>Email: <span class="font-medium">${order.email || 'N/A'}</span></p>
                <p><i class="fas fa-gamepad mr-2 text-blue-400"></i>Jenis Joki: <span class="font-medium">${order.jenis === 'full' ? 'Death High Full Service' : order.jenis === 'floor' ? 'Death High Per Floor' : 'Joki Gendong Naik Gunung Roblox'}</span></p>
                <p><i class="fas fa-mobile-alt mr-2 text-blue-400"></i>Device: <span class="font-medium">${order.device || 'N/A'}</span></p>
                ${lifeAfterCredentialsDisplay}
                <p><i class="fab fa-whatsapp mr-2 text-green-400"></i>WhatsApp: <a href="https://wa.me/${order.whatsapp}" target="_blank" class="text-green-400 hover:underline">${order.whatsapp || 'N/A'}</a></p>
                ${orderSpecificDetails}
                <p class="text-sm text-gray-500"><i class="fas fa-clock mr-2 text-gray-500"></i>Waktu Order: ${order.waktu ? new Date(order.waktu).toLocaleString() : 'N/A'}</p>
              </div>
              ${imageButtons}

              <!-- Progress Tracker -->
              <div class="progress-tracker">
                <div class="progress-step ${pendingClass}">
                  <div class="progress-circle"><i class="fas fa-hourglass-half"></i></div>
                  <div class="progress-label">Pending</div>
                </div>
                <div class="progress-step ${inProgressClass}">
                  <div class="progress-circle"><i class="fas fa-cogs"></i></div>
                  <div class="progress-label">In Progress</div>
                </div>
                <div class="progress-step ${completedClass}">
                  <div class="progress-circle"><i class="fas fa-check"></i></div>
                  <div class="progress-label">Completed</div>
                </div>
                <div class="progress-step ${cancelledClass}">
                  <div class="progress-circle"><i class="fas fa-times"></i></div>
                  <div class="progress-label">Cancelled</div>
                </div>
              </div>

              <div class="mt-4 flex items-center space-x-3">
                <label for="status-${order.id}" class="text-gray-300">Ubah Status:</label>
                <select id="status-${order.id}" class="p-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-red-500 focus:outline-none" onchange="updateOrderStatus('${order.id}', this.value)">
                  <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                  <option value="in progress" ${order.status === 'in progress' ? 'selected' : ''}>In Progress</option>
                  <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Completed</option>
                  <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                </select>
              </div>
            `;
            ordersList.appendChild(orderElement);
            // Automatically render floor price inputs if it's a floor order and the section is visible
            // This ensures inputs are ready even if not explicitly clicked
            if (order.jenis === 'floor' && !ordersManagementSection.classList.contains('hidden')) {
                renderFloorPriceInputs(order.id, order.floorCount || 0);
            }
          });
        } else {
          ordersList.innerHTML = '<p class="text-gray-400 text-center py-4">Belum ada pesanan joki dengan status ini.</p>';
        }
      }, (error) => {
        console.error("Error fetching orders:", error);
        ordersList.innerHTML = '<p class="text-red-500 text-center py-4">Gagal memuat pesanan. Silakan coba lagi.</p>';
      });
    }

    // Event listener for filter change
    if (orderStatusFilter) {
        orderStatusFilter.addEventListener('change', (e) => {
            currentFilterStatus = e.target.value;
            fetchOrders(currentFilterStatus, currentSearchTerm);
        });
    }

    // Event listener for search input
    if (orderSearchInput) {
        orderSearchInput.addEventListener('input', (e) => {
            currentSearchTerm = e.target.value;
            fetchOrders(currentFilterStatus, currentSearchTerm);
        });
    }

    // --- Update Order Status ---
    async function updateOrderStatus(orderId, newStatus) {
      try {
        await db.ref('orders/' + orderId).update({ status: newStatus });
        alert(`Status pesanan ${orderId} berhasil diubah menjadi ${newStatus.toUpperCase()}.`);
      } catch (error) {
        console.error("Gagal update status:", error);
        alert("Gagal mengubah status pesanan: " + error.message);
      }
    }

    // --- Render Dynamic Floor Price Inputs ---
    async function renderFloorPriceInputs(orderId, floorCount) {
        const container = document.getElementById(`floorPriceInputs-${orderId}`);
        if (!container) return;

        container.innerHTML = ''; // Clear previous inputs

        const orderSnapshot = await db.ref(`orders/${orderId}`).once('value');
        const orderData = orderSnapshot.val();
        const floorTarget = parseInt(orderData.floorTarget || 0); // Get floorTarget

        if (floorTarget === 0 || floorCount === 0) {
            container.innerHTML = '<p class="text-gray-500 text-sm">Informasi Floor Target atau Jumlah Floor tidak valid.</p>';
            return;
        }

        const snapshot = await db.ref(`orders/${orderId}/floorPrices`).once('value');
        const existingPrices = snapshot.val() || {};

        for (let i = 0; i < floorCount; i++) {
            const currentFloorNumber = floorTarget + i;
            const inputDiv = document.createElement('div');
            inputDiv.className = 'flex items-center space-x-2';
            inputDiv.innerHTML = `
                <label for="floor-${orderId}-${currentFloorNumber}" class="text-gray-400 text-sm">Floor ${currentFloorNumber}:</label>
                <input type="number" id="floor-${orderId}-${currentFloorNumber}"
                       class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-red-500 focus:outline-none text-sm"
                       placeholder="Harga Floor ${currentFloorNumber}" value="${existingPrices[`floor${currentFloorNumber}`] || ''}">
            `;
            container.appendChild(inputDiv);
        }
    }

    // --- Save Floor Prices to Firebase ---
    async function saveFloorPrices(orderId) {
        const container = document.getElementById(`floorPriceInputs-${orderId}`);
        if (!container) {
            alert("Error: Container input harga floor tidak ditemukan.");
            return;
        }

        const orderSnapshot = await db.ref(`orders/${orderId}`).once('value');
        const orderData = orderSnapshot.val();
        const floorTarget = parseInt(orderData.floorTarget || 0);
        const actualFloorCount = parseInt(orderData.floorCount || 0);

        if (floorTarget === 0 || actualFloorCount === 0) {
            alert("Informasi Floor Target atau Jumlah Floor tidak valid untuk order ini. Tidak dapat menyimpan harga.");
            return;
        }

        const floorPrices = {};
        let allPricesValid = true;

        for (let i = 0; i < actualFloorCount; i++) {
            const currentFloorNumber = floorTarget + i;
            const input = document.getElementById(`floor-${orderId}-${currentFloorNumber}`);
            if (!input) {
                allPricesValid = false;
                console.error(`Input for floor ${currentFloorNumber} not found for order ${orderId}`);
                continue;
            }
            const price = parseFloat(input.value);

            if (isNaN(price) || price <= 0) {
                allPricesValid = false;
                input.classList.add('border-red-500'); // Highlight invalid input
            } else {
                input.classList.remove('border-red-500');
                floorPrices[`floor${currentFloorNumber}`] = price;
            }
        }

        if (!allPricesValid) {
            alert("Pastikan semua harga floor diisi dengan angka yang valid (lebih dari 0). Input yang bermasalah ditandai merah.");
            return;
        }

        // Double check if all expected floors have a price
        if (Object.keys(floorPrices).length !== actualFloorCount) {
            alert(`Beberapa harga floor belum diisi atau tidak valid. Harap lengkapi semua ${actualFloorCount} harga floor.`);
            return;
        }

        try {
            await db.ref(`orders/${orderId}/floorPrices`).set(floorPrices);
            const totalHarga = Object.values(floorPrices).reduce((sum, price) => sum + price, 0);
            await db.ref(`orders/${orderId}`).update({
                priceInfo: `Harga total: Rp ${totalHarga.toLocaleString('id-ID')}`,
                price: totalHarga
            });
            alert("Harga per floor berhasil disimpan dan total harga diperbarui!");
            fetchOrders(currentFilterStatus, currentSearchTerm); // Refresh order list to show updated priceInfo
        } catch (error) {
            console.error("Gagal menyimpan harga floor:", error);
            alert("Gagal menyimpan harga per floor: " + error.message);
        }
    }

    // --- Generate WhatsApp Offer Message ---
    async function generateWhatsAppOffer(orderId) {
        try {
            const snapshot = await db.ref('orders/' + orderId).once('value');
            let order = snapshot.val();

            if (!order) {
                alert("Order tidak ditemukan.");
                return;
            }

            order.id = orderId; // Ensure order ID is part of the object

            if (!order.whatsapp) {
                alert("Nomor WhatsApp customer tidak tersedia untuk order ini.");
                return;
            }

            const floorPricesSnapshot = await db.ref(`orders/${orderId}/floorPrices`).once('value');
            const floorPrices = floorPricesSnapshot.val();

            if (!floorPrices || Object.keys(floorPrices).length === 0) {
                alert("Harga per floor belum diatur atau disimpan. Silakan atur dan simpan harga terlebih dahulu.");
                return;
            }

            const floorTarget = parseInt(order.floorTarget || 0);
            const actualFloorCount = parseInt(order.floorCount || 0);

            if (floorTarget === 0 || actualFloorCount === 0) {
                alert("Informasi Floor Target atau Jumlah Floor tidak valid untuk order ini. Tidak dapat membuat penawaran WA.");
                return;
            }

            // --- Membangun pesan dengan karakter newline (\n) ---
            let message = `Halo *${order.nama || 'Pelanggan Yth.'}*,\n\n`;
            message += `Terima kasih telah memesan layanan joki Death High Per Floor dengan Order ID: *${order.id}*.\n\n`;
            message += `Berikut adalah rincian penawaran harga per floor untuk Anda:\n\n`;

            let totalHargaCalculated = 0;

            for (let i = 0; i < actualFloorCount; i++) {
                const currentFloorNumber = floorTarget + i;
                const price = floorPrices[`floor${currentFloorNumber}`];
                if (typeof price === 'number' && price > 0) {
                    message += `* Floor ${currentFloorNumber}: Rp ${price.toLocaleString('id-ID')}\n`;
                    totalHargaCalculated += price;
                } else {
                    message += `* Floor ${currentFloorNumber}: Harga belum diatur atau tidak valid\n`;
                }
            }

            const finalTotalHarga = totalHargaCalculated > 0 ? totalHargaCalculated : (order.price || 0);

            message += `\nTotal harga keseluruhan untuk ${actualFloorCount} floor (dari Floor ${floorTarget} hingga Floor ${floorTarget + actualFloorCount - 1}) adalah: *Rp ${finalTotalHarga.toLocaleString('id-ID')}*.\n\n`;
            message += `Silakan lakukan pembayaran ke salah satu metode berikut:\n\n`;
            message += `*Metode Pembayaran:*\n`;
            message += `*DANA:* 089634568406\n`;
            message += `*Gopay:* 089634568406\n`;
            message += `*OVO:* 089634568406\n`;
            message += `*BRI:* 079801006323504 *a.n. Bima Adhitya Susilo Putra*\n`;
            message += `*BCA:* 4460995146 *a.n. Bima Adhitya Susilo Putra*\n`;
            message += `*Trakteer:* trakteer.id/itshiro16/tip\n`;
            message += `*Saweria:* saweria.co/mizukikun\n\n`;
            message += `Mohon lakukan pembayaran sebelum mengunggah bukti pembayaran.\n\n`;
            message += `Setelah pembayaran, mohon konfirmasi dengan mengirimkan bukti transfer kepada kami. Terima kasih atas kepercayaan Anda!\n\n`;
            message += `Salam hormat,\nJoki LifeAfter Pro`;

            // --- Encoding seluruh pesan sekali saja ---
            const whatsappUrl = `https://wa.me/${order.whatsapp}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');

        } catch (error) {
            console.error("Gagal membuat pesan WhatsApp:", error);
            alert("Terjadi kesalahan saat membuat pesan penawaran WhatsApp: " + error.message);
        }
    }

    // --- Fetch Order History ---
    function fetchOrderHistory() {
        historyList.innerHTML = '<p class="text-gray-400 text-center py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Memuat riwayat pesanan...</p>';
        const orderHistoryRef = db.ref('orderHistory');

        orderHistoryRef.on('value', (snapshot) => {
            if (snapshot.exists()) {
                historyList.innerHTML = '';
                const historyOrders = [];
                snapshot.forEach((childSnapshot) => {
                    historyOrders.push({ id: childSnapshot.key, ...childSnapshot.val() });
                });

                historyOrders.sort((a, b) => b.archivedAt - a.archivedAt);

                if (historyOrders.length === 0) {
                    historyList.innerHTML = '<p class="text-gray-400 text-center py-4">Belum ada riwayat pesanan.</p>';
                    return;
                }

                historyOrders.forEach((order) => {
                    const orderElement = document.createElement('div');
                    orderElement.className = 'card p-6 rounded-xl mb-4';
                    let statusClass = '';
                    switch (order.status) {
                        case 'pending': statusClass = 'status-pending'; break;
                        case 'in progress': statusClass = 'status-in-progress'; break;
                        case 'completed': statusClass = 'status-completed'; break;
                        case 'cancelled': statusClass = 'status-cancelled'; break;
                        default: statusClass = 'text-gray-400';
                    }

                    let orderSpecificDetails = '';
                    let imageButtons = '';
                    let lifeAfterCredentialsDisplay = '';

                    if (order.jenis === 'full') {
                        orderSpecificDetails = `
                            <p><i class="fas fa-dollar-sign mr-2 text-blue-400"></i>Harga: <span class="font-medium text-green-400">Rp ${order.price ? order.price.toLocaleString('id-ID') : 'N/A'}</span></p>
                        `;
                        if (order.proofURL) {
                            imageButtons += `<a href="${order.proofURL}" target="_blank" class="btn-secondary inline-block text-white px-4 py-2 rounded-lg text-sm mt-2 mr-2"><i class="fas fa-image mr-1"></i>Lihat Bukti Pembayaran</a>`;
                        }
                        lifeAfterCredentialsDisplay = `
                            <p><i class="fas fa-key mr-2 text-yellow-400"></i>Transfer Code: <span class="font-medium">${order.transferCode || 'N/A'}</span> <i class="fas fa-copy copy-icon" onclick="copyToClipboard('${order.transferCode || ''}')"></i></p>
                            <p><i class="fas fa-lock mr-2 text-yellow-400"></i>Password: <span class="font-medium">${order.password || 'N/A'}</span> <i class="fas fa-copy copy-icon" onclick="copyToClipboard('${order.password || ''}')"></i></p>
                        `;
                    } else if (order.jenis === 'floor') {
                        orderSpecificDetails = `
                            <p><i class="fas fa-layer-group mr-2 text-blue-400"></i>Target Floor: <span class="font-medium">${order.floorTarget || 'N/A'}</span></p>
                            <p><i class="fas fa-hashtag mr-2 text-blue-400"></i>Jumlah Floor: <span class="font-medium">${order.floorCount || 'N/A'}</span></p>
                            <p><i class="fas fa-dollar-sign mr-2 text-blue-400"></i>Harga: <span class="font-medium text-yellow-400">${order.priceInfo || 'Akan diinformasikan via WhatsApp'}</span></p>
                        `;
                        if (order.statProofURL) {
                            imageButtons += `<a href="${order.statProofURL}" target="_blank" class="btn-secondary inline-block text-white px-4 py-2 rounded-lg text-sm mt-2 mr-2"><i class="fas fa-chart-bar mr-1"></i>Lihat Screenshot Stat Akun</a>`;
                        }
                        lifeAfterCredentialsDisplay = `
                            <p><i class="fas fa-key mr-2 text-yellow-400"></i>Transfer Code: <span class="font-medium">${order.transferCode || 'N/A'}</span> <i class="fas fa-copy copy-icon" onclick="copyToClipboard('${order.transferCode || ''}')"></i></p>
                            <p><i class="fas fa-lock mr-2 text-yellow-400"></i>Password: <span class="font-medium">${order.password || 'N/A'}</span> <i class="fas fa-copy copy-icon" onclick="copyToClipboard('${order.password || ''}')"></i></p>
                        `;
                    } else if (order.jenis === 'roblox_mountain') {
                        orderSpecificDetails = `
                            <p><i class="fab fa-roblox mr-2 text-blue-400"></i>Username Roblox: <span class="font-medium">${order.robloxUsername || 'N/A'}</span></p>
                            <p><i class="fas fa-mountain mr-2 text-blue-400"></i>Nama Gunung: <span class="font-medium">${order.mountainName || 'N/A'}</span></p>
                            <p><i class="fas fa-hashtag mr-2 text-blue-400"></i>Jumlah Gunung: <span class="font-medium">${order.mountainQty || 'N/A'}</span></p>
                            <p><i class="fas fa-dollar-sign mr-2 text-blue-400"></i>Harga: <span class="font-medium text-green-400">Rp ${order.price ? order.price.toLocaleString('id-ID') : 'N/A'}</span></p>
                        `;
                        if (order.proofURL) {
                            imageButtons += `<a href="${order.proofURL}" target="_blank" class="btn-secondary inline-block text-white px-4 py-2 rounded-lg text-sm mt-2 mr-2"><i class="fas fa-image mr-1"></i>Lihat Bukti Pembayaran</a>`;
                        }
                        lifeAfterCredentialsDisplay = '';
                    }

                    orderElement.innerHTML = `
                        <div class="flex justify-between items-center mb-4 border-b border-gray-600 pb-3">
                            <h5 class="text-xl font-bold text-red-400">Order ID: <span class="text-gray-300 text-base">${order.id}</span></h5>
                            <span class="text-sm font-semibold ${statusClass}">${order.status ? order.status.toUpperCase() : 'N/A'}</span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-y-2 gap-x-4 text-gray-300 mb-4">
                            <p><i class="fas fa-user mr-2 text-blue-400"></i>Nama Pemesan: <span class="font-medium">${order.nama || 'N/A'}</span></p>
                            <p><i class="fas fa-envelope mr-2 text-blue-400"></i>Email: <span class="font-medium">${order.email || 'N/A'}</span></p>
                            <p><i class="fas fa-gamepad mr-2 text-blue-400"></i>Jenis Joki: <span class="font-medium">${order.jenis === 'full' ? 'Death High Full Service' : order.jenis === 'floor' ? 'Death High Per Floor' : 'Joki Gendong Naik Gunung Roblox'}</span></p>
                            <p><i class="fas fa-mobile-alt mr-2 text-blue-400"></i>Device: <span class="font-medium">${order.device || 'N/A'}</span></p>
                            ${lifeAfterCredentialsDisplay}
                            <p><i class="fab fa-whatsapp mr-2 text-green-400"></i>WhatsApp: <a href="https://wa.me/${order.whatsapp}" target="_blank" class="text-green-400 hover:underline">${order.whatsapp || 'N/A'}</a></p>
                            ${orderSpecificDetails}
                            <p class="text-sm text-gray-500"><i class="fas fa-clock mr-2 text-gray-500"></i>Waktu Order: ${order.waktu ? new Date(order.waktu).toLocaleString() : 'N/A'}</p>
                            <p class="text-sm text-gray-500"><i class="fas fa-archive mr-2 text-gray-500"></i>Diarsipkan: ${order.archivedAt ? new Date(order.archivedAt).toLocaleString() : 'N/A'}</p>
                        </div>
                        ${imageButtons}
                        <div class="mt-4 flex items-center space-x-3">
                            <button onclick="restoreOrder('${order.id}')" class="btn-secondary px-3 py-1 rounded-lg text-sm"><i class="fas fa-undo mr-1"></i>Pulihkan</button>
                            <button onclick="deleteHistoryEntry('${order.id}')" class="btn-danger px-3 py-1 rounded-lg text-sm"><i class="fas fa-trash-alt mr-1"></i>Hapus Permanen</button>
                        </div>
                    `;
                    historyList.appendChild(orderElement);
                });
            } else {
                historyList.innerHTML = '<p class="text-gray-400 text-center py-4">Belum ada riwayat pesanan.</p>';
            }
        }, (error) => {
            console.error("Error fetching order history:", error);
            historyList.innerHTML = '<p class="text-red-500 text-center py-4">Gagal memuat riwayat pesanan. Silakan coba lagi.</p>';
        });
    }

    // --- Restore Order from History ---
    async function restoreOrder(orderId) {
        if (!confirm("Apakah Anda yakin ingin memulihkan pesanan ini ke daftar aktif?")) {
            return;
        }
        try {
            const snapshot = await db.ref('orderHistory/' + orderId).once('value');
            const orderData = snapshot.val();
            if (orderData) {
                delete orderData.archivedAt;
                await db.ref('orders/' + orderId).set(orderData);
                await db.ref('orderHistory/' + orderId).remove();
                alert("Pesanan berhasil dipulihkan!");
                fetchOrderHistory();
                if (!ordersManagementSection.classList.contains('hidden')) {
                    fetchOrders(currentFilterStatus, currentSearchTerm);
                }
            }
        } catch (error) {
            console.error("Gagal memulihkan pesanan:", error);
            alert("Gagal memulihkan pesanan: " + error.message);
        }
    }

    // --- Delete History Entry Permanently ---
    async function deleteHistoryEntry(orderId) {
        if (!confirm("Apakah Anda yakin ingin menghapus pesanan ini secara permanen dari riwayat? Tindakan ini tidak dapat dibatalkan.")) {
            return;
        }
        try {
            await db.ref('orderHistory/' + orderId).remove();
            alert("Pesanan berhasil dihapus permanen dari riwayat!");
        } catch (error) {
            console.error("Gagal menghapus riwayat pesanan:", error);
            alert("Gagal menghapus riwayat pesanan: " + error.message);
        }
    }

    // --- Banner Management Functions ---
    function previewBannerImage(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          bannerImagePreview.innerHTML = `<img src="${e.target.result}" alt="Preview Banner" class="max-w-full h-48 object-contain rounded-lg mt-2 border border-gray-600 shadow-md">`;
        };
        reader.readAsDataURL(file);
      } else {
        bannerImagePreview.innerHTML = "";
      }
    }

    async function handleBannerSubmit(e) {
      e.preventDefault();
      const title = bannerForm.bannerTitle.value;
      const description = bannerForm.bannerDescription.value;
      const link = bannerForm.bannerLink.value;
      const imageFile = bannerForm.bannerImage.files[0];

      if (!title) {
        alert("Judul banner wajib diisi.");
        return;
      }

      if (!editingBannerId && !imageFile) {
        alert("Gambar banner wajib diunggah untuk banner baru.");
        return;
      }

      bannerSubmitButton.disabled = true;
      bannerSubmitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Memproses...';

      try {
        let downloadURL = bannerImagePreview.querySelector('img') ? bannerImagePreview.querySelector('img').src : null;

        if (imageFile) {
          const storageRef = storage.ref().child(`banners/${Date.now()}_${imageFile.name}`);
          const uploadTask = storageRef.put(imageFile);

          await new Promise((resolve, reject) => {
            uploadTask.on('state_changed',
              (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                console.log('Upload is ' + progress + '% done');
              },
              (error) => {
                console.error('Upload error:', error);
                reject(new Error("Gagal mengunggah gambar banner."));
              },
              async () => {
                resolve();
              }
            );
          });
          downloadURL = await uploadTask.snapshot.ref.getDownloadURL();

          if (editingBannerId) {
            const oldBanner = await db.ref('banners/' + editingBannerId).once('value');
            const oldImageUrl = oldBanner.val().imageUrl;
            if (oldImageUrl && oldImageUrl !== downloadURL) {
              try {
                const oldImageRef = storage.refFromURL(oldImageUrl);
                await oldImageRef.delete();
                console.log("Old banner image deleted successfully.");
              } catch (deleteError) {
                console.warn("Could not delete old banner image (might not exist or permission issue):", deleteError);
              }
            }
          }
        } else if (!editingBannerId && !downloadURL) {
            alert("Gambar banner wajib diunggah untuk banner baru.");
            return;
        }


        const bannerData = {
          title,
          description: description || '',
          link: link || '',
          imageUrl: downloadURL,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        };

        if (editingBannerId) {
          await db.ref('banners/' + editingBannerId).update(bannerData);
          alert("Banner berhasil diperbarui!");
        } else {
          await db.ref('banners').push(bannerData);
          alert("Banner berhasil diunggah!");
        }

        bannerForm.reset();
        bannerImagePreview.innerHTML = "";
        editingBannerId = null;
        bannerSubmitButton.innerHTML = '<i class="fas fa-upload mr-2"></i>Unggah Banner';
        bannerCancelEditButton.classList.add('hidden');
        fetchBanners();
      } catch (error) {
        console.error('Gagal memproses banner:', error);
        alert("Gagal memproses banner: " + error.message);
      } finally {
        bannerSubmitButton.disabled = false;
      }
    }

    function fetchBanners() {
      bannerList.innerHTML = '<p class="text-gray-400 text-center py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Memuat banner...</p>';
      db.ref('banners').on('value', (snapshot) => {
        if (snapshot.exists()) {
          bannerList.innerHTML = '';
          const banners = [];
          snapshot.forEach((childSnapshot) => {
            banners.push({ id: childSnapshot.key, ...childSnapshot.val() });
          });

          banners.sort((a, b) => b.timestamp - a.timestamp);

          if (banners.length === 0) {
            bannerList.innerHTML = '<p class="text-gray-400 text-center py-4">Belum ada banner yang diunggah.</p>';
            return;
          }

          banners.forEach((banner) => {
            const bannerElement = document.createElement('div');
            bannerElement.className = 'card p-4 rounded-xl flex flex-col md:flex-row items-center mb-4 space-y-4 md:space-y-0 md:space-x-4';
            bannerElement.innerHTML = `
              <img src="${banner.imageUrl}" alt="${banner.title}" class="w-full md:w-48 h-32 object-cover rounded-lg border border-gray-700">
              <div class="flex-grow text-center md:text-left">
                <h5 class="text-lg font-bold text-white">${banner.title}</h5>
                <p class="text-sm text-gray-400">${banner.description}</p>
                ${banner.link ? `<a href="${banner.link}" target="_blank" class="text-blue-400 hover:underline text-sm block mt-1"><i class="fas fa-external-link-alt mr-1"></i>Link</a>` : ''}
                <p class="text-xs text-gray-500 mt-1">Diunggah: ${new Date(banner.timestamp).toLocaleString()}</p>
              </div>
              <div class="flex space-x-2 mt-4 md:mt-0">
                <button onclick="editBanner('${banner.id}')" class="btn-secondary px-3 py-1 rounded-lg text-sm"><i class="fas fa-edit mr-1"></i>Edit</button>
                <button onclick="deleteBanner('${banner.id}', '${banner.imageUrl}')" class="btn-danger px-3 py-1 rounded-lg text-sm"><i class="fas fa-trash-alt mr-1"></i>Hapus</button>
              </div>
            `;
            bannerList.appendChild(bannerElement);
          });
        } else {
          bannerList.innerHTML = '<p class="text-gray-400 text-center py-4">Belum ada banner yang diunggah.</p>';
        }
      }, (error) => {
        console.error("Error fetching banners:", error);
        bannerList.innerHTML = '<p class="text-red-500 text-center py-4">Gagal memuat banner. Silakan coba lagi.</p>';
      });
    }

    async function editBanner(bannerId) {
      try {
        const snapshot = await db.ref('banners/' + bannerId).once('value');
        const banner = snapshot.val();

        if (banner) {
          editingBannerId = bannerId;
          bannerForm.bannerTitle.value = banner.title;
          bannerForm.bannerDescription.value = banner.description;
          bannerForm.bannerLink.value = banner.link;
          bannerImagePreview.innerHTML = `<img src="${banner.imageUrl}" alt="Preview Banner" class="max-w-full h-48 object-contain rounded-lg mt-2 border border-gray-600 shadow-md">`;
          bannerSubmitButton.innerHTML = '<i class="fas fa-save mr-2"></i>Update Banner';
          bannerCancelEditButton.classList.remove('hidden');
          if (contentPromoSection && contentPromoSection.classList.contains('hidden')) {
            showSection('contentPromoSection');
          }
          window.scrollTo({ top: bannerForm.offsetTop, behavior: 'smooth' });
        }
      } catch (error) {
        console.error("Error fetching banner for edit:", error);
        alert("Gagal memuat data banner untuk diedit.");
      }
    }

    function cancelEdit() {
      editingBannerId = null;
      bannerForm.reset();
      bannerImagePreview.innerHTML = "";
      bannerSubmitButton.innerHTML = '<i class="fas fa-upload mr-2"></i>Unggah Banner';
      bannerCancelEditButton.classList.add('hidden');
    }

    async function deleteBanner(bannerId, imageUrl) {
      if (!confirm("Apakah Anda yakin ingin menghapus banner ini?")) {
        return;
      }

      try {
        if (imageUrl) {
          const imageRef = storage.refFromURL(imageUrl);
          await imageRef.delete();
        }

        await db.ref('banners/' + bannerId).remove();

        alert("Banner berhasil dihapus!");
      } catch (error) {
        console.error("Gagal menghapus banner:", error);
        alert("Gagal menghapus banner: " + error.message);
      }
    }

    // --- Dashboard Analytics Functions ---
    async function fetchDashboardAnalytics() {
        const ordersRef = db.ref('orders');
        const jokisRef = db.ref('jokis'); // Reference to jokis data

        const now = Date.now();
        const startOfDay = new Date().setHours(0, 0, 0, 0);
        const startOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).getTime();

        let totalOrdersMonth = 0;
        let totalRevenueMonth = 0;
        const ordersPerGame = {};
        const monthlyRevenue = {};

        // Fetch orders data
        ordersRef.on('value', (snapshot) => {
            totalOrdersMonth = 0;
            totalRevenueMonth = 0;
            for (const key in ordersPerGame) delete ordersPerGame[key];
            for (const key in monthlyRevenue) delete monthlyRevenue[key];

            if (snapshot.exists()) {
                snapshot.forEach((childSnapshot) => {
                    const order = childSnapshot.val();
                    const orderTime = order.waktu;
                    const orderPrice = parseFloat(order.price || 0); // Ensure price is a number

                    if (orderTime >= startOfMonth) {
                        totalOrdersMonth++;
                        if (order.status === 'completed') {
                            totalRevenueMonth += orderPrice;
                        }
                    }

                    const gameType = order.jenis === 'full' ? 'Death High Full Service' : order.jenis === 'floor' ? 'Death High Per Floor' : 'Joki Gendong Naik Gunung Roblox';
                    ordersPerGame[gameType] = (ordersPerGame[gameType] || 0) + 1;

                    const orderDate = new Date(orderTime);
                    const yearMonth = `${orderDate.getFullYear()}-${(orderDate.getMonth() + 1).toString().padStart(2, '0')}`;
                    if (order.status === 'completed') {
                        monthlyRevenue[yearMonth] = (monthlyRevenue[yearMonth] || 0) + orderPrice;
                    }
                });
            }

            if (totalOrdersCard) totalOrdersCard.querySelector('span').textContent = totalOrdersMonth;
            if (totalRevenueCard) totalRevenueCard.querySelector('span').textContent = `Rp ${totalRevenueMonth.toLocaleString('id-ID')}`;

            updateOrdersPerGameChart(ordersPerGame);
            updateMonthlyRevenueChart(monthlyRevenue);
        });

        // Fetch jokis data for active jokis count
        jokisRef.on('value', (snapshot) => {
            let activeJokisCount = 0;
            if (snapshot.exists()) {
                snapshot.forEach(() => {
                    activeJokisCount++; // Assuming all listed jokis are active for now
                });
            }
            if (activeJokisCard) activeJokisCard.querySelector('span').textContent = activeJokisCount;
        });
    }

    function updateOrdersPerGameChart(data) {
        if (!ordersPerGameChartCtx) return;

        const labels = Object.keys(data);
        const values = Object.values(data);

        if (ordersPerGameChart) {
            ordersPerGameChart.destroy();
        }

        ordersPerGameChart = new Chart(ordersPerGameChartCtx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: [
                        '#e94560', '#3f72af', '#4CAF50', '#ffc107', '#00bcd4', '#9c27b0'
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: '#e0e0e0'
                        }
                    },
                    title: {
                        display: true,
                        text: 'Jumlah Order per Jenis Joki',
                        color: '#e0e0e0'
                    }
                }
            }
        });
    }

    function updateMonthlyRevenueChart(data) {
        if (!monthlyRevenueChartCtx) return;

        const sortedMonths = Object.keys(data).sort();
        const revenues = sortedMonths.map(month => data[month]);

        if (monthlyRevenueChart) {
            monthlyRevenueChart.destroy();
        }

        monthlyRevenueChart = new Chart(monthlyRevenueChartCtx, {
            type: 'bar',
            data: {
                labels: sortedMonths,
                datasets: [{
                    label: 'Pendapatan Bulanan (Rp)',
                    data: revenues,
                    backgroundColor: '#e94560',
                    borderColor: '#e94560',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false,
                        labels: {
                            color: '#e0e0e0'
                        }
                    },
                    title: {
                        display: true,
                        text: 'Pendapatan Bulanan',
                        color: '#e0e0e0'
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            color: '#e0e0e0'
                        },
                        grid: {
                            color: '#4a4a6a'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: '#e0e0e0',
                            callback: function(value) {
                                return 'Rp ' + value.toLocaleString('id-ID');
                            }
                        },
                        grid: {
                            color: '#4a4a6a'
                        }
                    }
                }
            }
        });
    }

    // --- Support & Complaints Functions ---
    async function fetchComplaints() {
        complaintList.innerHTML = '<p class="text-gray-400 text-center py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Memuat komplain...</p>';
        db.ref('complaints').on('value', (snapshot) => {
            if (snapshot.exists()) {
                complaintList.innerHTML = '';
                const complaints = [];
                snapshot.forEach((childSnapshot) => {
                    complaints.push({ id: childSnapshot.key, ...childSnapshot.val() });
                });

                complaints.sort((a, b) => b.timestamp - a.timestamp);

                if (complaints.length === 0) {
                    complaintList.innerHTML = '<p class="text-gray-400 text-center py-4">Belum ada komplain.</p>';
                    return;
                }

                complaints.forEach((complaint) => {
                    const complaintElement = document.createElement('div');
                    complaintElement.className = 'card p-4 rounded-xl mb-4';
                    let statusClass = '';
                    switch (complaint.status) {
                        case 'open': statusClass = 'status-pending'; break;
                        case 'in progress': statusClass = 'status-in-progress'; break;
                        case 'resolved': statusClass = 'status-completed'; break;
                        case 'closed': statusClass = 'status-cancelled'; break; // Using cancelled for closed
                        default: statusClass = 'text-gray-400';
                    }
                    complaintElement.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <h5 class="text-lg font-bold text-white">Komplain dari: ${complaint.customerName || 'N/A'}</h5>
                            <span class="text-sm font-semibold ${statusClass}">${complaint.status ? complaint.status.toUpperCase() : 'N/A'}</span>
                        </div>
                        <p class="text-sm text-gray-400"><i class="fas fa-tag mr-2"></i>Topik: ${complaint.topic || 'N/A'}</p>
                        <p class="text-sm text-gray-400"><i class="fas fa-comment-dots mr-2"></i>Pesan: ${complaint.message || 'N/A'}</p>
                        <p class="text-xs text-gray-500 mt-1">Diajukan: ${new Date(complaint.timestamp).toLocaleString()}</p>
                        <div class="mt-4 flex items-center space-x-3">
                            <label for="complaintStatus-${complaint.id}" class="text-gray-300">Ubah Status:</label>
                            <select id="complaintStatus-${complaint.id}" class="p-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-red-500 focus:outline-none" onchange="updateComplaintStatus('${complaint.id}', this.value)">
                                <option value="open" ${complaint.status === 'open' ? 'selected' : ''}>Open</option>
                                <option value="in progress" ${complaint.status === 'in progress' ? 'selected' : ''}>In Progress</option>
                                <option value="resolved" ${complaint.status === 'resolved' ? 'selected' : ''}>Resolved</option>
                                <option value="closed" ${complaint.status === 'closed' ? 'selected' : ''}>Closed</option>
                            </select>
                            <button onclick="deleteComplaint('${complaint.id}')" class="btn-danger px-3 py-1 rounded-lg text-sm"><i class="fas fa-trash-alt mr-1"></i>Hapus</button>
                        </div>
                    `;
                    complaintList.appendChild(complaintElement);
                });
            } else {
                complaintList.innerHTML = '<p class="text-gray-400 text-center py-4">Belum ada komplain.</p>';
            }
        }, (error) => {
            console.error("Error fetching complaints:", error);
            complaintList.innerHTML = '<p class="text-red-500 text-center py-4">Gagal memuat komplain. Silakan coba lagi.</p>';
        });
    }

    async function updateComplaintStatus(complaintId, newStatus) {
        try {
            await db.ref('complaints/' + complaintId).update({ status: newStatus });
            alert(`Status komplain ${complaintId} berhasil diubah menjadi ${newStatus.toUpperCase()}.`);
        } catch (error) {
            console.error("Gagal update status komplain:", error);
            alert("Gagal mengubah status komplain: " + error.message);
        }
    }

    async function deleteComplaint(complaintId) {
        if (!confirm("Apakah Anda yakin ingin menghapus komplain ini?")) {
            return;
        }
        try {
            await db.ref('complaints/' + complaintId).remove();
            alert("Komplain berhasil dihapus!");
        } catch (error) {
            console.error("Gagal menghapus komplain:", error);
            alert("Gagal menghapus komplain: " + error.message);
        }
    }

    // --- Settings Functions (Removed) ---
    // No longer needed as settings section is removed.
    // Keeping a default body style for consistency if needed.
    document.body.style.filter = `brightness(100%)`; // Default brightness
    document.body.classList.add('theme-dark'); // Default theme


    // Expose functions to global scope
    window.handleLogin = handleLogin;
    window.handleLogout = handleLogout;
    window.updateOrderStatus = updateOrderStatus;
    window.previewBannerImage = previewBannerImage;
    window.handleBannerSubmit = handleBannerSubmit;
    window.editBanner = editBanner;
    window.deleteBanner = deleteBanner;
    window.cancelEdit = cancelEdit;
    window.restoreOrder = restoreOrder;
    window.deleteHistoryEntry = deleteHistoryEntry;
    window.copyToClipboard = copyToClipboard;
    window.showSection = showSection;
    window.updateComplaintStatus = updateComplaintStatus;
    window.deleteComplaint = deleteComplaint;
    window.renderFloorPriceInputs = renderFloorPriceInputs; // New
    window.saveFloorPrices = saveFloorPrices;             // New
    window.generateWhatsAppOffer = generateWhatsAppOffer;   // New
    // window.handleSettingsSubmit = handleSettingsSubmit; // Removed
    // window.applySettings = applySettings; // Removed
  </script>
</head>
<body>
  <!-- Login Section (remains outside the main dashboard layout) -->
  <section id="loginSection" class="max-w-md mx-auto mt-10 w-full flex-grow">
    <h2 class="text-2xl md:text-4xl font-bold mb-8 text-center text-[#e94560] flex items-center justify-center space-x-3">
      <i class="fas fa-lock"></i>
      <span>Login Admin</span>
    </h2>
    <div class="card p-8 rounded-xl">
      <form id="loginForm" onsubmit="handleLogin(event)" class="space-y-5">
        <div>
          <label for="adminEmail" class="block text-sm font-medium mb-2 text-gray-300">Email Admin</label>
          <input type="email" id="adminEmail" class="w-full p-3 rounded-lg focus:outline-none" required placeholder="admin@atlantis.com">
        </div>
        <div>
          <label for="adminPassword" class="block text-sm font-medium mb-2 text-gray-300">Password</label>
          <input type="password" id="adminPassword" class="w-full p-3 rounded-lg focus:outline-none" required placeholder="Masukkan password admin">
        </div>
        <button type="submit" class="btn-primary w-full text-white px-6 py-3 rounded-lg font-bold text-lg">
          <i class="fas fa-sign-in-alt mr-2"></i>Login
        </button>
      </form>
    </div>
  </section>

  <!-- Admin Dashboard Section (Hidden until logged in) -->
  <section id="dashboardSection" class="hidden flex flex-grow">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="text-center mb-6 px-4">
        <div class="flex justify-center items-center space-x-2 mb-4">
          <i class="fas fa-user-shield text-3xl text-[#e94560]"></i>
          <h2 class="text-2xl font-bold text-white">Admin <span class="text-[#e94560]">Panel</span></h2>
        </div>
        <p class="text-lg font-semibold text-white">Halo, <span id="adminEmailDisplay" class="text-[#e94560]"></span>!</p>
        <button onclick="handleLogout()" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded-lg text-sm mt-2 transition-colors duration-300">
          <i class="fas fa-sign-out-alt mr-1"></i>Logout
        </button>
      </div>
      <nav class="sidebar-nav">
        <a class="sidebar-item active" data-section="mainDashboardContent" onclick="showSection('mainDashboardContent')">
          <i class="fas fa-tachometer-alt"></i> Dashboard
        </a>
        <a class="sidebar-item" data-section="ordersManagementSection" onclick="showSection('ordersManagementSection')">
          <i class="fas fa-clipboard-list"></i> Orders
        </a>
        <a class="sidebar-item" data-section="orderHistorySection" onclick="showSection('orderHistorySection')">
          <i class="fas fa-history"></i> Order History
        </a>
        <a class="sidebar-item" data-section="contentPromoSection" onclick="showSection('contentPromoSection')">
          <i class="fas fa-bullhorn"></i> Content & Promo
        </a>
        <a class="sidebar-item" data-section="supportComplaintSection" onclick="showSection('supportComplaintSection')">
          <i class="fas fa-headset"></i> Support & Complaints
        </a>
        <!-- Settings link removed -->
      </nav>
    </aside>

    <!-- Main Content Area (including its own header) -->
    <div class="dashboard-main-content">
      <!-- Header for the main content area -->
      <header class="dashboard-header">
        <div>
          <h1 class="text-2xl md:text-3xl font-bold text-white">Joki LifeAfter Pro</h1>
          <p class="text-sm md:text-base text-gray-400">Mizuki Hiroshi Ch.</p>
        </div>
        <!-- You can add more elements here if needed, e.g., notifications -->
      </header>

      <main class="content-area">

        <!-- Main Dashboard Content -->
        <section id="mainDashboardContent" class="max-w-6xl mx-auto">
          <h2 class="text-3xl font-bold mb-8 text-[#e94560] flex items-center space-x-3">
            <i class="fas fa-tachometer-alt"></i>
            <span>Dashboard Overview</span>
          </h2>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div id="totalOrdersCard" class="card p-6 rounded-xl text-center">
              <i class="fas fa-box-open text-4xl text-blue-400 mb-3"></i>
              <h3 class="text-xl font-semibold text-white">Total Orders (Bulan Ini)</h3>
              <span class="text-4xl font-bold text-[#e94560]">0</span>
            </div>
            <div id="totalRevenueCard" class="card p-6 rounded-xl text-center">
              <i class="fas fa-dollar-sign text-4xl text-green-400 mb-3"></i>
              <h3 class="text-xl font-semibold text-white">Pendapatan (Bulan Ini)</h3>
              <span class="text-4xl font-bold text-[#4CAF50]">Rp 0</span>
            </div>
            <div id="activeJokisCard" class="card p-6 rounded-xl text-center">
              <i class="fas fa-users-cog text-4xl text-yellow-400 mb-3"></i>
              <h3 class="text-xl font-semibold text-white">Joki Aktif</h3>
              <span class="text-4xl font-bold text-[#ffc107]">0</span>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="card p-6 rounded-xl">
              <canvas id="ordersPerGameChart"></canvas>
            </div>
            <div class="card p-6 rounded-xl">
              <canvas id="monthlyRevenueChart"></canvas>
            </div>
          </div>
        </section>

        <!-- Orders Management Section -->
        <section id="ordersManagementSection" class="max-w-6xl mx-auto hidden">
          <h2 class="text-3xl font-bold mb-8 text-[#e94560] flex items-center space-x-3">
            <i class="fas fa-clipboard-list"></i>
            <span>Daftar Pesanan Joki</span>
          </h2>

          <div class="card p-6 rounded-xl mb-8">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 space-y-4 md:space-y-0">
              <div class="flex items-center space-x-3 w-full md:w-auto">
                <label for="orderStatusFilter" class="text-gray-300 font-medium">Filter Status:</label>
                <select id="orderStatusFilter" class="p-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-red-500 focus:outline-none">
                    <option value="all">Semua Status</option>
                    <option value="pending">Pending</option>
                    <option value="in progress">In Progress</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
              </div>
              <div class="w-full md:w-1/3">
                <input type="search" id="orderSearchInput" placeholder="Cari Order ID, Nama, Email, WhatsApp..." class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-red-500 focus:outline-none">
              </div>
            </div>

            <div id="ordersList" class="space-y-6">
              <!-- Orders will be loaded here -->
              <p class="text-gray-400 text-center py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Memuat pesanan...</p>
            </div>
          </div>
        </section>

        <!-- Order History Section -->
        <section id="orderHistorySection" class="max-w-6xl mx-auto hidden">
          <h2 class="text-3xl font-bold mb-8 text-[#00bcd4] flex items-center space-x-3">
            <i class="fas fa-history"></i>
            <span>Riwayat Pesanan</span>
          </h2>
          <div class="card p-8 rounded-xl">
            <div id="historyList" class="space-y-6">
                <!-- History orders will be loaded here -->
                <p class="text-gray-400 text-center py-4">
                  <i class="fas fa-spinner fa-spin mr-2"></i>Memuat riwayat pesanan...
                </p>
            </div>
          </div>
        </section>

        <!-- Content & Promo Section -->
        <section id="contentPromoSection" class="max-w-6xl mx-auto hidden">
          <h2 class="text-3xl font-bold mb-8 text-[#e94560] flex items-center space-x-3">
            <i class="fas fa-bullhorn"></i>
            <span>Content & Promo Management</span>
          </h2>

          <div class="card p-8 rounded-xl mb-8">
            <h4 class="text-xl font-bold mb-4 text-white" id="bannerFormTitle">Unggah/Edit Banner Promosi</h4>
            <form id="bannerForm" onsubmit="handleBannerSubmit(event)" class="space-y-5">
              <div>
                <label for="bannerTitle" class="block text-sm font-medium mb-2 text-gray-300">Judul Banner</label>
                <input type="text" id="bannerTitle" class="w-full p-3 rounded-lg focus:outline-none" required placeholder="Contoh: Promo Akhir Tahun!">
              </div>
              <div>
                <label for="bannerDescription" class="block text-sm font-medium mb-2 text-gray-300">Deskripsi (Opsional)</label>
                <textarea id="bannerDescription" rows="3" class="w-full p-3 rounded-lg focus:outline-none" placeholder="Deskripsi singkat tentang promosi atau event"></textarea>
              </div>
              <div>
                <label for="bannerLink" class="block text-sm font-medium mb-2 text-gray-300">URL Tautan (Opsional)</label>
                <input type="url" id="bannerLink" class="w-full p-3 rounded-lg focus:outline-none" placeholder="Contoh: https://wa.me/6281234567890">
              </div>
              <div>
                <label for="bannerImage" class="block text-sm font-medium mb-2 text-gray-300">Gambar Banner (Kosongkan jika tidak ingin mengubah)</label>
                <input type="file" id="bannerImage" accept="image/*" class="w-full p-3 rounded-lg focus:outline-none file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-[#e94560] file:text-white hover:file:bg-[#ff6b6b] transition-all duration-200" onchange="previewBannerImage(event)">
                <div id="bannerImagePreview" class="mt-4 flex justify-center"></div>
              </div>
              <div class="flex space-x-4">
                  <button type="submit" id="bannerSubmitButton" class="btn-primary w-full text-white px-6 py-3 rounded-lg font-bold text-lg">
                      <i class="fas fa-upload mr-2"></i>Unggah Banner
                  </button>
                  <button type="button" id="bannerCancelEditButton" onclick="cancelEdit()" class="btn-secondary w-full text-white px-6 py-3 rounded-lg font-bold text-lg hidden">
                      <i class="fas fa-times mr-2"></i>Batal Edit
                  </button>
              </div>
            </form>
          </div>

          <div class="card p-8 rounded-xl">
            <h4 class="text-xl font-bold mb-4 text-white">Daftar Banner Aktif</h4>
            <div id="bannerList" class="space-y-4">
              <!-- Banners will be loaded here -->
              <p class="text-gray-400 text-center py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Memuat banner...</p>
            </div>
          </div>
        </section>

        <!-- Support & Complaints Section -->
        <section id="supportComplaintSection" class="max-w-6xl mx-auto hidden">
          <h2 class="text-3xl font-bold mb-8 text-[#e94560] flex items-center space-x-3">
            <i class="fas fa-headset"></i>
            <span>Support & Complaints</span>
          </h2>
          <div class="card p-8 rounded-xl mb-8">
            <h4 class="text-xl font-bold mb-4 text-white">Daftar Komplain</h4>
            <div id="complaintList" class="space-y-4">
              <!-- Complaints will be loaded here -->
              <p class="text-gray-400 text-center py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Memuat komplain...</p>
            </div>
          </div>
        </section>

        <!-- Settings Section (Removed) -->
        <!-- <section id="settingsSection" class="max-w-6xl mx-auto hidden">
          <h2 class="text-3xl font-bold mb-8 text-[#e94560] flex items-center space-x-3">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
          </h2>
          <div class="card p-8 rounded-xl">
            <h4 class="text-xl font-bold mb-4 text-white">Pengaturan Tampilan Dashboard</h4>
            <form id="settingsForm" onsubmit="handleSettingsSubmit(event)" class="space-y-5">
              <div>
                <label for="brightnessRange" class="block text-sm font-medium mb-2 text-gray-300">Kecerahan Dashboard</label>
                <input type="range" id="brightnessRange" min="50" max="150" value="100" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer" oninput="applySettings(this.value, themeSelect.value)">
                <span class="text-sm text-gray-400 mt-1 block">Nilai: <span id="brightnessValue">100%</span></span>
              </div>
              <div>
                <label for="themeSelect" class="block text-sm font-medium mb-2 text-gray-300">Pilih Tema</label>
                <select id="themeSelect" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:border-red-500 focus:outline-none" onchange="applySettings(brightnessRange.value, this.value)">
                  <option value="dark">Dark Theme</option>
                  <option value="light">Light Theme</option>
                </select>
              </div>
              <button type="submit" class="btn-primary w-full text-white px-6 py-3 rounded-lg font-bold text-lg">
                  <i class="fas fa-save mr-2"></i>Simpan Pengaturan
              </button>
            </form>
          </div>
        </section> -->

      </main>
    </div>
  </section>

  <!-- Footer -->
  <footer class="text-center p-6 mt-auto text-gray-500 border-t-2 border-[#2e2e4a] bg-[#1a1a2e]">
    <p>© 2025 Mizuki Hiroshi Ch. | Admin Dashboard | <a href="https://wa.me/6289634567890" class="text-green-400 underline hover:text-green-300 transition-colors duration-200">Kontak Support</a></p>
  </footer>
</body>
</html>
