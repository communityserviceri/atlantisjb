<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ATLANTIS STORE - Jual Beli Akun Game Terpercaya</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<style>
  :root {
    --primary-color: #0077b6;
    --secondary-color: #023e8a;
    --dark-blue: #002f4b;
    --light-gray: #f5f7fa;
    --white: #ffffff;
    --text-color: #333;
    --border-color: #ddd;
    --shadow-light: rgba(0,0,0,0.08);
    --shadow-medium: rgba(0,0,0,0.15);
    --shopee-orange: #ee4d2d;
    --shopee-orange-dark: #d04326;

    /* New Accent Colors & Gradients */
    --accent-color-1: #00b4d8; /* Bright blue */
    --accent-color-2: #e0f2f7; /* Very light blue for backgrounds */
    --gradient-nav-start: #002f4b;
    --gradient-nav-end: #023e8a;
    --gradient-button-start: #0077b6;
    --gradient-button-end: #023e8a;
  }

  body {
    font-family: 'Poppins', sans-serif;
    margin: 0;
    padding: 0;
    background: var(--light-gray);
    color: var(--text-color);
    line-height: 1.6;
    /* Decorative wave pattern at the bottom */
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%23e0f2f7' fill-opacity='1' d='M0,192L48,192C96,192,192,192,288,181.3C384,171,480,149,576,160C672,171,768,213,864,213.3C960,213,1056,181,1152,170.7C1248,160,1344,171,1392,176L1440,181.3L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: bottom;
    background-size: 100% 250px;
    background-attachment: fixed;
  }

  nav {
    background: linear-gradient(to right, var(--gradient-nav-start), var(--gradient-nav-end));
    color: var(--white);
    padding: 15px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 5px 15px var(--shadow-medium); /* Stronger shadow */
    position: sticky;
    top: 0;
    z-index: 1000;
  }

  nav .logo {
    font-size: 1.9em; /* Slightly larger */
    font-weight: 800; /* Bolder */
    letter-spacing: 1.5px; /* More spacing */
    display: flex;
    align-items: center;
  }

  nav a {
    color: var(--white);
    margin: 0 15px;
    text-decoration: none;
    font-weight: 600;
    transition: color 0.3s ease, transform 0.3s ease; /* Add transform to transition */
  }

  nav a:hover {
    color: var(--accent-color-1); /* Brighter hover color */
    text-decoration: underline;
    transform: translateY(-2px); /* Subtle lift effect */
  }

  .container {
    padding: 40px 20px; /* More padding */
    max-width: 1200px;
    margin: auto;
  }

  h2 {
    color: var(--dark-blue);
    text-align: center;
    margin-bottom: 40px; /* More margin */
    font-size: 2.5em; /* Larger font */
    font-weight: 800; /* Bolder */
    position: relative;
    padding-bottom: 10px;
  }

  h2::after {
    content: '';
    position: absolute;
    left: 50%;
    bottom: 0;
    transform: translateX(-50%);
    width: 80px;
    height: 4px;
    background: var(--primary-color);
    border-radius: 2px;
  }

  form, .info-card {
    background: var(--white);
    padding: 40px; /* More padding */
    border-radius: 15px; /* Larger border-radius */
    box-shadow: 0 8px 25px var(--shadow-light); /* Stronger shadow */
    margin-bottom: 40px; /* More margin */
    max-width: 650px; /* Slightly wider */
    margin-left: auto;
    margin-right: auto;
    position: relative; /* For pseudo-elements */
    overflow: hidden; /* Ensure pseudo-elements don't overflow */
  }

  /* Decorative pseudo-element for forms/cards */
  form::before, .info-card::before {
    content: '';
    position: absolute;
    top: -20px;
    left: -20px;
    width: 80px;
    height: 80px;
    background: var(--accent-color-1);
    border-radius: 20px;
    opacity: 0.05; /* Very subtle */
    z-index: 0;
    transform: rotate(45deg);
  }
  form::after, .info-card::after {
    content: '';
    position: absolute;
    bottom: -20px;
    right: -20px;
    width: 100px;
    height: 100px;
    background: var(--secondary-color);
    border-radius: 30px;
    opacity: 0.03; /* Even more subtle */
    z-index: 0;
    transform: rotate(-30deg);
  }


  input, select, textarea {
    width: calc(100% - 24px); /* Account for padding and border */
    padding: 14px; /* More padding */
    margin: 10px 0 25px 0; /* More margin */
    border: 1px solid var(--border-color);
    border-radius: 10px; /* Larger border-radius */
    font-size: 1.05em; /* Slightly larger font */
    box-sizing: border-box;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    position: relative; /* Ensure they are above pseudo-elements */
    z-index: 1;
  }

  input:focus, select:focus, textarea:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 4px rgba(0, 119, 182, 0.3); /* Stronger focus shadow */
    outline: none;
  }

  button {
    background: linear-gradient(to right, var(--gradient-button-start), var(--gradient-button-end));
    color: var(--white);
    padding: 15px 30px; /* More padding */
    border: none;
    border-radius: 10px; /* Larger border-radius */
    cursor: pointer;
    font-size: 1.15em; /* Slightly larger font */
    font-weight: 700; /* Bolder */
    transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
    width: 100%;
    box-sizing: border-box;
    box-shadow: 0 4px 10px rgba(0, 119, 182, 0.2); /* Initial shadow */
    position: relative;
    z-index: 1;
  }

  button:hover {
    background: linear-gradient(to right, var(--gradient-button-end), var(--gradient-button-start)); /* Reverse gradient on hover */
    transform: translateY(-3px); /* More pronounced lift */
    box-shadow: 0 6px 15px rgba(0, 119, 182, 0.3); /* Stronger shadow on hover */
  }

  button:active {
    transform: translateY(0);
    box-shadow: 0 2px 5px rgba(0, 119, 182, 0.2);
  }

  p {
    text-align: center;
    margin-top: 25px; /* More margin */
    font-size: 1em; /* Slightly larger */
  }

  p a {
    color: var(--primary-color);
    text-decoration: none;
    font-weight: 700; /* Bolder */
    transition: color 0.3s ease, text-decoration 0.3s ease;
  }

  p a:hover {
    color: var(--secondary-color); /* Change color on hover */
    text-decoration: underline;
  }

  .account-card {
    background: var(--white);
    padding: 25px; /* More padding */
    border-radius: 15px; /* Larger border-radius */
    margin-bottom: 25px;
    box-shadow: 0 5px 20px var(--shadow-light); /* Stronger shadow */
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .account-card:hover {
    transform: translateY(-8px); /* More pronounced lift */
    box-shadow: 0 12px 35px var(--shadow-medium); /* Stronger shadow */
  }

  .flex {
    display: flex;
    flex-wrap: wrap;
    gap: 30px;
    justify-content: center;
  }

  .flex .account-card {
    flex: 1 1 calc(33% - 30px);
    max-width: calc(33% - 30px);
    box-sizing: border-box;
  }

  @media (max-width: 992px) {
    .flex .account-card {
      flex: 1 1 calc(50% - 30px);
      max-width: calc(50% - 30px);
    }
  }

  @media (max-width: 768px) {
    nav {
      flex-direction: column;
      padding: 15px 20px;
    }
    nav div:first-child {
      margin-bottom: 15px; /* More margin */
    }
    nav a {
      margin: 0 10px; /* More margin */
      font-size: 0.95em;
    }
    .flex .account-card {
      flex: 1 1 100%;
      max-width: 100%;
    }
    form, .info-card {
      padding: 25px; /* Adjusted padding */
    }
    h2 {
      font-size: 2em; /* Adjusted font size */
    }
  }

  /* Penyesuaian untuk gambar di profil/postinganku (img.account-img) */
  img.account-img {
    max-width: 100%;
    height: 180px; /* Slightly taller */
    object-fit: contain;
    border-radius: 10px; /* Larger border-radius */
    margin-bottom: 20px; /* More margin */
    box-shadow: 0 4px 12px var(--shadow-light); /* Stronger shadow */
  }

  .account-card .image-gallery {
    width: 100%;
    padding-bottom: 65%; /* 4:3 Aspect Ratio */
    position: relative;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 0;
    border-bottom: 1px solid var(--border-color); /* Clean separator */
  }

  .account-card .image-gallery img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: contain; /* Fill the area, crop if necessary */
    object-position: center; /* Center the important content */
    border-radius: 0; /* No border-radius here, handled by parent */
    border: none;
  }

  .account-card h3 {
    color: var(--dark-blue);
    margin-top: 15px; /* More margin */
    margin-bottom: 8px;
    font-size: 1.5em; /* Slightly larger */
    font-weight: 700;
  }

  .account-card p {
    text-align: left;
    width: 100%;
    margin-bottom: 6px;
    font-size: 0.98em; /* Slightly larger */
  }

  .account-card .price {
    font-size: 1.6em; /* Larger price font */
    font-weight: 800; /* Bolder */
    color: var(--shopee-orange);
    margin-top: 18px; /* More margin */
    margin-bottom: 12px;
  }

  .account-card .contact-info {
    font-size: 0.95em;
    color: #666;
    margin-top: 12px;
  }

  .account-card .contact-info a {
    color: var(--primary-color);
    text-decoration: none;
    font-weight: 700;
  }

  .account-card .contact-info a:hover {
    text-decoration: underline;
    color: var(--secondary-color);
  }

  .hidden {
    display: none !important;
  }

  .form-section {
    margin-bottom: 30px; /* More margin */
    padding: 20px; /* More padding */
    border: 2px dashed var(--accent-color-1); /* Thicker, more vibrant border */
    border-radius: 10px; /* Larger border-radius */
    background-color: var(--accent-color-2); /* Lighter background */
  }

  .form-section h3 {
    color: var(--secondary-color);
    margin-top: 0;
    margin-bottom: 20px; /* More margin */
    font-size: 1.4em; /* Larger font */
    font-weight: 700;
  }

  .alert {
    padding: 18px; /* More padding */
    margin-bottom: 25px; /* More margin */
    border-radius: 10px; /* Larger border-radius */
    font-weight: 700; /* Bolder */
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .alert-success {
    background-color: #d4edda;
    color: #155724;
    border-color: #c3e6cb;
  }

  .alert-error {
    background-color: #f8d7da;
    color: #721c24;
    border-color: #f5c6cb;
  }

  #image-previews {
    display: flex;
    flex-wrap: wrap;
    gap: 15px; /* More gap */
    margin: 20px auto; /* More margin */
    justify-content: center;
    border: 2px solid var(--border-color); /* Thicker border */
    border-radius: 10px; /* Larger border-radius */
    padding: 15px; /* More padding */
    box-shadow: 0 4px 12px var(--shadow-light); /* Stronger shadow */
  }

  #image-previews img {
    max-width: 110px; /* Slightly larger */
    height: 110px; /* Slightly larger */
    object-fit: contain;
    border-radius: 8px; /* Larger border-radius */
    border: 2px solid #eee; /* Thicker border */
    cursor: pointer;
    transition: transform 0.2s ease, border-color 0.2s ease;
  }
  #image-previews img:hover {
    transform: scale(1.05);
    border-color: var(--primary-color);
  }

  /* PROFESSIONAL PROFILE PAGE STYLES */
  #profile-page {
    max-width: 800px; /* Make profile page wider */
    padding: 50px; /* More padding */
  }

  #profile-page h2 {
    margin-bottom: 30px;
  }

  .profile-header {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border-color);
  }

  .profile-pic-container {
    position: relative;
    width: 180px; /* Larger profile picture */
    height: 180px;
    margin-bottom: 20px;
  }

  #profile-pic-display {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    border: 5px solid var(--primary-color); /* Thicker, vibrant border */
    box-shadow: 0 8px 20px rgba(0,0,0,0.2); /* Stronger shadow */
    transition: transform 0.3s ease;
  }

  #profile-pic-display:hover {
    transform: scale(1.05);
  }

  .profile-pic-upload-btn {
    position: absolute;
    bottom: 0;
    right: 0;
    background-color: var(--accent-color-1);
    color: white;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    transition: background-color 0.3s ease;
  }

  .profile-pic-upload-btn:hover {
    background-color: var(--secondary-color);
  }

  .profile-pic-upload-btn input[type="file"] {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    border: 0;
  }

  .profile-details-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 30px;
  }

  .profile-details-grid .profile-info-item {
    background-color: var(--accent-color-2);
    padding: 15px 20px;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }

  .profile-details-grid .profile-info-item p {
    text-align: left;
    margin: 0;
    font-size: 1.05em;
  }

  .profile-details-grid .profile-info-item strong {
    color: var(--dark-blue);
  }

  .profile-update-section h3 {
    margin-top: 0;
    margin-bottom: 20px;
    color: var(--secondary-color);
    font-size: 1.6em;
  }

  #my-posts-container {
    margin-top: 50px;
    padding-top: 30px;
    border-top: 1px solid var(--border-color);
  }

  #my-posts-container h3 {
    text-align: center;
    color: var(--dark-blue);
    margin-bottom: 30px;
    font-size: 2em;
    position: relative;
    padding-bottom: 10px;
  }

  #my-posts-container h3::after {
    content: '';
    position: absolute;
    left: 50%;
    bottom: 0;
    transform: translateX(-50%);
    width: 60px;
    height: 3px;
    background: var(--primary-color);
    border-radius: 2px;
  }

  .add-item-btn {
    background-color: #28a745;
    color: white;
    padding: 10px 20px; /* More padding */
    border: none;
    border-radius: 8px; /* Larger border-radius */
    cursor: pointer;
    font-size: 0.95em; /* Slightly larger */
    margin-top: 15px; /* More margin */
    display: inline-block;
    width: auto;
    transition: background-color 0.3s ease, transform 0.2s ease;
  }
  .add-item-btn:hover {
    background-color: #218838;
    transform: translateY(-2px);
  }
  .remove-item-btn {
    background-color: #dc3545;
    color: white;
    padding: 7px 12px; /* More padding */
    border: none;
    border-radius: 8px; /* Larger border-radius */
    cursor: pointer;
    font-size: 0.85em; /* Slightly larger */
    margin-left: 12px; /* More margin */
    transition: background-color 0.3s ease, transform 0.2s ease;
  }
  .remove-item-btn:hover {
    background-color: #c82333;
    transform: translateY(-2px);
  }
  .item-group {
    border: 1px solid #e0e0e0; /* Lighter border */
    padding: 15px; /* More padding */
    margin-bottom: 15px; /* More margin */
    border-radius: 8px; /* Larger border-radius */
    background-color: #fcfcfc; /* Lighter background */
    box-shadow: 0 1px 5px rgba(0,0,0,0.05);
  }
  .item-group label {
    display: block;
    margin-bottom: 8px; /* More margin */
    font-weight: 600;
    color: var(--dark-blue);
  }

/* Improved Buy Account UI */
#buy-account-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); /* Adjusted min-width */
  gap: 20px; /* More gap */
  justify-content: center;
  padding: 15px; /* More padding */
}
#buy-account-list .account-card {
  width: auto;
  border: 1px solid #e0e0e0; /* Lighter border */
  border-radius: 12px; /* Larger border-radius */
  overflow: hidden;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1); /* Stronger shadow */
  background: white;
  display: flex;
  flex-direction: column;
  align-items: stretch;
  text-align: left;
  cursor: pointer;
  transition: all 0.3s ease-in-out; /* Slower transition */
  position: relative;
}
#buy-account-list .account-card:hover {
  transform: translateY(-5px); /* More pronounced lift */
  box-shadow: 0 8px 20px rgba(0,0,0,0.2); /* Stronger shadow */
}
#buy-account-list .account-card .image-gallery {
  width: 100%;
  padding-bottom: 65%; /* 4:3 Aspect Ratio */
  position: relative;
  overflow: hidden;
  display: flex;
  justify-content: center;
  align-items: center;
  margin-bottom: 0;
  border-bottom: 1px solid var(--border-color);
}
#buy-account-list .account-card .image-gallery img {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: contain;
  object-position: center;
  border-radius: 0;
  border: none;
}
#buy-account-list .account-card .card-content {
  padding: 15px; /* More padding */
  flex-grow: 1;
  display: flex;
  flex-direction: column;
}
#buy-account-list .account-card h3 {
  margin: 0 0 8px 0; /* More margin */
  font-size: 1.2em; /* Slightly larger */
  color: var(--dark-blue);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-weight: 700;
}
#buy-account-list .account-card p {
  margin: 0 0 6px 0; /* More margin */
  font-size: 0.9em; /* Slightly larger */
  color: #555;
  text-align: left;
  width: auto;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
#buy-account-list .account-card .price {
  font-size: 1.4em; /* Larger price font */
  font-weight: 800; /* Bolder */
  color: var(--shopee-orange);
  margin-top: 10px;
  margin-bottom: 0;
  text-align: left;
}
#buy-account-list .account-card .status-badge {
  position: absolute;
  top: 15px; /* More space from top */
  right: 15px; /* More space from right */
  background-color: var(--primary-color);
  color: white;
  padding: 6px 10px; /* More padding */
  border-radius: 999px; /* Pill shape */
  font-size: 0.8em; /* Slightly larger */
  font-weight: 700;
  z-index: 10;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
#buy-account-list .account-card .status-badge.terjual {
  background-color: #dc3545;
}

/* Filter and Search styles */
.filter-search-section {
  background: var(--white);
  padding: 30px; /* More padding */
  border-radius: 15px; /* Larger border-radius */
  box-shadow: 0 8px 25px var(--shadow-light); /* Stronger shadow */
  margin-bottom: 40px; /* More margin */
  max-width: 100%;
  margin-left: auto;
  margin-right: auto;
}

.filter-search-section .search-bar {
  display: flex;
  gap: 15px; /* More gap */
  margin-bottom: 25px; /* More margin */
}
.filter-search-section .search-bar input {
  flex-grow: 1;
  margin: 0;
  padding: 12px; /* Adjusted padding */
  border-radius: 8px; /* Adjusted border-radius */
}
.filter-search-section .search-bar button {
  width: auto;
  padding: 12px 25px; /* Adjusted padding */
  margin: 0;
  border-radius: 8px; /* Adjusted border-radius */
}

.filter-options {
  display: flex;
  flex-wrap: wrap;
  gap: 20px; /* More gap */
  justify-content: flex-start;
  align-items: flex-end;
}

.filter-group {
  display: flex;
  flex-direction: column;
  min-width: 180px; /* Slightly wider min-width */
}

.filter-group label {
  font-weight: 700; /* Bolder */
  margin-bottom: 8px; /* More margin */
  color: var(--dark-blue);
  font-size: 0.95em; /* Slightly larger */
}

.filter-group select, .filter-group input {
  width: 100%;
  padding: 10px; /* More padding */
  border-radius: 8px; /* Larger border-radius */
  border: 1px solid var(--border-color);
  font-size: 0.95em; /* Slightly larger */
  margin: 0;
}

.filter-group button {
  width: auto;
  padding: 10px 20px; /* More padding */
  margin-top: 15px; /* More margin */
  font-size: 0.95em; /* Slightly larger */
  border-radius: 8px; /* Larger border-radius */
}

/* Modal Styles */
.modal {
  display: none;
  position: fixed;
  z-index: 2000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.7); /* Darker overlay */
  justify-content: center;
  align-items: center;
  padding: 20px;
  opacity: 0;
  transition: opacity 0.4s ease-in-out; /* Slower transition */
}

.modal.show {
  opacity: 1;
}

.modal-content {
  background-color: #fefefe;
  margin: auto;
  padding: 40px; /* More padding */
  border-radius: 18px; /* Much larger border-radius */
  box-shadow: 0 10px 35px rgba(0,0,0,0.4); /* Stronger shadow */
  max-width: 850px; /* Wider modal */
  width: 100%;
  position: relative;
  animation: fadeIn 0.4s ease-out; /* Slower animation */
  max-height: 90vh;
  overflow-y: auto;
  transform: translateY(-30px); /* More pronounced slide-in */
  transition: transform 0.4s ease-out, opacity 0.4s ease-out;
}

.modal.show .modal-content {
  transform: translateY(0);
  opacity: 1;
}

.modal-content h2 {
  text-align: center;
  color: var(--dark-blue);
  margin-bottom: 25px; /* More margin */
  font-size: 2em; /* Larger font */
  font-weight: 800;
}

.modal-close {
  color: #888; /* Slightly darker */
  position: absolute;
  top: 20px; /* More space */
  right: 30px; /* More space */
  font-size: 40px; /* Larger size */
  font-weight: bold;
  cursor: pointer;
  transition: color 0.3s ease, transform 0.2s ease;
}

.modal-close:hover,
.modal-close:focus {
  color: #000;
  text-decoration: none;
  transform: rotate(90deg); /* Spin effect */
}

.modal-image-gallery {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); /* Adjusted min-width for thumbnails */
  gap: 18px; /* More gap */
  margin-top: 25px; /* More margin */
  margin-bottom: 25px;
  border-top: 1px solid #eee;
  padding-top: 25px;
}

.modal-image-gallery img {
  width: 100%;
  height: 100px; /* Adjusted height for thumbnails */
  object-fit: cover;
  border-radius: 10px; /* Larger border-radius */
  border: 3px solid var(--border-color); /* Thicker border */
  cursor: pointer;
  transition: transform 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
  box-shadow: 0 3px 10px rgba(0,0,0,0.15); /* Stronger shadow */
}
.modal-image-gallery img:hover {
  transform: scale(1.08); /* More pronounced zoom */
  border-color: var(--primary-color);
  box-shadow: 0 6px 18px rgba(0,0,0,0.25);
}

.modal-main-image-container {
  text-align: center;
  margin-bottom: 25px; /* More margin */
  max-height: 350px; /* Taller main image */
  overflow: hidden;
  display: flex;
  justify-content: center;
  align-items: center;
}
.modal-main-image {
  max-width: 100%;
  max-height: 100%; /* Ensures entire image is visible */
  object-fit: contain; /* Ensures entire image is visible */
  border-radius: 12px; /* Larger border-radius */
  box-shadow: 0 8px 20px rgba(0,0,0,0.25); /* Stronger shadow */
  cursor: pointer;
  transition: transform 0.3s ease-in-out;
}

.modal-main-image:hover {
  transform: scale(1.03); /* Slight zoom on hover */
}

.modal-detail-section {
  margin-bottom: 20px; /* More margin */
  padding: 20px; /* More padding */
  background-color: var(--accent-color-2); /* Lighter background */
  border-radius: 12px; /* Larger border-radius */
  box-shadow: 0 3px 12px rgba(0,0,0,0.08); /* Stronger shadow */
}
.modal-detail-section h4 {
  color: var(--secondary-color);
  margin-top: 0;
  margin-bottom: 12px; /* More margin */
  font-size: 1.3em; /* Larger font */
  border-bottom: 1px dashed #bbb; /* Slightly darker dashed line */
  padding-bottom: 10px; /* More padding */
  font-weight: 700;
}
.modal-detail-section p {
  text-align: left;
  margin: 10px 0; /* More margin */
  font-size: 1em; /* Slightly larger */
  color: #444;
}
.modal-detail-section strong {
  color: var(--dark-blue);
  font-weight: 700;
}

.modal-price {
  font-size: 2.2em; /* Even larger price font */
  font-weight: 800; /* Bolder */
  color: var(--shopee-orange);
  text-align: center;
  margin: 30px 0; /* More margin */
}

.modal-contact-info {
  text-align: center;
  margin-top: 30px; /* More margin */
  padding-top: 25px; /* More padding */
  border-top: 1px dashed #ddd; /* Slightly darker dashed line */
}
.modal-contact-info a {
  background-color: #28a745;
  color: white;
  padding: 16px 35px; /* Larger button */
  border-radius: 12px; /* Larger border-radius */
  text-decoration: none;
  font-weight: 700;
  display: inline-block;
  margin-top: 18px; /* More margin */
  transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
  box-shadow: 0 4px 10px rgba(40, 167, 69, 0.2);
}
.modal-contact-info a:hover {
  background-color: #218838;
  transform: translateY(-3px);
  box-shadow: 0 6px 15px rgba(40, 167, 69, 0.3);
}

/* Image Viewer Modal */
#imageViewerModal {
  background-color: rgba(0,0,0,0.9); /* Even darker overlay */
}
#imageViewerModal .modal-content {
  background: transparent;
  box-shadow: none;
  padding: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  max-width: 98vw; /* Wider */
  max-height: 98vh; /* Taller */
  transform: none;
  opacity: 1;
}
#imageViewerModal .modal-main-image {
  max-width: 95%;
  max-height: 90vh;
  object-fit: contain; /* Ensures image fits without cropping */
  border-radius: 0;
  box-shadow: none;
  transition: none;
}
#imageViewerModal .modal-main-image:hover {
  transform: none;
}
#imageViewerModal .modal-close {
  color: white;
  text-shadow: 0 0 8px rgba(0,0,0,0.8); /* Stronger shadow */
  top: 25px; /* More space */
  right: 35px; /* More space */
}
#imageViewerModal .nav-arrow {
  position: absolute;
  top: 50%;
  transform: translateY(-50%); /* Memastikan posisi vertikal di tengah */
  background: rgba(0,0,0,0.6); /* Darker background */
  color: white;
  border: none;
  padding: 18px 25px; /* Lebih besar */
  font-size: 3em; /* Lebih besar */
  cursor: pointer;
  border-radius: 50%; /* Bentuk lingkaran */
  user-select: none;
  transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  z-index: 2001; /* Pastikan di atas gambar */
  display: flex; /* Untuk centering ikon */
  align-items: center;
  justify-content: center;
  width: 60px; /* Ukuran tetap */
  height: 60px; /* Ukuran tetap */
}
#imageViewerModal .nav-arrow:hover {
  background: rgba(0,0,0,0.9); /* Even darker on hover */
  transform: translateY(-50%) scale(1.1); /* Slight zoom */
  box-shadow: 0 4px 15px rgba(0,0,0,0.5);
}
#imageViewerModal .nav-arrow.left {
  left: 20px; /* Posisikan di kiri */
}
#imageViewerModal .nav-arrow.right {
  right: 20px; /* Posisikan di kanan */
}

/* PROMO BANNER STYLES */
.promo-banner {
  background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
  color: var(--white);
  padding: 60px 30px;
  border-radius: 15px;
  text-align: center;
  margin-bottom: 40px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  animation: slideIn 0.8s ease-out;
}

.promo-banner h2 {
  color: var(--white);
  font-size: 3em;
  margin-bottom: 15px;
  position: relative;
  padding-bottom: 0;
}

.promo-banner h2::after {
  content: none; /* Hapus underline dari h2 default */
}

.promo-banner p {
  font-size: 1.3em;
  margin-bottom: 30px;
  color: rgba(255,255,255,0.9);
}

.promo-banner button {
  background: var(--shopee-orange);
  color: var(--white);
  padding: 18px 40px;
  border: none;
  border-radius: 10px;
  font-size: 1.2em;
  font-weight: 700;
  cursor: pointer;
  width: auto; /* Override 100% width */
}

.promo-banner button:hover {
  background-color: var(--shopee-orange-dark);
  transform: translateY(-3px);
}

/* CATEGORY CARDS STYLES */
#category-selection {
  margin-bottom: 40px;
}

.category-card {
  background: var(--white);
  padding: 30px;
  border-radius: 15px;
  box-shadow: 0 5px 20px var(--shadow-light);
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  cursor: pointer;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  flex: 1 1 calc(25% - 30px); /* 4 kolom */
  max-width: calc(25% - 30px);
  box-sizing: border-box;
}

.category-card:hover {
  transform: translateY(-8px);
  box-shadow: 0 12px 35px var(--shadow-medium);
}

.category-card img {
  width: 80px;
  height: 80px;
  object-fit: contain;
  margin-bottom: 15px;
  border-radius: 50%;
  border: 3px solid var(--accent-color-1);
}

.category-card h3 {
  color: var(--dark-blue);
  font-size: 1.3em;
  margin: 0;
}

/* CHAT PAGE STYLES */
#chat-page {
  max-width: 800px;
  margin: auto;
  padding: 30px;
  background: var(--white);
  border-radius: 15px;
  box-shadow: 0 8px 25px var(--shadow-light);
}

#chat-messages {
  display: flex;
  flex-direction: column;
  gap: 15px; /* Increased gap for better spacing */
  height: 450px; /* Slightly taller chat window */
  overflow-y: auto;
  border: 1px solid var(--border-color);
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 20px;
  background-color: var(--accent-color-2);
  box-shadow: inset 0 1px 5px rgba(0,0,0,0.05); /* Subtle inner shadow */
}

.chat-message {
  display: flex;
  align-items: flex-start; /* Align items to the top */
  gap: 10px; /* Space between avatar and message bubble */
  padding: 12px 18px; /* Adjusted padding */
  border-radius: 20px; /* More rounded corners */
  max-width: 85%; /* Slightly wider messages */
  word-wrap: break-word;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1); /* Stronger shadow */
  position: relative; /* For the triangle bubble effect */
}

.chat-message.sent {
  background: linear-gradient(to right, var(--primary-color), var(--secondary-color)); /* Gradient for sent messages */
  color: white;
  align-self: flex-end;
  border-bottom-right-radius: 5px; /* Pointy corner */
}

.chat-message.received {
  background-color: var(--white);
  color: var(--text-color);
  align-self: flex-start;
  border: 1px solid var(--border-color);
  border-bottom-left-radius: 5px; /* Pointy corner */
}

.chat-message .avatar {
  width: 40px; /* Larger avatar */
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid var(--accent-color-1); /* Accent border */
  flex-shrink: 0; /* Prevent shrinking */
}

.chat-message.sent .avatar {
  order: 2; /* Move avatar to the right for sent messages */
  border-color: var(--white); /* White border for sent avatar */
}

.chat-message .message-content {
  display: flex;
  flex-direction: column;
  flex-grow: 1;
}

.chat-message .sender-name {
  font-weight: 700; /* Bolder name */
  font-size: 0.9em;
  margin-bottom: 2px;
  color: inherit; /* Inherit color from message bubble */
}

.chat-message.received .sender-name {
  color: var(--dark-blue); /* Darker name for received messages */
}

.chat-message .message-text {
  font-size: 1em;
  margin-bottom: 5px;
}

.chat-message .timestamp {
  font-size: 0.7em; /* Smaller timestamp */
  opacity: 0.8; /* Slightly transparent */
  margin-top: 5px;
}

.chat-message.sent .timestamp {
  color: rgba(255,255,255,0.7);
  text-align: right;
}

.chat-message.received .timestamp {
  color: #666;
  text-align: left;
}

/* Chat input area */
#chat-input {
  width: calc(100% - 24px); /* Account for padding and border */
  padding: 14px;
  margin-bottom: 10px;
  border: 1px solid var(--border-color);
  border-radius: 10px;
  font-size: 1.05em;
  box-sizing: border-box;
  transition: border-color 0.3s ease, box-shadow 0.3s ease;
  resize: vertical; /* Allow vertical resizing */
  min-height: 60px; /* Minimum height */
}

#send-chat-btn {
  padding: 12px 25px; /* Adjusted padding */
  font-size: 1em; /* Adjusted font size */
  border-radius: 8px; /* Adjusted border-radius */
}

/* DROPDOWN NAV STYLES */
.nav-links {
  display: flex;
  align-items: center;
}

.dropdown {
  position: relative;
  display: inline-block;
  margin-left: 15px; /* Sesuaikan margin */
}

.dropbtn {
  background-color: transparent;
  color: white;
  padding: 10px 15px;
  font-size: 1.1em;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  text-decoration: none;
  font-weight: 600;
  transition: color 0.3s ease, transform 0.3s ease;
}

.dropbtn:hover {
  color: var(--accent-color-1);
  transform: translateY(-2px);
}

.dropdown-content {
  display: none;
  position: absolute;
  background-color: var(--dark-blue); /* Warna latar belakang dropdown */
  min-width: 160px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
  z-index: 1;
  border-radius: 8px;
  overflow: hidden;
  right: 0; /* Posisikan di kanan */
  top: 100%; /* Tepat di bawah tombol */
  opacity: 0;
  transform: translateY(10px);
  transition: opacity 0.3s ease, transform 0.3s ease;
}

.dropdown-content a {
  color: var(--white);
  padding: 12px 16px;
  text-decoration: none;
  display: block;
  text-align: left;
  transition: background-color 0.3s ease, color 0.3s ease;
  margin: 0; /* Hapus margin default dari nav a */
}

.dropdown-content a:hover {
  background-color: var(--primary-color); /* Warna hover untuk item dropdown */
  color: var(--white);
  text-decoration: none;
  transform: none; /* Hapus transform dari nav a */
}

.dropdown:hover .dropdown-content {
  display: block;
  opacity: 1;
  transform: translateY(0);
}


@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.9); } /* Start smaller */
  to { opacity: 1; transform: scale(1); }
}

@media (max-width: 768px) {
  .filter-options {
    flex-direction: column;
    align-items: stretch;
  }
  .filter-group {
    min-width: unset;
    width: 100%;
  }
  .filter-group button {
    width: 100%;
  }
  .modal-content {
    padding: 25px;
  }
  .modal-close {
    font-size: 35px;
    top: 15px;
    right: 20px;
  }
  .modal-image-gallery {
    grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)); /* Adjust for smaller screens */
    gap: 10px;
  }
  .modal-image-gallery img {
    height: 70px;
  }
  /* PERBAIKAN UTAMA UNTUK UKURAN GAMBAR DI HP */
  #buy-account-list {
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); /* JAUH LEBIH KECIL UNTUK HP */
    gap: 15px; /* Kurangi gap juga */
  }
  #buy-account-list .account-card .image-gallery {
    padding-bottom: 75%; /* Ubah ke rasio 4:3 untuk kartu yang lebih ringkas di HP */
  }
  #buy-account-list .account-card h3 {
    font-size: 1em; /* Kecilkan judul */
  }
  #buy-account-list .account-card p {
    font-size: 0.8em; /* Kecilkan teks */
  }
  #buy-account-list .account-card .price {
    font-size: 1.1em; /* Kecilkan harga */
  }
  #buy-account-list .account-card .status-badge {
    font-size: 0.7em; /* Kecilkan badge */
    padding: 4px 6px;
    top: 8px;
    right: 8px;
  }

  .modal-main-image-container {
    max-height: 250px; /* Lebih kecil lagi untuk HP */
  }
  .modal-main-image {
    max-height: 100%; /* Menggunakan 100% dari max-height container */
  }

  #imageViewerModal .nav-arrow {
    padding: 12px 15px;
    font-size: 2.5em;
    width: 50px;
    height: 50px;
    /* Hapus properti left dan right dari sini */
  }
  #imageViewerModal .nav-arrow.left {
    left: 10px; /* Posisikan di kiri */
    right: auto; /* Pastikan tidak ada konflik dengan right */
  }
  #imageViewerModal .nav-arrow.right {
    right: 10px; /* Posisikan di kanan */
    left: auto; /* Pastikan tidak ada konflik dengan left */
  }

  /* Responsive adjustments for profile page */
  #profile-page {
    padding: 25px;
  }
  .profile-details-grid {
    grid-template-columns: 1fr; /* Single column on mobile */
  }
  .profile-pic-container {
    width: 120px;
    height: 120px;
  }
  .profile-pic-upload-btn {
    width: 30px;
    height: 30px;
    font-size: 0.8em;
  }

  /* Responsive for category cards */
  .category-card {
    flex: 1 1 100%; /* 1 kolom di mobile */
    max-width: 100%;
  }

  /* Responsive for dropdown nav */
  .nav-links {
    flex-direction: column;
    width: 100%;
    align-items: center;
  }
  .nav-links a, .dropdown {
    margin: 10px 0;
  }
  .dropdown-content {
    position: static; /* Agar dropdown muncul di bawah item menu di mobile */
    width: 100%;
    box-shadow: none;
    border-radius: 0;
    background-color: var(--secondary-color); /* Sesuaikan warna di mobile */
  }

  /* Responsive for chat page */
  #chat-page {
    padding: 20px;
  }
  .chat-message {
    max-width: 95%; /* Adjust max-width for smaller screens */
    padding: 10px 15px;
  }
  .chat-message .avatar {
    width: 35px;
    height: 35px;
  }
  .chat-message .sender-name {
    font-size: 0.85em;
  }
  .chat-message .message-text {
    font-size: 0.9em;
  }
  .chat-message .timestamp {
    font-size: 0.65em;
  }
  #chat-input {
    padding: 10px;
    min-height: 50px;
  }
  #send-chat-btn {
    padding: 10px 20px;
    font-size: 0.9em;
  }
}

/* New styles for chat community */
.chat-tabs {
  display: flex;
  justify-content: center;
  margin-bottom: 20px;
  border-bottom: 1px solid var(--border-color);
}

.chat-tab-button {
  background-color: transparent;
  border: none;
  padding: 10px 20px;
  cursor: pointer;
  font-size: 1.1em;
  font-weight: 600;
  color: #666;
  transition: color 0.3s ease, border-bottom 0.3s ease;
  border-bottom: 3px solid transparent;
}

.chat-tab-button.active {
  color: var(--primary-color);
  border-bottom: 3px solid var(--primary-color);
}

.chat-tab-button:hover {
  color: var(--dark-blue);
}

#private-chat-selection {
  margin-bottom: 20px;
  display: flex;
  gap: 10px;
  align-items: center;
  padding: 15px;
  border: 1px solid var(--border-color);
  border-radius: 10px;
  background-color: var(--accent-color-2);
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

#private-chat-selection label {
  font-weight: 600;
  color: var(--dark-blue);
  white-space: nowrap;
}

#private-chat-selection select {
  flex-grow: 1;
  margin: 0;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid var(--border-color);
  font-size: 0.95em;
  background-color: var(--white);
}

#private-chat-selection button {
  width: auto;
  padding: 10px 15px;
  margin: 0;
  font-size: 0.95em;
  border-radius: 8px;
}

</style>
</head>
<body>

<nav>
  <div class="logo">
    <a href="#" id="nav-home" style="color: inherit; text-decoration: none;">
      <!-- SVG Icon for professional touch -->
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 8px; color: var(--accent-color-1);">
        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
      </svg>
      ATLANTIS STORE
    </a>
  </div>
  <div class="nav-links">
    <a href="#" id="nav-post">Posting Akun</a>
    <a href="#" id="nav-buy">Beli Akun</a>
    <a href="https://wa.me/6288223070064" target="_blank" id="nav-chat-admin">Chat Admin (WA)</a>
    <a href="#" id="nav-chat-community">Chat Komunitas</a>
    
    <!-- Dropdown untuk Profile/Logout -->
    <div class="dropdown">
      <a href="#" class="dropbtn" id="nav-user-menu">
        <img id="nav-profile-pic-small" src="https://via.placeholder.com/30" alt="Profile" style="width: 30px; height: 30px; border-radius: 50%; vertical-align: middle; margin-right: 5px; border: 2px solid var(--accent-color-1);">
        <span id="nav-username">User</span> &#9662;
      </a>
      <div class="dropdown-content">
        <a href="#" id="nav-profile-dropdown">Profil Saya</a>
        <a href="#" id="nav-logout-dropdown">Logout</a>
      </div>
    </div>
  </div>
</nav>

<div class="container" id="main-container">

  <!-- LOGIN FORM -->
  <form id="login-form">
    <h2>Login ke ATLANTIS STORE</h2>
    <div id="login-alert" class="alert hidden"></div>
    <input type="email" id="login-email" placeholder="Email (contoh: user@atlantis.store.com)" required>
    <input type="password" id="login-password" placeholder="Password" required>
    <button type="submit">Login</button>
    <p>Belum punya akun? <a href="#" id="show-register">Daftar Sekarang</a></p>
  </form>

  <!-- REGISTER FORM -->
  <form id="register-form" class="hidden">
    <h2>Daftar Akun Baru</h2>
    <div id="register-alert" class="alert hidden"></div>
    <input type="text" id="reg-name" placeholder="Nama Lengkap" required>
    <input type="date" id="reg-dob" placeholder="Tanggal Lahir" required>
    <input type="email" id="reg-email" placeholder="Email (contoh: user@atlantis.store.com)" required>
    <div style="display: flex; align-items: center; margin: 10px 0 25px 0;">
      <select id="reg-whatsapp-country-code" style="width: auto; padding: 14px; margin: 0 5px 0 0; border-radius: 10px;">
        <option value="+62">🇮🇩 +62</option>
        <option value="+1">🇺🇸 +1</option>
        <option value="+44">🇬🇧 +44</option>
        <option value="+60">🇲🇾 +60</option>
        <option value="+65">🇸🇬 +65</option>
        <!-- Add more country codes as needed -->
      </select>
      <input type="text" id="reg-whatsapp" placeholder="Nomor WhatsApp (contoh: 81234567890)" required style="flex-grow: 1; margin: 0;">
    </div>
    <input type="password" id="reg-password" placeholder="Password (min. 6 karakter)" required>
    <input type="password" id="reg-confirm-password" placeholder="Konfirmasi Password" required>
    <button type="submit">Daftar</button>
    <p>Sudah punya akun? <a href="#" id="show-login">Login</a></p>
  </form>

  <!-- LANDING PAGE (Promo Banner) -->
  <div id="landing-page" class="hidden">
    <div class="promo-banner">
      <h2>Selamat Datang di ATLANTIS STORE!</h2>
      <p>Jual Beli Akun Game Terpercaya dengan Harga Terbaik.</p>
      <button onclick="document.getElementById('nav-buy').click()">Lihat Akun Tersedia</button>
    </div>
  </div>

  <!-- PROFILE PAGE -->
  <form id="profile-page" class="hidden">
    <h2>Profil Pengguna</h2>
    <div id="profile-alert" class="alert hidden"></div>

    <div class="profile-header">
      <div class="profile-pic-container">
        <img id="profile-pic-display" src="https://via.placeholder.com/180" alt="Foto Profil">
        <label for="profile-pic-upload" class="profile-pic-upload-btn">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-camera"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
          <input type="file" id="profile-pic-upload" accept="image/*">
        </label>
      </div>
      <h3 id="profile-name-display-header">Nama Pengguna</h3>
    </div>

    <div class="profile-details-grid">
      <div class="profile-info-item">
        <p><strong>Email:</strong> <span id="profile-email-display"></span></p>
      </div>
      <div class="profile-info-item">
        <p><strong>WhatsApp:</strong> <span id="profile-whatsapp-display-info"></span></p>
      </div>
      <div class="profile-info-item">
        <p><strong>Umur:</strong> <span id="profile-age-display"></span> tahun</p>
      </div>
      <div class="profile-info-item">
        <p><strong>Bergabung Sejak:</strong> <span id="profile-joined-date"></span></p>
      </div>
    </div>

    <div class="profile-update-section">
      <h3>Update Profil</h3>
      <input type="text" id="profile-name" placeholder="Nama Lengkap" required>
      <div style="display: flex; align-items: center; margin: 10px 0 25px 0;">
        <select id="profile-whatsapp-country-code" style="width: auto; padding: 14px; margin: 0 5px 0 0; border-radius: 10px;">
          <option value="+62">🇮🇩 +62</option>
          <option value="+1">🇺🇸 +1</option>
          <option value="+44">🇬🇧 +44</option>
          <option value="+60">🇲🇾 +60</option>
          <option value="+65">🇸🇬 +65</option>
          <!-- Add more country codes as needed -->
        </select>
        <input type="text" id="profile-whatsapp" placeholder="Nomor WhatsApp (contoh: 81234567890)" required style="flex-grow: 1; margin: 0;">
      </div>
      <input type="password" id="profile-password" placeholder="Ganti Password (kosongkan jika tidak ingin ganti)">
      <input type="password" id="profile-confirm-password" placeholder="Konfirmasi Password Baru">
      <button type="submit">Update Profil</button>
    </div>

    <div id="my-posts-container">
      <h3>Postingan Saya</h3>
      <div class="flex" id="my-posts-list">
        <!-- User's posted accounts will be loaded here -->
      </div>
    </div>
  </form>

  <!-- POSTING AKUN PAGE -->
  <form id="post-account-page" class="hidden">
    <h2>Posting Akun Game Anda</h2>
    <div id="post-alert" class="alert hidden"></div>

    <div class="form-section">
      <h3>Informasi Umum Akun</h3>
      <select id="game-category" required onchange="showGameFields()">
        <option value="">Pilih Kategori Game</option>
        <option value="ml">Mobile Legend</option>
        <option value="toram">Toram Online</option>
        <option value="lifeafter">Life After</option>
      </select>
      <input type="number" id="price" placeholder="Harga Akun (IDR)" required min="10000">
      <select id="status">
        <option value="belum">Belum Terjual</option>
        <option value="terjual">Terjual</option>
      </select>
      <label for="account-images">Upload Gambar Akun (Max 12 Gambar)</label>
      <input type="file" id="account-images" accept="image/*" multiple>
      <div id="image-previews" class="hidden"></div>
    </div>
    
    <!-- ML FIELDS -->
    <div id="ml-fields" class="form-section hidden">
      <h3>Detail Mobile Legend</h3>
      <select id="ml-rank-now">
        <option value="">Rank Saat Ini</option>
        <option value="Warrior">Warrior</option>
        <option value="Elite">Elite</option>
        <option value="Master">Master</option>
        <option value="Grand Master">Grand Master</option>
        <option value="Epic">Epic</option>
        <option value="Legend">Legend</option>
        <option value="Mythic">Mythic</option>
        <option value="Mythic Honor">Mythic Honor</option>
        <option value="Mythic Glory">Mythic Glory</option>
        <option value="Mythic Immortal">Mythic Immortal</option>
      </select>
      <select id="ml-rank-highest">
        <option value="">Rank Tertinggi</option>
        <option value="Warrior">Warrior</option>
        <option value="Elite">Elite</option>
        <option value="Master">Master</option>
        <option value="Grand Master">Grand Master</option>
        <option value="Epic">Epic</option>
        <option value="Legend">Legend</option>
        <option value="Mythic">Mythic</option>
        <option value="Mythic Honor">Mythic Honor</option>
        <option value="Mythic Glory">Mythic Glory</option>
        <option value="Mythic Immortal">Mythic Immortal</option>
      </select>
      <input type="number" id="ml-win-all-matches" placeholder="Win Rate All Season (Jumlah Pertandingan)" min="0">
      <input type="number" id="ml-win-all-percent" placeholder="Win Rate All Season (%)" min="0" max="100">
      <input type="number" id="ml-win-season-matches" placeholder="Win Rate Season Ini (Jumlah Pertandingan)" min="0">
      <input type="number" id="ml-win-season-percent" placeholder="Win Rate Season Ini (%)" min="0" max="100">
      <select id="ml-role">
        <option value="">Kategori Role</option>
        <option value="Gold Lane">Gold Lane</option>
        <option value="Exp Lane">Exp Lane</option>
        <option value="Jungler">Jungler</option>
        <option value="Mid Lane">Mid Lane</option>
        <option value="Roamer">Roamer</option>
      </select>
      <div id="ml-heroes-container">
        <label>Hero Favorit (Minimal 1, Maksimal 3)</label>
        <div class="item-group">
          <input type="text" class="ml-hero-name" placeholder="Nama Hero">
          <input type="number" class="ml-hero-wr" placeholder="Win Rate Hero (%)" min="0" max="100">
          <button type="button" class="remove-item-btn" onclick="this.parentElement.remove()">Hapus</button>
        </div>
      </div>
      <button type="button" class="add-item-btn" onclick="addMlHeroField()">Tambah Hero</button>
      <select id="ml-emblem">
        <option value="">Emblem Maximal (Level)</option>
        <option value="1">1</option><option value="2">2</option><option value="3">3</option>
        <option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option>
      </select>
      <input type="number" id="ml-skins" placeholder="Total Skin" min="0">
    </div>

    <!-- Toram FIELDS -->
    <div id="toram-fields" class="form-section hidden">
      <h3>Detail Toram Online</h3>
      <input type="text" id="toram-mainquest" placeholder="Main Quest (contoh: BAB 1 - 16 (tamat))">
      <div id="toram-characters-container">
        <label>Slot Character</label>
        <div class="item-group">
          <input type="number" class="toram-char-level" placeholder="Level Character" min="1">
          <input type="text" class="toram-char-job" placeholder="Deskripsi Job Character (contoh: Tank)">
          <button type="button" class="remove-item-btn" onclick="this.parentElement.remove()">Hapus</button>
        </div>
      </div>
      <button type="button" class="add-item-btn" onclick="addToramCharacterField()">Tambah Character</button>
      <div id="toram-equip-container">
        <label>Equip Untrade</label>
        <div class="item-group">
          <input type="text" class="toram-equip-desc" placeholder="Deskripsi Item Equip (contoh: Pedang A)">
          <button type="button" class="remove-item-btn" onclick="this.parentElement.remove()">Hapus</button>
        </div>
      </div>
      <button type="button" class="add-item-btn" onclick="addToramEquipField()">Tambah Equip</button>
      <div id="toram-gudang-container">
        <label>Gudang</label>
        <div class="item-group">
          <input type="text" class="toram-gudang-name" placeholder="Nama Gudang (contoh: A)">
          <input type="number" class="toram-gudang-slot" placeholder="Jumlah Slot" min="0">
          <button type="button" class="remove-item-btn" onclick="this.parentElement.remove()">Hapus</button>
        </div>
      </div>
      <button type="button" class="add-item-btn" onclick="addToramGudangField()">Tambah Gudang</button>
      <input type="number" id="toram-orb" placeholder="Total ORB" min="0">
      <input type="number" id="toram-tiket" placeholder="Total Tiket" min="0">
    </div>

    <!-- LifeAfter FIELDS -->
    <div id="lifeafter-fields" class="form-section hidden">
      <h3>Detail Life After</h3>
      <select id="lifeafter-server" onchange="showLifeAfterServer()">
        <option value="">Pilih Server</option>
        <option value="easy">EasyServer</option>
        <option value="sea">SEA Server</option>
        <option value="na">NA Server</option>
      </select>
      <div id="sea-server-fields" class="hidden">
        <select id="sea-server-dropdown">
          <option value="">Pilih Kota SEA Server</option>
          <option>Nancy</option><option>CharlesTown</option><option>SnowHighland</option>
          <option>Santopany</option><option>LevinCity</option><option>Milestone</option>
          <option>ChaosCity</option><option>Hopewall</option><option>Twinisland</option>
          <option>LabyrintSea</option>
        </select>
      </div>
      <div id="na-server-fields" class="hidden">
        <select id="na-server-dropdown">
          <option value="">Pilih Kota NA Server</option>
          <option>MiskaTown</option><option>Sandcastle</option><option>Mouthswamp</option>
          <option>RedwoodTown</option><option>Obelisk</option><option>NewLand</option>
          <option>Chaos Outpost</option><option>IronStride</option><option>CrystalThornSea</option>
        </select>
      </div>
      <input type="number" id="la-manor" placeholder="Level Manor (1-29)" min="1" max="29">
      
      <label for="la-level-gether">Level Gether</label>
      <input type="number" id="la-level-gether" placeholder="Level Gether" min="1">
      <label for="la-level-craft">Level Craft</label>
      <input type="number" id="la-level-craft" placeholder="Level Craft" min="1">
      <label for="la-level-combat">Level Combat</label>
      <input type="number" id="la-level-combat" placeholder="Level Combat" min="1">

      <h4>Level Attachment</h4>
      <!-- Light Weapon -->
      <div class="form-section">
        <h5>Light Weapon Attachment</h5>
        <div class="item-group">
          <label>Stock</label>
          <input type="number" class="la-lw-stock-level" placeholder="Level (1-19)" min="1" max="19">
          <input type="number" class="la-lw-stock-grade" placeholder="Grade (1-12)" min="1" max="12">
          <select class="la-lw-stock-color">
            <option value="">Pilih Warna</option>
            <option value="Green">Green</option>
            <option value="Blue">Blue</option>
            <option value="Purple">Purple</option>
          </select>
        </div>
        <div class="item-group">
          <label>Sight</label>
          <input type="number" class="la-lw-sight-level" placeholder="Level (1-19)" min="1" max="19">
          <input type="number" class="la-lw-sight-grade" placeholder="Grade (1-12)" min="1" max="12">
          <select class="la-lw-sight-color">
            <option value="">Pilih Warna</option>
            <option value="Green">Green</option>
            <option value="Blue">Blue</option>
            <option value="Purple">Purple</option>
          </select>
        </div>
        <div class="item-group">
          <label>Muzzle</label>
          <input type="number" class="la-lw-muzzle-level" placeholder="Level (1-19)" min="1" max="19">
          <input type="number" class="la-lw-muzzle-grade" placeholder="Grade (1-12)" min="1" max="12">
          <select class="la-lw-muzzle-color">
            <option value="">Pilih Warna</
            <option value="Green">Green</option>
            <option value="Blue">Blue</option>
            <option value="Purple">Purple</option>
          </select>
        </div>
      </div>

      <!-- Heavy Weapon -->
      <div class="form-section">
        <h5>Heavy Weapon Attachment</h5>
        <div class="item-group">
          <label>Stock</label>
          <input type="number" class="la-hw-stock-level" placeholder="Level (1-19)" min="1" max="19">
          <input type="number" class="la-hw-stock-grade" placeholder="Grade (1-12)" min="1" max="12">
          <select class="la-hw-stock-color">
            <option value="">Pilih Warna</option>
            <option value="Green">Green</option>
            <option value="Blue">Blue</option>
            <option value="Purple">Purple</option>
          </select>
        </div>
        <div class="item-group">
          <label>Sight</label>
          <input type="number" class="la-hw-sight-level" placeholder="Level (1-19)" min="1" max="19">
          <input type="number" class="la-hw-sight-grade" placeholder="Grade (1-12)" min="1" max="12">
          <select class="la-hw-sight-color">
            <option value="">Pilih Warna</option>
            <option value="Green">Green</option>
            <option value="Blue">Blue</option>
            <option value="Purple">Purple</option>
          </select>
        </div>
        <div class="item-group">
          <label>Muzzle</label>
          <input type="number" class="la-hw-muzzle-level" placeholder="Level (1-19)" min="1" max="19">
          <input type="number" class="la-hw-muzzle-grade" placeholder="Grade (1-12)" min="1" max="12">
          <select class="la-hw-muzzle-color">
            <option value="">Pilih Warna</
            <option value="Green">Green</option>
            <option value="Blue">Blue</option>
            <option value="Purple">Purple</option>
          </select>
        </div>
      </div>

      <!-- Meele Weapon -->
      <div class="form-section">
        <h5>Meele Weapon Attachment</h5>
        <div class="item-group">
          <label>Knob</label>
          <input type="number" class="la-mw-knob-level" placeholder="Level (1-19)" min="1" max="19">
          <input type="number" class="la-mw-knob-grade" placeholder="Grade (1-12)" min="1" max="12">
          <select class="la-mw-knob-color">
            <option value="">Pilih Warna</option>
            <option value="Green">Green</option>
            <option value="Blue">Blue</option>
            <option value="Purple">Purple</option>
          </select>
        </div>
        <div class="item-group">
          <label>Hanging Tasle</label>
          <input type="number" class="la-mw-tasle-level" placeholder="Level (1-19)" min="1" max="19">
          <input type="number" class="la-mw-tasle-grade" placeholder="Grade (1-12)" min="1" max="12">
          <select class="la-mw-tasle-color">
            <option value="">Pilih Warna</option>
            <option value="Green">Green</option>
            <option value="Blue">Blue</option>
            <option value="Purple">Purple</option>
          </select>
        </div>
        <div class="item-group">
          <label>Sculpture</label>
          <input type="number" class="la-mw-sculpture-level" placeholder="Level (1-19)" min="1" max="19">
          <input type="number" class="la-mw-sculpture-grade" placeholder="Grade (1-12)" min="1" max="12">
          <select class="la-mw-sculpture-color">
            <option value="">Pilih Warna</option>
            <option value="Green">Green</option>
            <option value="Blue">Blue</option>
            <option value="Purple">Purple</option>
          </select>
        </div>
      </div>

      <!-- Armor -->
      <div class="form-section">
        <h5>Armor Attachment</h5>
        <div class="item-group">
          <label>Steel Layer</label>
          <input type="number" class="la-armor-steel-level" placeholder="Level (1-19)" min="1" max="19">
          <input type="number" class="la-armor-steel-grade" placeholder="Grade (1-12)" min="1" max="12">
          <select class="la-armor-steel-color">
            <option value="">Pilih Warna</option>
            <option value="Green">Green</option>
            <option value="Blue">Blue</option>
            <option value="Purple">Purple</option>
          </select>
        </div>
        <div class="item-group">
          <label>Chain Layer</label>
          <input type="number" class="la-armor-chain-level" placeholder="Level (1-19)" min="1" max="19">
          <input type="number" class="la-armor-chain-grade" placeholder="Grade (1-12)" min="1" max="12">
          <select class="la-armor-chain-color">
            <option value="">Pilih Warna</option>
            <option value="Green">Green</option>
            <option value="Blue">Blue</option>
            <option value="Purple">Purple</option>
          </select>
        </div>
        <div class="item-group">
          <label>Cotton Layer</label>
          <input type="number" class="la-armor-cotton-level" placeholder="Level (1-19)" min="1" max="19">
          <input type="number" class="la-armor-cotton-grade" placeholder="Grade (1-12)" min="1" max="12">
          <select class="la-armor-cotton-color">
            <option value="">Pilih Warna</option>
            <option value="Green">Green</option>
            <option value="Blue">Blue</option>
            <option value="Purple">Purple</option>
          </select>
        </div>
      </div>

      <label for="la-job-category">Kategori Job</label>
      <select id="la-job-category" onchange="showLifeAfterJob()">
        <option value="">Pilih Kategori Job</option>
        <option value="Combat">Combat</option>
        <option value="Gether">Gether</option>
        <option value="Craft">Craft</option>
      </select>
      <select id="la-job-detail" class="hidden">
        <option value="">Pilih Job</option>
      </select>

      <input type="number" id="la-gene" placeholder="Gene" min="0">
      <input type="number" id="la-charisma" placeholder="Score Charisma" min="0">
      <label>Total Outfit</label>
      <input type="number" id="la-outfit-collector" placeholder="Collector" min="0">
      <input type="number" id="la-outfit-gacha" placeholder="Gacha" min="0">
      <input type="number" id="la-outfit-mall" placeholder="Mall" min="0">
      <input type="number" id="la-outfit-common" placeholder="Common" min="0">
    </div>

    <button type="submit" id="post-submit-btn">Post Akun</button>
  </form>

  <!-- BELI AKUN PAGE -->
  <div id="buy-account-page" class="hidden">
    <h2>Beli Akun Game</h2>

    <div id="category-selection" class="flex">
      <div class="category-card" data-category="ml">
        <img id="icon-mobile-legend" src="" alt="Mobile Legend Icon">
        <h3>Mobile Legend</h3>
      </div>
      <div class="category-card" data-category="toram">
        <img id="icon-toram-online" src="" alt="Toram Online Icon">
        <h3>Toram Online</h3>
      </div>
      <div class="category-card" data-category="lifeafter">
        <img id="icon-life-after" src="" alt="Life After Icon">
        <h3>Life After</h3>
      </div>
      <div class="category-card" data-category="all">
        <img id="icon-all-games" src="" alt="All Games Icon">
        <h3>Semua Game</h3>
      </div>
    </div>

    <div id="account-listing-section" class="hidden">
      <button id="back-to-categories" class="add-item-btn" style="margin-bottom: 20px;">&larr; Kembali ke Kategori</button>
      <div class="filter-search-section">
        <div class="search-bar">
          <input type="text" id="search-input" placeholder="Cari akun (nama game, rank, server, dll.)">
          <button type="button" onclick="applyFilters()">Cari</button>
        </div>

        <div class="filter-options">
          <div class="filter-group">
            <label for="filter-category">Kategori Game:</label>
            <select id="filter-category" onchange="toggleGameFilters()">
              <option value="all">Semua Kategori</option>
              <option value="ml">Mobile Legend</option>
              <option value="toram">Toram Online</option>
              <option value="lifeafter">Life After</option>
            </select>
          </div>

          <!-- ML Filters -->
          <div id="ml-filters" class="filter-group hidden">
            <label for="filter-ml-role">Role Akun ML:</label>
            <select id="filter-ml-role">
              <option value="all">Semua Role</option>
              <option value="Gold Lane">Gold Lane</option>
              <option value="Exp Lane">Exp Lane</option>
              <option value="Jungler">Jungler</option>
              <option value="Mid Lane">Mid Lane</option>
              <option value="Roamer">Roamer</option>
            </select>
          </div>

          <!-- Toram Filters -->
          <div id="toram-filters" class="filter-group hidden">
            <label for="filter-toram-char-count">Jumlah Char Toram (Min):</label>
            <input type="number" id="filter-toram-char-count" placeholder="Min Jumlah Char" min="0">
            <label for="filter-toram-char-level">Level Char Toram (Min):</label>
            <input type="number" id="filter-toram-char-level" placeholder="Min Level Char" min="0">
            <label for="filter-toram-mq">Main Quest Toram:</label>
            <input type="text" id="filter-toram-mq" placeholder="Contoh: BAB 16">
          </div>

          <!-- LifeAfter Filters -->
          <div id="lifeafter-filters" class="filter-group hidden">
            <label for="filter-la-server">Server LA:</label>
            <select id="filter-la-server">
              <option value="all">Semua Server</option>
              <option value="easy">EasyServer</option>
              <option value="sea">SEA Server</option>
              <option value="na">NA Server</option>
            </select>
            <label for="filter-la-manor">Manor Level LA (Min):</label>
            <input type="number" id="filter-la-manor" placeholder="Min Manor Level" min="1" max="29">
          </div>

          <div class="filter-group">
            <label for="sort-by">Urutkan:</label>
            <select id="sort-by" onchange="applyFilters()">
              <option value="newest">Terbaru</option>
              <option value="price-asc">Harga Terendah</option>
              <option value="price-desc">Harga Tertinggi</option>
            </select>
          </div>

          <div class="filter-group">
            <button type="button" onclick="applyFilters()">Terapkan Filter</button>
            <button type="button" onclick="resetFilters()" style="background-color: #6c757d;">Reset Filter</button>
          </div>
        </div>
      </div>

      <div id="buy-account-list">
        <!-- Account cards for buying will be loaded here -->
      </div>
    </div>
  </div>

  <!-- CHAT PAGE -->
  <div id="chat-page" class="hidden">
    <h2>Chat Komunitas</h2>
    <div class="chat-tabs">
      <button class="chat-tab-button active" data-chat-category="global">Global Chat</button>
      <button class="chat-tab-button" data-chat-category="public">Public Chat</button>
      <button class="chat-tab-button" data-chat-category="private">Private Chat</button>
    </div>

    <div id="private-chat-selection" class="hidden">
      <label for="private-chat-user">Chat dengan:</label>
      <select id="private-chat-user">
        <option value="">Pilih Pengguna</option>
        <!-- Users will be loaded here -->
      </select>
      <button id="start-private-chat-btn">Mulai Chat</button>
    </div>

    <div id="chat-messages">
      <!-- Messages will be loaded here -->
    </div>
    <div id="chat-alert" class="alert hidden"></div>
    <textarea id="chat-input" placeholder="Ketik pesan Anda..." rows="4"></textarea>
    <button id="send-chat-btn">Kirim Pesan</button>
  </div>

</div>

<!-- Account Detail Modal -->
<div id="accountDetailModal" class="modal">
  <div class="modal-content">
    <span class="modal-close" id="closeAccountDetailModal">&times;</span>
    <h2 id="modal-account-title"></h2>
    <div class="modal-main-image-container">
      <img id="modal-main-image" src="" alt="Main Account Image">
    </div>
    <div class="modal-image-gallery" id="modal-thumbnail-gallery">
      <!-- Thumbnails will be loaded here -->
    </div>
    <div id="modal-account-details">
      <!-- Account specific details will be loaded here -->
    </div>
    <p class="modal-price" id="modal-account-price"></p>
    <div class="modal-contact-info">
      <p><strong>Owner:</strong> <span id="modal-owner-name"></span></p>
      <a href="#" id="modal-owner-whatsapp" target="_blank">Hubungi Penjual (WhatsApp)</a>
      <p style="font-size: 0.8em; color: #888; margin-top: 10px;">Untuk transaksi aman, gunakan rekber admin: <a href="https://wa.me/6288223070064" target="_blank">+6288223070064</a></p>
    </div>
  </div>
</div>

<!-- Image Viewer Modal (for full screen image) -->
<div id="imageViewerModal" class="modal">
  <div class="modal-content">
    <span class="modal-close" id="closeImageViewerModal">&times;</span>
    <img id="viewerImage" src="" alt="Full Screen Image" class="modal-main-image">
    <button class="nav-arrow left" id="prevImage">&lt;</button>
    <button class="nav-arrow right" id="nextImage">&gt;</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBdKELW2FNsL7H1zB8R765czcDPaSYybdg", // Pastikan ini adalah API Key yang benar dari Firebase Console Anda
  authDomain: "atlantis-store.firebaseapp.com",
  databaseURL: "https://atlantis-store-default-rtdb.firebaseio.com",
  projectId: "atlantis-store",
  storageBucket: "atlantis-store.appspot.com",
  messagingSenderId: "566295949160",
  appId: "1:566295949160:web:3ad8956c753d2f05a5f0dd",
  measurementId: "G-F5RG09TFCK"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
let editPostId = null;
let currentEditData = null;
const db = firebase.database();
const storage = firebase.storage();

// DOM Elements
const loginForm = document.getElementById('login-form');
const registerForm = document.getElementById('register-form');
const landingPage = document.getElementById('landing-page');
const profilePage = document.getElementById('profile-page');
const postAccountPage = document.getElementById('post-account-page');
const buyAccountPage = document.getElementById('buy-account-page');
const chatPage = document.getElementById('chat-page'); // New chat page element

const loginAlert = document.getElementById('login-alert');
const registerAlert = document.getElementById('register-alert');
const profileAlert = document.getElementById('profile-alert');
const postAlert = document.getElementById('post-alert');
const postSubmitBtn = document.getElementById('post-submit-btn'); // Get the submit button

const chatMessagesDiv = document.getElementById('chat-messages'); // Chat elements
const chatInput = document.getElementById('chat-input');
const sendChatBtn = document.getElementById('send-chat-btn');
const chatAlert = document.getElementById('chat-alert');
const chatTabButtons = document.querySelectorAll('.chat-tab-button');
const privateChatSelection = document.getElementById('private-chat-selection');
const privateChatUserSelect = document.getElementById('private-chat-user');
const startPrivateChatBtn = document.getElementById('start-private-chat-btn');

const categorySelection = document.getElementById('category-selection'); // Buy page category elements
const accountListingSection = document.getElementById('account-listing-section');
const backToCategoriesBtn = document.getElementById('back-to-categories');
const filterCategorySelect = document.getElementById('filter-category');

let allAccountsData = []; // Store all fetched accounts for filtering
let currentAccountDetail = null; // To store data for the detail modal
let currentImageViewerImages = []; // Stores image URLs for the viewer
let currentImageViewerIndex = 0; // Current index in the image viewer
let userProfilePicUrl = ''; // Global variable for user profile picture URL

let currentChatCategory = 'global'; // Default chat category
let currentPrivateChatPartnerId = null; // For private chat

// Helper function to show alerts
function showAlert(element, message, type) {
  element.textContent = message;
  element.className = `alert alert-${type}`;
  element.classList.remove('hidden');
  setTimeout(() => {
    element.classList.add('hidden');
  }, 5000);
}

// Function to hide all main content pages
function hideAllPages() {
  loginForm.classList.add('hidden');
  registerForm.classList.add('hidden');
  landingPage.classList.add('hidden');
  profilePage.classList.add('hidden');
  postAccountPage.classList.add('hidden');
  buyAccountPage.classList.add('hidden');
  chatPage.classList.add('hidden'); // Hide chat page
}

// Show/Hide forms (Login/Register)
document.getElementById('show-register').addEventListener('click', (e) => {
  e.preventDefault();
  hideAllPages();
  registerForm.classList.remove('hidden');
  registerAlert.classList.add('hidden'); // Clear previous alerts
});
document.getElementById('show-login').addEventListener('click', (e) => {
  e.preventDefault();
  hideAllPages();
  loginForm.classList.remove('hidden');
  loginAlert.classList.add('hidden'); // Clear previous alerts
});

// Register User
registerForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const name = document.getElementById('reg-name').value;
  const dob = document.getElementById('reg-dob').value;
  const email = document.getElementById('reg-email').value;
  const countryCode = document.getElementById('reg-whatsapp-country-code').value;
  const whatsappNumber = document.getElementById('reg-whatsapp').value;
  const whatsapp = countryCode + whatsappNumber; // Combine code and number
  const password = document.getElementById('reg-password').value;
  const confirmPassword = document.getElementById('reg-confirm-password').value;

  const birthDate = new Date(dob);
  const today = new Date();
  let age = today.getFullYear() - birthDate.getFullYear();
  const m = today.getMonth() - birthDate.getMonth();
  if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
    age--;
  }

  if (age < 12) {
    showAlert(registerAlert, 'Umur minimal 12 tahun untuk mendaftar.', 'error');
    return;
  }
  if (password.length < 6) {
    showAlert(registerAlert, 'Password minimal 6 karakter.', 'error');
    return;
  }
  if (password !== confirmPassword) {
    showAlert(registerAlert, 'Konfirmasi password tidak cocok.', 'error');
    return;
  }

  try {
    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
    await db.ref('users/' + userCredential.user.uid).set({
      name,
      dob,
      age,
      email,
      whatsapp,
      profilePicUrl: 'https://via.placeholder.com/150', // Default profile picture
      createdAt: firebase.database.ServerValue.TIMESTAMP
    });
    showAlert(registerAlert, 'Registrasi berhasil! Anda akan diarahkan ke halaman utama.', 'success');
    registerForm.reset();
    setTimeout(() => {
      hideAllPages();
      landingPage.classList.remove('hidden'); // Arahkan ke promo banner
    }, 1500);
  } catch (err) {
    console.error("Registration error:", err);
    showAlert(registerAlert, `Registrasi gagal: ${err.message}`, 'error');
  }
});

// Login User
loginForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const email = document.getElementById('login-email').value;
  const password = document.getElementById('login-password').value;

  try {
    await auth.signInWithEmailAndPassword(email, password);
    showAlert(loginAlert, 'Login berhasil! Memuat akun...', 'success');
    setTimeout(() => {
      hideAllPages();
      landingPage.classList.remove('hidden'); // Arahkan ke promo banner
    }, 1500);
  } catch (err) {
    console.error("Login error:", err);
    showAlert(loginAlert, `Login gagal: ${err.message}`, 'error');
  }
});

// Logout User (via dropdown)
document.getElementById('nav-logout-dropdown').addEventListener('click', (e) => {
  e.preventDefault();
  auth.signOut();
  location.reload(); // Reload page to show login form
});

// Authentication State Change Listener
auth.onAuthStateChanged(user => {
  const navLinksDiv = document.querySelector('.nav-links');
  if (user) {
    // User is signed in
    navLinksDiv.style.display = 'flex'; // Show nav items
    // Load user data for profile pic and name in nav
    db.ref('users/' + user.uid).once('value').then(snapshot => {
      if (snapshot.exists()) {
        const data = snapshot.val();
        document.getElementById('nav-username').textContent = data.name.split(' ')[0]; // Display first name
        userProfilePicUrl = data.profilePicUrl || 'https://via.placeholder.com/30';
        document.getElementById('nav-profile-pic-small').src = userProfilePicUrl;
      }
    }).catch(error => {
      console.error("Error loading user data for nav:", error);
      // Fallback to default if user data cannot be loaded
      document.getElementById('nav-profile-pic-small').src = 'https://via.placeholder.com/30';
      document.getElementById('nav-username').textContent = 'User';
    });
    hideAllPages();
    landingPage.classList.remove('hidden'); // Default to promo banner
    loadAccounts(); // Load all accounts data for filtering later
  } else {
    // User is signed out
    hideAllPages();
    loginForm.classList.remove('hidden');
    navLinksDiv.style.display = 'none'; // Hide nav items
    document.getElementById('nav-profile-pic-small').src = 'https://via.placeholder.com/30'; // Reset to default
    document.getElementById('nav-username').textContent = 'User'; // Reset username
  }
});

// Navigation Handlers
document.getElementById('nav-home').addEventListener('click', (e) => {
  e.preventDefault();
  hideAllPages();
  landingPage.classList.remove('hidden'); // Tampilkan promo banner
});

document.getElementById('nav-profile-dropdown').addEventListener('click', async (e) => {
  e.preventDefault();
  hideAllPages();
  profilePage.classList.remove('hidden');
  // Clear previous my posts display
  const myPostsContainer = profilePage.querySelector('#my-posts-container');
  if (myPostsContainer) {
    myPostsContainer.remove(); // Remove and re-add to ensure clean state
    profilePage.appendChild(myPostsContainer); // Re-add the container
  } else {
    // If it doesn't exist, create it
    const newMyPostsContainer = document.createElement('div');
    newMyPostsContainer.id = 'my-posts-container';
    newMyPostsContainer.innerHTML = '<h3>Postingan Saya</h3><div class="flex" id="my-posts-list"></div>';
    profilePage.appendChild(newMyPostsContainer);
  }
  await loadProfile();
  await loadMyPosts();
});

document.getElementById('nav-post').addEventListener('click', (e) => {
  e.preventDefault();
  hideAllPages();
  postAccountPage.classList.remove('hidden');
  postAccountPage.reset(); // Clear form on navigation
  editPostId = null; // Reset edit mode
  currentEditData = null; // Reset edit data
  postSubmitBtn.textContent = 'Post Akun'; // Reset button text

  document.getElementById('image-previews').innerHTML = ''; // Clear image previews
  document.getElementById('image-previews').classList.add('hidden');
  document.getElementById('account-images').required = true; // Make image upload required for new posts

  // Hide all game-specific fields
  document.getElementById('ml-fields').classList.add('hidden');
  document.getElementById('toram-fields').classList.add('hidden');
  document.getElementById('lifeafter-fields').classList.add('hidden');
  document.getElementById('sea-server-fields').classList.add('hidden');
  document.getElementById('na-server-fields').classList.add('hidden');
  document.getElementById('la-job-detail').classList.add('hidden'); // Hide job detail dropdown

  // Clear dynamic fields and add initial empty ones
  document.getElementById('ml-heroes-container').innerHTML = '<label>Hero Favorit (Minimal 1, Maksimal 3)</label><div class="item-group"><input type="text" class="ml-hero-name" placeholder="Nama Hero"><input type="number" class="ml-hero-wr" placeholder="Win Rate Hero (%)" min="0" max="100"><button type="button" class="remove-item-btn" onclick="this.parentElement.remove()">Hapus</button></div>';
  document.getElementById('toram-characters-container').innerHTML = '<label>Slot Character</label><div class="item-group"><input type="number" class="toram-char-level" placeholder="Level Character" min="1"><input type="text" class="toram-char-job" placeholder="Deskripsi Job Character (contoh: Tank)"><button type="button" class="remove-item-btn" onclick="this.parentElement.remove()">Hapus</button></div>';
  document.getElementById('toram-equip-container').innerHTML = '<label>Equip Untrade</label><div class="item-group"><input type="text" class="toram-equip-desc" placeholder="Deskripsi Item Equip (contoh: Pedang A)"><button type="button" class="remove-item-btn" onclick="this.parentElement.remove()">Hapus</button></div>';
  document.getElementById('toram-gudang-container').innerHTML = '<label>Gudang</label><div class="item-group"><input type="text" class="toram-gudang-name" placeholder="Nama Gudang (contoh: A)"><input type="number" class="toram-gudang-slot" placeholder="Jumlah Slot" min="0"><button type="button" class="remove-item-btn" onclick="this.parentElement.remove()">Hapus</button></div>';
});

document.getElementById('nav-buy').addEventListener('click', (e) => {
  e.preventDefault();
  hideAllPages();
  buyAccountPage.classList.remove('hidden');
  categorySelection.classList.remove('hidden'); // Tampilkan pilihan kategori
  accountListingSection.classList.add('hidden'); // Sembunyikan daftar akun
  resetFilters(); // Reset filter saat kembali ke halaman beli akun
});

document.getElementById('nav-chat-community').addEventListener('click', (e) => {
  e.preventDefault();
  hideAllPages();
  chatPage.classList.remove('hidden');
  // Default to global chat when opening community chat
  switchChatCategory('global');
});

// Load Profile Data
async function loadProfile() {
  const user = auth.currentUser;
  if (user) {
    try {
      const userDoc = await db.ref('users/' + user.uid).once('value');
      if (userDoc.exists()) {
        const data = userDoc.val();
        document.getElementById('profile-name-display-header').textContent = data.name;
        document.getElementById('profile-age-display').textContent = data.age;
        document.getElementById('profile-email-display').textContent = data.email;
        
        // Split WhatsApp number into country code and actual number
        const whatsappFull = data.whatsapp || '';
        const countryCodeMatch = whatsappFull.match(/^(\+\d+)/);
        let whatsappNumOnly = whatsappFull;
        let whatsappCountryCode = '+62'; // Default to Indonesia

        if (countryCodeMatch) {
            whatsappCountryCode = countryCodeMatch[1];
            whatsappNumOnly = whatsappFull.substring(countryCodeMatch[1].length);
        }

        document.getElementById('profile-whatsapp-display-info').textContent = whatsappFull;
        
        const createdAtDate = new Date(data.createdAt);
        document.getElementById('profile-joined-date').textContent = createdAtDate.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });

        document.getElementById('profile-name').value = data.name;
        document.getElementById('profile-whatsapp-country-code').value = whatsappCountryCode;
        document.getElementById('profile-whatsapp').value = whatsappNumOnly;
        document.getElementById('profile-password').value = ''; // Clear password fields
        document.getElementById('profile-confirm-password').value = '';

        // Load profile picture
        userProfilePicUrl = data.profilePicUrl || 'https://via.placeholder.com/180';
        document.getElementById('profile-pic-display').src = userProfilePicUrl;
        document.getElementById('nav-profile-pic-small').src = userProfilePicUrl;
      }
    } catch (err) {
      console.error("Error loading profile:", err);
      showAlert(profileAlert, `Gagal memuat profil: ${err.message}`, 'error');
    }
  }
}

// Load My Posts
async function loadMyPosts() {
  const currentUser = auth.currentUser;
  if (!currentUser) return;
  
  let myPostsContainer = document.getElementById('my-posts-container');
  if (!myPostsContainer) {
    myPostsContainer = document.createElement('div');
    myPostsContainer.id = 'my-posts-container';
    myPostsContainer.innerHTML = '<h3>Postingan Saya</h3><div class="flex" id="my-posts-list"></div>';
    profilePage.appendChild(myPostsContainer);
  }
  const myPostsList = document.getElementById('my-posts-list');
  myPostsList.innerHTML = ''; // Clear previous posts

  try {
    const snapshot = await db.ref('accounts').orderByChild('ownerId').equalTo(currentUser.uid).once('value');
    if (!snapshot.exists() || snapshot.val() === null) {
      myPostsList.innerHTML = '<p style="text-align: center; width: 100%;">Belum ada postingan.</p>';
    } else {
      snapshot.forEach(child => {
        const d = child.val();
        const card = document.createElement('div');
        card.className = 'account-card';
        let imagesHtml = '<div class="image-gallery">';
        if (d.imageUrls && d.imageUrls.length > 0) {
          // Menggunakan object-fit: contain untuk gambar di profil/postinganku
          imagesHtml += `<img src="${d.imageUrls[0]}" alt="Gambar Akun ${d.category}" style="max-width: 100%; height: 150px; object-fit: contain; border-radius: 8px;">`; // Show only first image as main
        }
        imagesHtml += '</div>';
        card.innerHTML = imagesHtml + `<h4>${d.category}</h4><p>Harga: Rp ${d.price.toLocaleString('id-ID')}</p><p>Status: <span style="color: ${d.status === 'terjual' ? 'red' : 'green'}; font-weight: bold;">${d.status === 'terjual' ? 'Terjual' : 'Tersedia'}</span></p>`;
        
        const editBtn = document.createElement('button');
        editBtn.textContent = 'Edit';
        editBtn.className = 'add-item-btn';
        editBtn.style.marginRight = '10px';
        editBtn.addEventListener('click', () => { fillEditForm(child.key); });
        card.appendChild(editBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Hapus';
        deleteBtn.className = 'remove-item-btn';
        deleteBtn.addEventListener('click', () => { deletePost(child.key, d.imageUrls); });
        card.appendChild(deleteBtn);

        myPostsList.appendChild(card);
      });
    }
  } catch (err) {
    console.error("Error loadMyPosts:", err);
    myPostsList.innerHTML = '<p style="text-align: center; width: 100%; color: red;">Gagal memuat postingan Anda.</p>';
  }
}

// Delete Post
async function deletePost(postId, imageUrls) {
  if (!confirm('Apakah Anda yakin ingin menghapus postingan ini?')) {
    return;
  }
  try {
    // Delete images from storage
    if (imageUrls && imageUrls.length > 0) {
      for (const url of imageUrls) {
        try {
          const imageRef = storage.refFromURL(url);
          await imageRef.delete();
        } catch (error) {
          console.warn(`Failed to delete image ${url}:`, error);
          // Continue even if one image fails to delete
        }
      }
    }
    // Delete data from database
    await db.ref('accounts/' + postId).remove();
    showAlert(profileAlert, 'Postingan berhasil dihapus!', 'success');
    await loadMyPosts(); // Reload my posts
  } catch (err) {
    console.error("Error deleting post:", err);
    showAlert(profileAlert, `Gagal menghapus postingan: ${err.message}`, 'error');
  }
}

// Isi form edit
async function fillEditForm(postId) {
  const snapshot = await db.ref('accounts/' + postId).once('value');
  if (!snapshot.exists()) {
    showAlert(postAlert, 'Data postingan tidak ditemukan.', 'error');
    return;
  }
  currentEditData = snapshot.val();
  editPostId = postId;

  hideAllPages();
  postAccountPage.classList.remove('hidden');
  postSubmitBtn.textContent = 'Update Akun'; // Change button text
  document.getElementById('account-images').required = false; // Images are optional for update

  // Fill common fields
  document.getElementById('game-category').value = currentEditData.category || '';
  document.getElementById('price').value = currentEditData.price || '';
  document.getElementById('status').value = currentEditData.status || '';

  // Display image previews
  const previews = document.getElementById('image-previews');
  previews.innerHTML = '';
  if (currentEditData.imageUrls && currentEditData.imageUrls.length > 0) {
    currentEditData.imageUrls.forEach(url => {
      const img = document.createElement('img');
      img.src = url;
      img.alt = "Gambar Akun"; // Add alt text
      img.style.objectFit = 'contain'; // Pastikan gambar preview tidak terpotong
      previews.appendChild(img);
    });
    previews.classList.remove('hidden');
  } else {
    previews.classList.add('hidden');
  }

  // Show and fill game-specific fields
  showGameFields(); // This will hide all and then show the correct one

  if (currentEditData.category === 'ml' && currentEditData.ml) {
    const ml = currentEditData.ml;
    document.getElementById('ml-rank-now').value = ml.rankNow || '';
    document.getElementById('ml-rank-highest').value = ml.rankHighest || '';
    document.getElementById('ml-win-all-matches').value = ml.winAllMatches || '';
    document.getElementById('ml-win-all-percent').value = ml.winAllPercent || '';
    document.getElementById('ml-win-season-matches').value = ml.winSeasonMatches || '';
    document.getElementById('ml-win-season-percent').value = ml.winSeasonPercent || '';
    document.getElementById('ml-role').value = ml.role || '';
    document.getElementById('ml-emblem').value = ml.emblem || '';
    document.getElementById('ml-skins').value = ml.skins || '';

    const heroesContainer = document.getElementById('ml-heroes-container');
    heroesContainer.innerHTML = '<label>Hero Favorit (Minimal 1, Maksimal 3)</label>'; // Clear existing
    if (ml.heroes && ml.heroes.length > 0) {
      ml.heroes.forEach(hero => {
        const div = document.createElement('div');
        div.className = 'item-group';
        div.innerHTML = `
          <input type="text" class="ml-hero-name" placeholder="Nama Hero" value="${hero.name || ''}">
          <input type="number" class="ml-hero-wr" placeholder="Win Rate Hero (%)" min="0" max="100" value="${hero.wr || ''}">
          <button type="button" class="remove-item-btn" onclick="this.parentElement.remove()">Hapus</button>
        `;
        heroesContainer.appendChild(div);
      });
    } else {
      // Add at least one empty hero field if none exist
      addMlHeroField();
    }
  } else if (currentEditData.category === 'toram' && currentEditData.toram) {
    const toram = currentEditData.toram;
    document.getElementById('toram-mainquest').value = toram.mainQuest || '';
    document.getElementById('toram-orb').value = toram.orb || '';
    document.getElementById('toram-tiket').value = toram.tiket || '';

    const charsContainer = document.getElementById('toram-characters-container');
    charsContainer.innerHTML = '<label>Slot Character</label>';
    if (toram.characters && toram.characters.length > 0) {
      toram.characters.forEach(char => {
        const div = document.createElement('div');
        div.className = 'item-group';
        div.innerHTML = `
          <input type="number" class="toram-char-level" placeholder="Level Character" min="1" value="${char.level || ''}">
          <input type="text" class="toram-char-job" placeholder="Deskripsi Job Character (contoh: Tank)" value="${char.job || ''}">
          <button type="button" class="remove-item-btn" onclick="this.parentElement.remove()">Hapus</button>
        `;
        charsContainer.appendChild(div);
      });
    } else {
      addToramCharacterField();
    }

    const equipsContainer = document.getElementById('toram-equip-container');
    equipsContainer.innerHTML = '<label>Equip Untrade</label>';
    if (toram.equip && toram.equip.length > 0) {
      toram.equip.forEach(equip => {
        const div = document.createElement('div');
        div.className = 'item-group';
        div.innerHTML = `
          <input type="text" class="toram-equip-desc" placeholder="Deskripsi Item Equip (contoh: Pedang A)" value="${equip || ''}">
          <button type="button" class="remove-item-btn" onclick="this.parentElement.remove()">Hapus</button>
        `;
        equipsContainer.appendChild(div);
      });
    } else {
      addToramEquipField();
    }

    const gudangsContainer = document.getElementById('toram-gudang-container');
    gudangsContainer.innerHTML = '<label>Gudang</label>';
    if (toram.gudang && toram.gudang.length > 0) {
      toram.gudang.forEach(gudang => {
        const div = document.createElement('div');
        div.className = 'item-group';
        div.innerHTML = `
          <input type="text" class="toram-gudang-name" placeholder="Nama Gudang (contoh: A)" value="${gudang.name || ''}">
          <input type="number" class="toram-gudang-slot" placeholder="Jumlah Slot" min="0" value="${gudang.slot || ''}">
          <button type="button" class="remove-item-btn" onclick="this.parentElement.remove()">Hapus</button>
        `;
        gudangsContainer.appendChild(div);
      });
    } else {
      addToramGudangField();
    }

  } else if (currentEditData.category === 'lifeafter' && currentEditData.lifeafter) {
    const la = currentEditData.lifeafter;
    document.getElementById('lifeafter-server').value = la.serverCategory || '';
    showLifeAfterServer(); // Call to show correct server dropdown
    if (la.serverCategory === 'sea') {
      document.getElementById('sea-server-dropdown').value = la.serverDetail || '';
    } else if (la.serverCategory === 'na') {
      document.getElementById('na-server-dropdown').value = la.serverDetail || '';
    }
    document.getElementById('la-manor').value = la.manor || '';
    document.getElementById('la-level-gether').value = la.levelGether || '';
    document.getElementById('la-level-craft').value = la.levelCraft || '';
    document.getElementById('la-level-combat').value = la.levelCombat || '';

    // Fill attachment levels and grades
    const fillAttachmentFields = (prefix, attachments) => {
      if (attachments) {
        document.querySelector(`.${prefix}-stock-level`).value = attachments[0]?.level || '';
        document.querySelector(`.${prefix}-stock-grade`).value = attachments[0]?.grade || '';
        document.querySelector(`.${prefix}-stock-color`).value = attachments[0]?.color || '';

        document.querySelector(`.${prefix}-sight-level`).value = attachments[1]?.level || '';
        document.querySelector(`.${prefix}-sight-grade`).value = attachments[1]?.grade || '';
        document.querySelector(`.${prefix}-sight-color`).value = attachments[1]?.color || '';

        document.querySelector(`.${prefix}-muzzle-level`).value = attachments[2]?.level || '';
        document.querySelector(`.${prefix}-muzzle-grade`).value = attachments[2]?.grade || '';
        document.querySelector(`.${prefix}-muzzle-color`).value = attachments[2]?.color || '';
      }
    };

    const fillMeeleAttachmentFields = (prefix) => {
      const attachments = currentEditData.lifeafter.attachments.meeleWeapon;
      if (attachments) {
        document.querySelector(`.${prefix}-knob-level`).value = attachments[0]?.level || '';
        document.querySelector(`.${prefix}-knob-grade`).value = attachments[0]?.grade || '';
        document.querySelector(`.${prefix}-knob-color`).value = attachments[0]?.color || '';

        document.querySelector(`.${prefix}-tasle-level`).value = attachments[1]?.level || '';
        document.querySelector(`.${prefix}-tasle-grade`).value = attachments[1]?.grade || '';
        document.querySelector(`.${prefix}-tasle-color`).value = attachments[1]?.color || '';

        document.querySelector(`.${prefix}-sculpture-level`).value = attachments[2]?.level || '';
        document.querySelector(`.${prefix}-sculpture-grade`).value = attachments[2]?.grade || '';
        document.querySelector(`.${prefix}-sculpture-color`).value = attachments[2]?.color || '';
      }
    };

    const fillArmorAttachmentFields = (prefix) => {
      const attachments = currentEditData.lifeafter.attachments.armor;
      if (attachments) {
        document.querySelector(`.${prefix}-steel-level`).value = attachments[0]?.level || '';
        document.querySelector(`.${prefix}-steel-grade`).value = attachments[0]?.grade || '';
        document.querySelector(`.${prefix}-steel-color`).value = attachments[0]?.color || '';

        document.querySelector(`.${prefix}-chain-level`).value = attachments[1]?.level || '';
        document.querySelector(`.${prefix}-chain-grade`).value = attachments[1]?.grade || '';
        document.querySelector(`.${prefix}-chain-color`).value = attachments[1]?.color || '';

        document.querySelector(`.${prefix}-cotton-level`).value = attachments[2]?.level || '';
        document.querySelector(`.${prefix}-cotton-grade`).value = attachments[2]?.grade || '';
        document.querySelector(`.${prefix}-cotton-color`).value = attachments[2]?.color || '';
      }
    };

    fillAttachmentFields('la-lw', la.attachments.lightWeapon);
    fillAttachmentFields('la-hw', la.attachments.heavyWeapon);
    fillMeeleAttachmentFields('la-mw');
    fillArmorAttachmentFields('la-armor');

    document.getElementById('la-job-category').value = la.jobCategory || '';
    showLifeAfterJob(); // Call to populate job detail dropdown
    document.getElementById('la-job-detail').value = la.jobDetail || '';
    document.getElementById('la-gene').value = la.gene || '';
    document.getElementById('la-charisma').value = la.charisma || '';
    document.getElementById('la-outfit-collector').value = la.outfit.collector || '';
    document.getElementById('la-outfit-gacha').value = la.outfit.gacha || '';
    document.getElementById('la-outfit-mall').value = la.outfit.mall || '';
    document.getElementById('la-outfit-common').value = la.outfit.common || '';
  }
}

// Update Profile
profilePage.addEventListener('submit', async (e) => {
  e.preventDefault();
  const user = auth.currentUser;
  if (!user) {
    showAlert(profileAlert, 'Anda harus login untuk update profil.', 'error');
    return;
  }

  const newName = document.getElementById('profile-name').value;
  const newCountryCode = document.getElementById('profile-whatsapp-country-code').value;
  const newWhatsappNumber = document.getElementById('profile-whatsapp').value;
  const newWhatsapp = newCountryCode + newWhatsappNumber; // Combine code and number
  const newPassword = document.getElementById('profile-password').value;
  const confirmNewPassword = document.getElementById('profile-confirm-password').value;

  if (newPassword && newPassword.length < 6) {
    showAlert(profileAlert, 'Password baru minimal 6 karakter.', 'error');
    return;
  }
  if (newPassword && newPassword !== confirmNewPassword) {
    showAlert(profileAlert, 'Konfirmasi password baru tidak cocok.', 'error');
    return;
  }

  try {
    // Update Firestore user data
    await db.ref('users/' + user.uid).update({
      name: newName,
      whatsapp: newWhatsapp
    });

    // Update Firebase Auth password if provided
    if (newPassword) {
      await user.updatePassword(newPassword);
    }

    showAlert(profileAlert, 'Profil berhasil diperbarui!', 'success');
    loadProfile(); // Reload profile to show updated data
  } catch (err) {
    console.error("Error updating profile:", err);
    showAlert(profileAlert, `Gagal memperbarui profil: ${err.message}`, 'error');
  }
});

// Add event listener for profile picture upload
document.getElementById('profile-pic-upload').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const user = auth.currentUser;
  if (!user) {
    showAlert(profileAlert, 'Anda harus login untuk mengunggah foto profil.', 'error');
    return;
  }

  showAlert(profileAlert, 'Mengunggah foto profil...', 'info');
  try {
    const storageRef = storage.ref().child(`profile_pictures/${user.uid}/${file.name}`);
    const snapshot = await storageRef.put(file);
    const downloadURL = await snapshot.ref.getDownloadURL();

    await db.ref('users/' + user.uid).update({
      profilePicUrl: downloadURL
    });

    showAlert(profileAlert, 'Foto profil berhasil diperbarui!', 'success');
    loadProfile(); // Reload profile to show new picture
  } catch (err) {
    console.error("Error uploading profile picture:", err);
    showAlert(profileAlert, `Gagal mengunggah foto profil: ${err.message}`, 'error');
  }
});


// Helper for attachment grade calculation
const gradeOrder = { "Green": 1, "Blue": 2, "Purple": 3 };

// Modified function to return detailed attachment string
function getDetailedAttachmentDisplay(attachments) {
  if (!attachments || attachments.length === 0) return 'N/A';

  let detailParts = [];
  let lowestGrade = 13; // Higher than max grade 12
  let lowestColor = "";

  attachments.forEach(att => {
    const level = att.level || 0;
    const grade = att.grade || 0;
    const color = att.color || 'N/A';
    detailParts.push(`${att.name}: ${level}|Grade ${grade}|${color}`);

    // Calculate lowest overall grade
    if (grade > 0 && gradeOrder[color]) { // Only consider valid attachments
      if (grade < lowestGrade) {
        lowestGrade = grade;
        lowestColor = color;
      } else if (grade === lowestGrade) {
        if (gradeOrder[color] < gradeOrder[lowestColor]) {
          lowestColor = color;
        }
      }
    }
  });

  const resultPart = (lowestGrade === 13) ? '' : `(Result: Set Weapon Grade ${lowestGrade} ${lowestColor})`;
  return `${detailParts.join(', ')}${resultPart}`;
}


// Post Account
postAccountPage.addEventListener('submit', async (e) => {
  e.preventDefault();
  postSubmitBtn.disabled = true; // Disable button to prevent double submission
  postSubmitBtn.textContent = 'Processing...'; // Change button text

  const user = auth.currentUser;
  if (!user) {
    showAlert(postAlert, 'Anda harus login untuk posting akun.', 'error');
    postSubmitBtn.disabled = false;
    postSubmitBtn.textContent = editPostId ? 'Update Akun' : 'Post Akun';
    return;
  }

  const gameCategory = document.getElementById('game-category').value;
  const price = document.getElementById('price').value;
  const status = document.getElementById('status').value;
  const files = document.getElementById('account-images').files;

  if (!gameCategory || !price) {
    showAlert(postAlert, 'Harap lengkapi semua kolom yang wajib diisi (Kategori Game, Harga).', 'error');
    postSubmitBtn.disabled = false;
    postSubmitBtn.textContent = editPostId ? 'Update Akun' : 'Post Akun';
    return;
  }

  if (!editPostId && files.length === 0) { // Images are required only for new posts
    showAlert(postAlert, 'Harap unggah setidaknya satu gambar akun.', 'error');
    postSubmitBtn.disabled = false;
    postSubmitBtn.textContent = 'Post Akun';
    return;
  }

  if (files.length > 12) {
    showAlert(postAlert, 'Maksimal 12 gambar yang dapat diunggah.', 'error');
    postSubmitBtn.disabled = false;
    postSubmitBtn.textContent = editPostId ? 'Update Akun' : 'Post Akun';
    return;
  }

  let data = {
    category: gameCategory,
    ownerId: user.uid,
    ownerWhatsapp: (await db.ref('users/' + user.uid).once('value')).val().whatsapp,
    ownerName: (await db.ref('users/' + user.uid).once('value')).val().name,
    status: status,
    price: parseInt(price),
    postedAt: firebase.database.ServerValue.TIMESTAMP
  };

  // Collect game-specific data
  if (gameCategory === 'ml') {
    const heroes = [];
    document.querySelectorAll('#ml-heroes-container .item-group').forEach(group => {
      const name = group.querySelector('.ml-hero-name').value.trim();
      const wr = parseFloat(group.querySelector('.ml-hero-wr').value) || 0;
      if (name) heroes.push({ name, wr });
    });
    if (heroes.length < 1 || heroes.length > 3) {
      showAlert(postAlert, 'Mobile Legend: Hero Favorit harus minimal 1 dan maksimal 3.', 'error');
      postSubmitBtn.disabled = false;
      postSubmitBtn.textContent = editPostId ? 'Update Akun' : 'Post Akun';
      return;
    }

    data.ml = {
      rankNow: document.getElementById('ml-rank-now').value,
      rankHighest: document.getElementById('ml-rank-highest').value,
      winAllMatches: parseInt(document.getElementById('ml-win-all-matches').value) || 0,
      winAllPercent: parseFloat(document.getElementById('ml-win-all-percent').value) || 0,
      winSeasonMatches: parseInt(document.getElementById('ml-win-season-matches').value) || 0,
      winSeasonPercent: parseFloat(document.getElementById('ml-win-season-percent').value) || 0,
      role: document.getElementById('ml-role').value,
      heroes: heroes,
      emblem: parseInt(document.getElementById('ml-emblem').value) || 0,
      skins: parseInt(document.getElementById('ml-skins').value) || 0
    };
  } else if (gameCategory === 'toram') {
    const characters = [];
    document.querySelectorAll('#toram-characters-container .item-group').forEach(group => {
      const level = parseInt(group.querySelector('.toram-char-level').value) || 0;
      const job = group.querySelector('.toram-char-job').value.trim();
      if (job) characters.push({ level, job });
    });
    const equips = [];
    document.querySelectorAll('#toram-equip-container .item-group').forEach(group => {
      const desc = group.querySelector('.toram-equip-desc').value.trim();
      if (desc) equips.push(desc);
    });
    const gudangs = [];
    document.querySelectorAll('#toram-gudang-container .item-group').forEach(group => {
      const name = group.querySelector('.toram-gudang-name').value.trim();
      const slot = parseInt(group.querySelector('.toram-gudang-slot').value) || 0;
      if (name) gudangs.push({ name, slot });
    });

    data.toram = {
      mainQuest: document.getElementById('toram-mainquest').value,
      characters: characters,
      equip: equips,
      gudang: gudangs,
      orb: parseInt(document.getElementById('toram-orb').value) || 0,
      tiket: parseInt(document.getElementById('toram-tiket').value) || 0
    };
  } else if (gameCategory === 'lifeafter') {
    const serverCategory = document.getElementById('lifeafter-server').value;
    const manorLevel = parseInt(document.getElementById('la-manor').value) || 0;
    const getherLevel = parseInt(document.getElementById('la-level-gether').value) || 0;
    const craftLevel = parseInt(document.getElementById('la-level-craft').value) || 0;
    const combatLevel = parseInt(document.getElementById('la-level-combat').value) || 0;

    // Validate character levels based on server
    if (serverCategory === 'easy' && (getherLevel > 79 || craftLevel > 79 || combatLevel > 79)) {
      showAlert(postAlert, 'LifeAfter: Untuk EasyServer, Level Character (Gether, Craft, Combat) maksimal 79.', 'error');
      postSubmitBtn.disabled = false;
      postSubmitBtn.textContent = editPostId ? 'Update Akun' : 'Post Akun';
      return;
    } else if (serverCategory !== 'easy' && (getherLevel > 149 || craftLevel > 149 || combatLevel > 149)) {
      showAlert(postAlert, 'LifeAfter: Untuk server non-Easy, Level Character (Gether, Craft, Combat) maksimal 149.', 'error');
      postSubmitBtn.disabled = false;
      postSubmitBtn.textContent = editPostId ? 'Update Akun' : 'Post Akun';
      return;
    }

    const getAttachmentData = (prefix) => {
      const stockLevel = parseInt(document.querySelector(`.${prefix}-stock-level`).value) || 0;
      const stockGrade = parseInt(document.querySelector(`.${prefix}-stock-grade`).value) || 0;
      const stockColor = document.querySelector(`.${prefix}-stock-color`).value;

      const sightLevel = parseInt(document.querySelector(`.${prefix}-sight-level`).value) || 0;
      const sightGrade = parseInt(document.querySelector(`.${prefix}-sight-grade`).value) || 0;
      const sightColor = document.querySelector(`.${prefix}-sight-color`).value;

      const muzzleLevel = parseInt(document.querySelector(`.${prefix}-muzzle-level`).value) || 0;
      const muzzleGrade = parseInt(document.querySelector(`.${prefix}-muzzle-grade`).value) || 0;
      const muzzleColor = document.querySelector(`.${prefix}-muzzle-color`).value;

      const attachments = [
        { name: 'Stock', level: stockLevel, grade: stockGrade, color: stockColor },
        { name: 'Sight', level: sightLevel, grade: sightGrade, color: sightColor },
        { name: 'Muzzle', level: muzzleLevel, grade: muzzleGrade, color: muzzleColor }
      ];
      return attachments;
    };

    const getMeeleAttachmentData = (prefix) => {
      const knobLevel = parseInt(document.querySelector(`.${prefix}-knob-level`).value) || 0;
      const knobGrade = parseInt(document.querySelector(`.${prefix}-knob-grade`).value) || 0;
      const knobColor = document.querySelector(`.${prefix}-knob-color`).value;

      const tasleLevel = parseInt(document.querySelector(`.${prefix}-tasle-level`).value) || 0;
      const tasleGrade = parseInt(document.querySelector(`.${prefix}-tasle-grade`).value) || 0;
      const tasleColor = document.querySelector(`.${prefix}-tasle-color`).value;

      const sculptureLevel = parseInt(document.querySelector(`.${prefix}-sculpture-level`).value) || 0;
      const sculptureGrade = parseInt(document.querySelector(`.${prefix}-sculpture-grade`).value) || 0;
      const sculptureColor = document.querySelector(`.${prefix}-sculpture-color`).value;

      const attachments = [
        { name: 'Knob', level: knobLevel, grade: knobGrade, color: knobColor },
        { name: 'Hanging Tasle', level: tasleLevel, grade: tasleGrade, color: tasleColor },
        { name: 'Sculpture', level: sculptureLevel, grade: sculptureGrade, color: sculptureColor }
      ];
      return attachments;
    };

    const getArmorAttachmentData = (prefix) => {
      const steelLevel = parseInt(document.querySelector(`.${prefix}-steel-level`).value) || 0;
      const steelGrade = parseInt(document.querySelector(`.${prefix}-steel-grade`).value) || 0;
      const steelColor = document.querySelector(`.${prefix}-steel-color`).value;

      const chainLevel = parseInt(document.querySelector(`.${prefix}-chain-level`).value) || 0;
      const chainGrade = parseInt(document.querySelector(`.${prefix}-chain-grade`).value) || 0;
      const chainColor = document.querySelector(`.${prefix}-chain-color`).value;

      const cottonLevel = parseInt(document.querySelector(`.${prefix}-cotton-level`).value) || 0;
      const cottonGrade = parseInt(document.querySelector(`.${prefix}-cotton-grade`).value) || 0;
      const cottonColor = document.querySelector(`.${prefix}-cotton-color`).value;

      const attachments = [
        { name: 'Steel Layer', level: steelLevel, grade: steelGrade, color: steelColor },
        { name: 'Chain Layer', level: chainLevel, grade: chainGrade, color: chainColor },
        { name: 'Cotton Layer', level: cottonLevel, grade: cottonColor }
      ];
      return attachments;
    };

    data.lifeafter = {
      serverCategory: serverCategory,
      serverDetail: serverCategory === 'sea' ? document.getElementById('sea-server-dropdown').value : (serverCategory === 'na' ? document.getElementById('na-server-dropdown').value : ''),
      manor: manorLevel,
      levelGether: getherLevel,
      levelCraft: craftLevel,
      levelCombat: combatLevel,
      attachments: {
        lightWeapon: getAttachmentData('la-lw'),
        heavyWeapon: getAttachmentData('la-hw'),
        meeleWeapon: getMeeleAttachmentData('la-mw'),
        armor: getArmorAttachmentData('la-armor')
      },
      jobCategory: document.getElementById('la-job-category').value,
      jobDetail: document.getElementById('la-job-detail').value,
      gene: parseInt(document.getElementById('la-gene').value) || 0,
      charisma: parseInt(document.getElementById('la-charisma').value) || 0,
      outfit: {
        collector: parseInt(document.getElementById('la-outfit-collector').value) || 0,
        gacha: parseInt(document.getElementById('la-outfit-gacha').value) || 0,
        mall: parseInt(document.getElementById('la-outfit-mall').value) || 0,
        common: parseInt(document.getElementById('la-outfit-common').value) || 0
      }
    };
  }

  try {
    let imageUrls = currentEditData ? currentEditData.imageUrls || [] : []; // Start with existing images if editing

    // If new files are selected, upload them
    if (files.length > 0) {
      // Optionally, delete old images if you want to replace them completely
      // For simplicity, this example just adds new images.
      // To replace, you'd need to track which images are removed/added.
      for (const file of files) {
        const storageRef = storage.ref().child(`accounts/${user.uid}/${Date.now()}_${file.name}`);
        const snapshot = await storageRef.put(file);
        const downloadURL = await snapshot.ref.getDownloadURL();
        imageUrls.push(downloadURL);
      }
    }
    data.imageUrls = imageUrls; // Store array of URLs

    if (editPostId) {
      // Update existing account
      await db.ref('accounts/' + editPostId).update(data); // Use update to merge data
      showAlert(postAlert, 'Postingan berhasil diperbarui!', 'success');
    } else {
      // Add new account
      await db.ref('accounts').push(data);
      showAlert(postAlert, 'Akun berhasil diposting!', 'success');
    }

    // Reset form and state
    postAccountPage.reset();
    document.getElementById('image-previews').innerHTML = '';
    document.getElementById('image-previews').classList.add('hidden');
    document.getElementById('account-images').required = true; // Reset required for new posts
    editPostId = null;
    currentEditData = null;
    postSubmitBtn.textContent = 'Post Akun';

    // Hide game-specific fields after successful post
    document.getElementById('ml-fields').classList.add('hidden');
    document.getElementById('toram-fields').classList.add('hidden');
    document.getElementById('lifeafter-fields').classList.add('hidden');
    document.getElementById('sea-server-fields').classList.add('hidden');
    document.getElementById('na-server-fields').classList.add('hidden');
    document.getElementById('la-job-detail').classList.add('hidden');
    // Reset dynamic fields to initial state
    document.getElementById('ml-heroes-container').innerHTML = '<label>Hero Favorit (Minimal 1, Maksimal 3)</label><div class="item-group"><input type="text" class="ml-hero-name" placeholder="Nama Hero"><input type="number" class="ml-hero-wr" placeholder="Win Rate Hero (%)" min="0" max="100"><button type="button" class="remove-item-btn" onclick="this.parentElement.remove()">Hapus</button></div>';
    document.getElementById('toram-characters-container').innerHTML = '<label>Slot Character</label><div class="item-group"><input type="number" class="toram-char-level" placeholder="Level Character" min="1"><input type="text" class="toram-char-job" placeholder="Deskripsi Job Character (contoh: Tank)"><button type="button" class="remove-item-btn" onclick="this.parentElement.remove()">Hapus</button></div>';
    document.getElementById('toram-equip-container').innerHTML = '<label>Equip Untrade</label><div class="item-group"><input type="text" class="toram-equip-desc" placeholder="Deskripsi Item Equip (contoh: Pedang A)"><button type="button" class="remove-item-btn" onclick="this.parentElement.remove()">Hapus</button></div>';
    document.getElementById('toram-gudang-container').innerHTML = '<label>Gudang</label><div class="item-group"><input type="text" class="toram-gudang-name" placeholder="Nama Gudang (contoh: A)"><input type="number" class="toram-gudang-slot" placeholder="Jumlah Slot" min="0"><button type="button" class="remove-item-btn" onclick="this.parentElement.remove()">Hapus</button></div>';

    loadAccounts(); // Refresh allAccountsData
    postSubmitBtn.disabled = false;
  } catch (err) {
    console.error("Error posting/updating account:", err);
    showAlert(postAlert, `Gagal posting/update akun: ${err.message}`, 'error');
    postSubmitBtn.disabled = false;
    postSubmitBtn.textContent = editPostId ? 'Update Akun' : 'Post Akun';
  }
});

// Load Accounts for Landing Page and Buy Page
async function loadAccounts() {
  // const accountListDiv = document.getElementById('account-list'); // This is for old landing page
  const buyAccountListDiv = document.getElementById('buy-account-list');
  // accountListDiv.innerHTML = '<p style="text-align: center; margin-top: 50px; font-size: 1.2em; color: #666;">Loading accounts...</p>';
  buyAccountListDiv.innerHTML = '<p style="text-align: center; margin-top: 50px; font-size: 1.2em; color: #666;">Loading accounts...</p>';

  try {
    const snapshot = await db.ref('accounts').orderByChild('postedAt').once('value');
    
    // accountListDiv.innerHTML = ''; // Clear loading message
    buyAccountListDiv.innerHTML = ''; // Clear loading message

    if (!snapshot.exists() || snapshot.val() === null) {
      // accountListDiv.innerHTML = '<p style="text-align: center; margin-top: 50px; font-size: 1.2em; color: #666;">Belum ada akun yang diposting.</p>';
      buyAccountListDiv.innerHTML = '<p style="text-align: center; margin-top: 50px; font-size: 1.2em; color: #666;">Belum ada akun yang tersedia untuk dibeli.</p>';
      allAccountsData = []; // Ensure data is empty
      return;
    }

    allAccountsData = []; // Clear previous data
    snapshot.forEach(child => {
      allAccountsData.push({ id: child.key, ...child.val() });
    });

    // Sort by postedAt in descending order (newest first)
    allAccountsData.sort((a, b) => b.postedAt - a.postedAt);

    // displayAccounts(allAccountsData, accountListDiv, false); // For landing page (all accounts) - NO LONGER USED HERE
    // applyFilters(); // Apply filters for buy page after loading all data - NO LONGER CALLED HERE
  } catch (err) {
    console.error("Error loading accounts:", err);
    // accountListDiv.innerHTML = '<p style="text-align: center; margin-top: 50px; font-size: 1.2em; color: red;">Gagal memuat daftar akun. Silakan coba lagi nanti.</p>';
    buyAccountListDiv.innerHTML = '<p style="text-align: center; margin-top: 50px; font-size: 1.2em; color: red;">Gagal memuat daftar akun. Silakan coba lagi nanti.</p>';
  }
}

function displayAccounts(accountsToDisplay, targetDiv, isBuyPage = false) {
  targetDiv.innerHTML = ''; // Clear current display

  if (accountsToDisplay.length === 0) {
    targetDiv.innerHTML = `<p style="text-align: center; margin-top: 50px; font-size: 1.2em; color: #666;">${isBuyPage ? 'Tidak ada akun yang tersedia dengan filter ini.' : 'Belum ada akun yang diposting.'}</p>`;
    return;
  }

  accountsToDisplay.forEach(d => {
    const card = document.createElement('div');
    card.className = 'account-card';
    card.dataset.id = d.id; // Store ID for detail modal

    let categoryDisplay = '';
    if (d.category === 'ml') categoryDisplay = 'Mobile Legend';
    else if (d.category === 'toram') categoryDisplay = 'Toram Online';
    else if (d.category === 'lifeafter') categoryDisplay = 'Life After';

    const firstImage = (d.imageUrls && d.imageUrls.length > 0) ? d.imageUrls[0] : 'https://via.placeholder.com/160x160?text=No+Image';

    card.innerHTML = `
      <div class="image-gallery">
        <img src="${firstImage}" alt="Gambar Akun ${categoryDisplay}">
      </div>
      <div class="card-content">
        <h3>${categoryDisplay}</h3>
        <p>Status: <span style="color: ${d.status === 'terjual' ? 'red' : 'green'}; font-weight: bold;">${d.status === 'terjual' ? 'Terjual' : 'Tersedia'}</span></p>
        <p class="price">Rp ${d.price.toLocaleString('id-ID')}</p>
      </div>
      <span class="status-badge ${d.status === 'terjual' ? 'terjual' : ''}">${d.status === 'terjual' ? 'Terjual' : 'Tersedia'}</span>
    `;
    targetDiv.appendChild(card);

    // Add click listener for detail modal only on buy page cards
    if (isBuyPage) {
      card.addEventListener('click', () => showAccountDetailModal(d.id));
    }
  });
}

// Function to show account detail modal
async function showAccountDetailModal(accountId) {
  const account = allAccountsData.find(acc => acc.id === accountId);
  if (!account) {
    console.error("Account not found for ID:", accountId);
    return;
  }

  currentAccountDetail = account; // Store for image viewer

  const modal = document.getElementById('accountDetailModal');
  document.getElementById('modal-account-title').textContent = `Detail Akun ${account.category === 'ml' ? 'Mobile Legend' : account.category === 'toram' ? 'Toram Online' : 'Life After'}`;
  document.getElementById('modal-account-price').textContent = `Harga: Rp ${account.price.toLocaleString('id-ID')}`;
  document.getElementById('modal-owner-name').textContent = account.ownerName || 'N/A';
  document.getElementById('modal-owner-whatsapp').href = `https://wa.me/${account.ownerWhatsapp}`;

  const mainImage = document.getElementById('modal-main-image');
  const thumbnailGallery = document.getElementById('modal-thumbnail-gallery');
  const detailsDiv = document.getElementById('modal-account-details');

  // Clear previous content
  mainImage.src = '';
  thumbnailGallery.innerHTML = '';
  detailsDiv.innerHTML = '';

  // Populate images
  if (account.imageUrls && account.imageUrls.length > 0) {
    mainImage.src = account.imageUrls[0];
    mainImage.alt = `Main image of ${account.category} account`;
    account.imageUrls.forEach((url, index) => {
      const thumb = document.createElement('img');
      thumb.src = url;
      thumb.alt = `Thumbnail ${index + 1}`;
      thumb.addEventListener('click', () => {
        mainImage.src = url; // Change main image on thumbnail click
      });
      thumbnailGallery.appendChild(thumb);
    });
  } else {
    mainImage.src = 'https://via.placeholder.com/400x300?text=No+Image';
    mainImage.alt = 'No image available';
  }

  // Populate game-specific details
  let detailsHtml = '';
  if (account.category === 'ml' && account.ml) {
    const ml = account.ml;
    detailsHtml += `
      <div class="modal-detail-section">
        <h4>Detail Mobile Legend</h4>
        <p><strong>Rank Saat Ini:</strong> ${ml.rankNow || 'N/A'}</p>
        <p><strong>Rank Tertinggi:</strong> ${ml.rankHighest || 'N/A'}</p>
        <p><strong>Win Rate All Season:</strong> ${ml.winAllMatches ? `${ml.winAllMatches} Pertandingan (${ml.winAllPercent}%)` : 'N/A'}</p>
        <p><strong>Win Rate Season Ini:</strong> ${ml.winSeasonMatches ? `${ml.winSeasonMatches} Pertandingan (${ml.winSeasonPercent}%)` : 'N/A'}</p>
        <p><strong>Role:</strong> ${ml.role || 'N/A'}</p>
        <p><strong>Hero Favorit:</strong> ${ml.heroes && ml.heroes.length > 0 ? ml.heroes.map(h => `${h.name} (${h.wr}%)`).join(', ') : 'N/A'}</p>
        <p><strong>Emblem Maximal:</strong> Level ${ml.emblem || 'N/A'}</p>
        <p><strong>Total Skin:</strong> ${ml.skins || 'N/A'}</p>
      </div>
    `;
  } else if (account.category === 'toram' && account.toram) {
    const toram = account.toram;
    detailsHtml += `
      <div class="modal-detail-section">
        <h4>Detail Toram Online</h4>
        <p><strong>Main Quest:</strong> ${toram.mainQuest || 'N/A'}</p>
        <p><strong>Slot Character:</strong> ${toram.characters && toram.characters.length > 0 ? toram.characters.map(c => `Lv.${c.level} (${c.job})`).join(', ') : 'N/A'}</p>
        <p><strong>Equip Untrade:</strong> ${toram.equip && toram.equip.length > 0 ? toram.equip.join(', ') : 'N/A'}</p>
        <p><strong>Gudang:</strong> ${toram.gudang && toram.gudang.length > 0 ? toram.gudang.map(g => `${g.name} (${g.slot} Slot)`).join(', ') : 'N/A'}</p>
        <p><strong>Total ORB:</strong> ${toram.orb || 'N/A'}</p>
        <p><strong>Total Tiket:</strong> ${toram.tiket || 'N/A'}</p>
      </div>
    `;
  } else if (account.category === 'lifeafter' && account.lifeafter) {
    const la = account.lifeafter;
    detailsHtml += `
      <div class="modal-detail-section">
        <h4>Detail Life After</h4>
        <p><strong>Server:</strong> ${la.serverCategory === 'easy' ? 'EasyServer' : la.serverCategory === 'sea' ? `SEA Server (${la.serverDetail || 'N/A'})` : la.serverCategory === 'na' ? `NA Server (${la.serverDetail || 'N/A'})` : 'N/A'}</p>
        <p><strong>Level Manor:</strong> ${la.manor || 'N/A'}</p>
        <p><strong>Level Gether:</strong> ${la.levelGether || 'N/A'}</p>
        <p><strong>Level Craft:</strong> ${la.levelCraft || 'N/A'}</p>
        <p><strong>Level Combat:</strong> ${la.levelCombat || 'N/A'}</p>
        <p><strong>Light Weapon Attachment:</strong> ${getDetailedAttachmentDisplay(la.attachments?.lightWeapon)}</p>
        <p><strong>Heavy Weapon Attachment:</strong> ${getDetailedAttachmentDisplay(la.attachments?.heavyWeapon)}</p>
        <p><strong>Meele Weapon Attachment:</strong> ${getDetailedAttachmentDisplay(la.attachments?.meeleWeapon)}</p>
        <p><strong>Armor Attachment:</strong> ${getDetailedAttachmentDisplay(la.attachments?.armor)}</p>
        <p><strong>Kategori Job:</strong> ${la.jobCategory || 'N/A'}</p>
        <p><strong>Job Detail:</strong> ${la.jobDetail || 'N/A'}</p>
        <p><strong>Gene:</strong> ${la.gene || 'N/A'}</p>
        <p><strong>Score Charisma:</strong> ${la.charisma || 'N/A'}</p>
        <p><strong>Total Outfit:</strong> Collector: ${la.outfit?.collector || 0}, Gacha: ${la.outfit?.gacha || 0}, Mall: ${la.outfit?.mall || 0}, Common: ${la.outfit?.common || 0}</p>
      </div>
    `;
  }
  detailsDiv.innerHTML = detailsHtml;

  modal.classList.add('show'); // Add 'show' class to trigger transition
  modal.style.display = 'flex'; // Show the modal
}


// Dynamic game fields visibility
function showGameFields() {
  document.getElementById('ml-fields').classList.add('hidden');
  document.getElementById('toram-fields').classList.add('hidden');
  document.getElementById('lifeafter-fields').classList.add('hidden');
  document.getElementById('sea-server-fields').classList.add('hidden');
  document.getElementById('na-server-fields').classList.add('hidden'); // Hide all sub-servers too
  document.getElementById('la-job-detail').classList.add('hidden'); // Hide job detail dropdown

  const val = document.getElementById('game-category').value;
  if (val === 'ml') document.getElementById('ml-fields').classList.remove('hidden');
  if (val === 'toram') document.getElementById('toram-fields').classList.remove('hidden');
  if (val === 'lifeafter') document.getElementById('lifeafter-fields').classList.remove('hidden');
}

function showLifeAfterServer() {
  const val = document.getElementById('lifeafter-server').value;
  document.getElementById('sea-server-fields').classList.add('hidden');
  document.getElementById('na-server-fields').classList.add('hidden');
  
  // Reset character level max values
  document.getElementById('la-level-gether').max = 149;
  document.getElementById('la-level-craft').max = 149;
  document.getElementById('la-level-combat').max = 149;

  if (val === 'sea') document.getElementById('sea-server-fields').classList.remove('hidden');
  if (val === 'na') document.getElementById('na-server-fields').classList.remove('hidden');
  if (val === 'easy') {
    document.getElementById('la-level-gether').max = 79;
    document.getElementById('la-level-craft').max = 79;
    document.getElementById('la-level-combat').max = 79;
  }
}

function showLifeAfterJob() {
  const jobCategory = document.getElementById('la-job-category').value;
  const jobDetailDropdown = document.getElementById('la-job-detail');
  jobDetailDropdown.innerHTML = '<option value="">Pilih Job</option>';
  jobDetailDropdown.classList.add('hidden');

  let jobs = [];
  if (jobCategory === 'Combat') {
    jobs = ['Virus', 'Spore Hunter', 'Warrior', 'Rifleman', 'Sniper', 'Exorcist', 'Ark Knight'];
  } else if (jobCategory === 'Gether') {
    jobs = ['Logger', 'Miner', 'Hemp Picker'];
  } else if (jobCategory === 'Craft') {
    jobs = ['Gun Maker', 'Armorer'];
  }

  if (jobs.length > 0) {
    jobs.forEach(job => {
      const option = document.createElement('option');
      option.value = job;
      option.textContent = job;
      jobDetailDropdown.appendChild(option);
    });
    jobDetailDropdown.classList.remove('hidden');
  }
}

// Dynamic field add/remove functions
function addMlHeroField() {
  const container = document.getElementById('ml-heroes-container');
  if (container.querySelectorAll('.item-group').length < 3) {
    const div = document.createElement('div');
    div.className = 'item-group';
    div.innerHTML = `
      <input type="text" class="ml-hero-name" placeholder="Nama Hero">
      <input type="number" class="ml-hero-wr" placeholder="Win Rate Hero (%)" min="0" max="100">
      <button type="button" class="remove-item-btn" onclick="this.parentElement.remove()">Hapus</button>
    `;
    container.appendChild(div);
  } else {
    showAlert(postAlert, 'Mobile Legend: Maksimal 3 Hero Favorit.', 'error');
  }
}

function addToramCharacterField() {
  const container = document.getElementById('toram-characters-container');
  const div = document.createElement('div');
  div.className = 'item-group';
  div.innerHTML = `
    <input type="number" class="toram-char-level" placeholder="Level Character" min="1">
    <input type="text" class="toram-char-job" placeholder="Deskripsi Job Character (contoh: Tank)">
    <button type="button" class="remove-item-btn" onclick="this.parentElement.remove()">Hapus</button>
  `;
  container.appendChild(div);
}

function addToramEquipField() {
  const container = document.getElementById('toram-equip-container');
  const div = document.createElement('div');
  div.className = 'item-group';
  div.innerHTML = `
    <input type="text" class="toram-equip-desc" placeholder="Deskripsi Item Equip (contoh: Pedang A)">
    <button type="button" class="remove-item-btn" onclick="this.parentElement.remove()">Hapus</button>
  `;
  container.appendChild(div);
}

function addToramGudangField() {
  const container = document.getElementById('toram-gudang-container');
  const div = document.createElement('div');
  div.className = 'item-group';
  div.innerHTML = `
    <input type="text" class="toram-gudang-name" placeholder="Nama Gudang (contoh: A)">
    <input type="number" class="toram-gudang-slot" placeholder="Jumlah Slot" min="0">
    <button type="button" class="remove-item-btn" onclick="this.parentElement.remove()">Hapus</button>
  `;
  container.appendChild(div);
}


// Preview multiple images before upload
document.getElementById('account-images').addEventListener('change', function(event) {
  const previewContainer = document.getElementById('image-previews');
  previewContainer.innerHTML = ''; // Clear previous previews
  previewContainer.classList.add('hidden');

  const files = event.target.files;
  if (files.length > 0) {
    if (files.length > 12) {
      showAlert(postAlert, 'Maksimal 12 gambar yang dapat diunggah.', 'error');
      event.target.value = ''; // Clear selected files
      return;
    }
    previewContainer.classList.remove('hidden');
    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = document.createElement('img');
        img.src = e.target.result;
        img.alt = `Preview Gambar ${i + 1}`; // Add alt text
        img.style.objectFit = 'contain'; // Pastikan gambar preview tidak terpotong
        previewContainer.appendChild(img);
      }
      reader.readAsDataURL(file);
    }
  }
});


// Image modal viewer (for profile page and post page previews)
document.addEventListener('click', function(e) {
  if (e.target.tagName === 'IMG' && (e.target.closest('.image-gallery') || e.target.closest('#image-previews'))) {
    // This is the old image modal, keep it for profile/post page previews
    const modalImage = document.getElementById('modalImage');
    const imageModal = document.getElementById('imageModal');
    if (modalImage && imageModal) {
      modalImage.src = e.target.src;
      imageModal.style.display = 'flex'; // Use flex to center
    }
  }
});

// --- Filter Functions ---
function toggleGameFilters() {
  const category = document.getElementById('filter-category').value;
  document.getElementById('ml-filters').classList.add('hidden');
  document.getElementById('toram-filters').classList.add('hidden');
  document.getElementById('lifeafter-filters').classList.add('hidden');

  // Reset specific filters when category changes
  document.getElementById('filter-ml-role').value = 'all';
  document.getElementById('filter-toram-char-count').value = '';
  document.getElementById('filter-toram-char-level').value = '';
  document.getElementById('filter-toram-mq').value = '';
  document.getElementById('filter-la-server').value = 'all';
  document.getElementById('filter-la-manor').value = '';

  if (category === 'ml') {
    document.getElementById('ml-filters').classList.remove('hidden');
  } else if (category === 'toram') {
    document.getElementById('toram-filters').classList.remove('hidden');
  } else if (category === 'lifeafter') {
    document.getElementById('lifeafter-filters').classList.remove('hidden');
  }
}

function applyFilters() {
  const categoryFilter = document.getElementById('filter-category').value;
  const searchKeyword = document.getElementById('search-input').value.toLowerCase().trim();
  const sortBy = document.getElementById('sort-by').value;

  let filteredAccounts = allAccountsData.filter(d => d.status === 'belum'); // Always filter by 'belum' status

  // Apply category filter
  if (categoryFilter !== 'all') {
    filteredAccounts = filteredAccounts.filter(account => account.category === categoryFilter);
  }

  // Apply game-specific filters
  if (categoryFilter === 'ml') {
    const roleFilter = document.getElementById('filter-ml-role').value;
    if (roleFilter !== 'all') {
      filteredAccounts = filteredAccounts.filter(account => account.ml && account.ml.role === roleFilter);
    }
  } else if (categoryFilter === 'toram') {
    const minCharCount = parseInt(document.getElementById('filter-toram-char-count').value) || 0;
    const minCharLevel = parseInt(document.getElementById('filter-toram-char-level').value) || 0;
    const mqFilter = document.getElementById('filter-toram-mq').value.toLowerCase().trim();

    filteredAccounts = filteredAccounts.filter(account => {
      if (!account.toram) return false;

      if (minCharCount > 0 && (!account.toram.characters || account.toram.characters.length < minCharCount)) {
        return false;
      }
      if (minCharLevel > 0) {
        const hasHighEnoughLevelChar = account.toram.characters && account.toram.characters.some(char => (char.level || 0) >= minCharLevel);
        if (!hasHighEnoughLevelChar) {
          return false;
        }
      }
      if (mqFilter && (!account.toram.mainQuest || !account.toram.mainQuest.toLowerCase().includes(mqFilter))) {
        return false;
      }
      return true;
    });
  } else if (categoryFilter === 'lifeafter') {
    const serverFilter = document.getElementById('filter-la-server').value;
    const minManorLevel = parseInt(document.getElementById('filter-la-manor').value) || 0;

    filteredAccounts = filteredAccounts.filter(account => {
      if (!account.lifeafter) return false;

      if (serverFilter !== 'all' && account.lifeafter.serverCategory !== serverFilter) {
        return false;
      }
      if (minManorLevel > 0 && (account.lifeafter.manor || 0) < minManorLevel) {
        return false;
      }
      return true;
    });
  }

  // Apply search keyword filter (general search across relevant fields)
  if (searchKeyword) {
    filteredAccounts = filteredAccounts.filter(account => {
      const searchString = JSON.stringify(account).toLowerCase(); // Convert entire account object to string for broad search
      return searchString.includes(searchKeyword);
    });
  }

  // Apply sorting
  if (sortBy === 'price-asc') {
    filteredAccounts.sort((a, b) => a.price - b.price);
  } else if (sortBy === 'price-desc') {
    filteredAccounts.sort((a, b) => b.price - a.price);
  } else { // 'newest' or default
    filteredAccounts.sort((a, b) => b.postedAt - a.postedAt);
  }

  displayAccounts(filteredAccounts, document.getElementById('buy-account-list'), true);
}

function resetFilters() {
  document.getElementById('filter-category').value = 'all';
  document.getElementById('search-input').value = '';
  document.getElementById('sort-by').value = 'newest';
  toggleGameFilters(); // This will hide all specific filters and reset their values
  // applyFilters(); // Re-apply filters to show all available accounts - NO LONGER CALLED HERE
}

// Function to load chat messages based on category
async function loadChatMessages(category, partnerId = null) {
  const user = auth.currentUser;
  if (!user) {
    chatMessagesDiv.innerHTML = '<p style="text-align: center; color: red;">Anda harus login untuk melihat pesan.</p>';
    return;
  }

  chatMessagesDiv.innerHTML = '<p style="text-align: center; color: #666;">Memuat pesan...</p>';

  let chatRef;
  if (category === 'global') {
    chatRef = db.ref('community_chats/global');
  } else if (category === 'public') {
    chatRef = db.ref('community_chats/public');
  } else if (category === 'private' && partnerId) {
    // For private chat, create a unique room ID between two users
    const roomId = [user.uid, partnerId].sort().join('_');
    chatRef = db.ref('community_chats/private/' + roomId);
  } else {
    chatMessagesDiv.innerHTML = '<p style="text-align: center; color: red;">Kategori chat tidak valid atau partner tidak dipilih.</p>';
    return;
  }

  // Detach previous listener if any
  if (window.currentChatListener) {
    window.currentChatListener.off();
  }

  // Listen for real-time updates
  window.currentChatListener = chatRef.on('value', async (snapshot) => { // Made async to await user data
    chatMessagesDiv.innerHTML = ''; // Clear existing messages
    if (snapshot.exists()) {
      const messages = [];
      snapshot.forEach(child => {
        messages.push(child.val());
      });

      // Fetch all unique sender profiles
      const uniqueSenderIds = [...new Set(messages.map(msg => msg.senderId))];
      const senderProfiles = {};
      for (const senderId of uniqueSenderIds) {
        try {
          const userSnapshot = await db.ref('users/' + senderId).once('value');
          if (userSnapshot.exists()) {
            senderProfiles[senderId] = userSnapshot.val();
          } else {
            senderProfiles[senderId] = { name: 'Pengguna Tidak Dikenal', profilePicUrl: 'https://via.placeholder.com/40' };
          }
        } catch (error) {
          console.error(`Error fetching profile for ${senderId}:`, error);
          senderProfiles[senderId] = { name: 'Pengguna Tidak Dikenal', profilePicUrl: 'https://via.placeholder.com/40' };
        }
      }

      messages.forEach(message => {
        const senderProfile = senderProfiles[message.senderId];
        const messageElement = document.createElement('div');
        messageElement.className = `chat-message ${message.senderId === user.uid ? 'sent' : 'received'}`;
        
        const date = new Date(message.timestamp);
        const timeString = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
        const dateString = date.toLocaleDateString('id-ID', { day: '2-digit', month: 'short' });

        messageElement.innerHTML = `
          <img src="${senderProfile.profilePicUrl || 'https://via.placeholder.com/40'}" alt="${senderProfile.name}" class="avatar">
          <div class="message-content">
            <span class="sender-name">${senderProfile.name}</span>
            <p class="message-text">${message.text}</p>
            <span class="timestamp">${dateString}, ${timeString}</span>
          </div>
        `;
        chatMessagesDiv.appendChild(messageElement);
      });
      // Scroll to bottom
      chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
    } else {
      chatMessagesDiv.innerHTML = '<p style="text-align: center; color: #666;">Belum ada pesan. Mulai percakapan!</p>';
    }
  }, (error) => {
    console.error("Error loading chat messages:", error);
    showAlert(chatAlert, 'Gagal memuat pesan.', 'error');
  });
}

// Function to send chat message
sendChatBtn.addEventListener('click', async () => {
  const user = auth.currentUser;
  if (!user) {
    showAlert(chatAlert, 'Anda harus login untuk mengirim pesan.', 'error');
    return;
  }

  const messageText = chatInput.value.trim();
  if (messageText === '') {
    showAlert(chatAlert, 'Pesan tidak boleh kosong.', 'error');
    return;
  }

  try {
    const userDoc = await db.ref('users/' + user.uid).once('value');
    const userData = userDoc.val();

    let chatPath;
    if (currentChatCategory === 'global') {
      chatPath = 'community_chats/global';
    } else if (currentChatCategory === 'public') {
      chatPath = 'community_chats/public';
    } else if (currentChatCategory === 'private' && currentPrivateChatPartnerId) {
      const roomId = [user.uid, currentPrivateChatPartnerId].sort().join('_');
      chatPath = 'community_chats/private/' + roomId;
      // For private chat, ensure user1 and user2 are set if it's a new room
      const roomRef = db.ref(chatPath);
      const roomSnapshot = await roomRef.once('value');
      if (!roomSnapshot.exists()) {
        await roomRef.set({
          user1: user.uid,
          user2: currentPrivateChatPartnerId,
          createdAt: firebase.database.ServerValue.TIMESTAMP
        });
      }
    } else {
      showAlert(chatAlert, 'Kategori chat tidak valid.', 'error');
      return;
    }

    // Always include senderId matching auth.uid for rules
    await db.ref(chatPath).push({
      senderId: user.uid,
      senderName: userData?.name || 'Unknown',
      senderPic: userData?.profilePicUrl || 'https://via.placeholder.com/40', // Include sender's profile picture
      text: messageText,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    });
    chatInput.value = '';
    showAlert(chatAlert, 'Pesan terkirim!', 'success');
  } catch (err) {
    console.error("Error sending message:", err);
    showAlert(chatAlert, `Gagal mengirim pesan: ${err.message}`, 'error');
  }
});

// Switch chat categories
chatTabButtons.forEach(button => {
  button.addEventListener('click', (e) => {
    const category = e.target.dataset.chatCategory;
    switchChatCategory(category);
  });
});

async function switchChatCategory(category) {
  currentChatCategory = category;
  currentPrivateChatPartnerId = null; // Reset private chat partner

  // Update active button styling
  chatTabButtons.forEach(btn => {
    if (btn.dataset.chatCategory === category) {
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  });

  // Show/hide private chat selection
  if (category === 'private') {
    privateChatSelection.classList.remove('hidden');
    await loadUsersForPrivateChat();
  } else {
    privateChatSelection.classList.add('hidden');
  }

  // Load messages for the selected category
  loadChatMessages(currentChatCategory);
}

// Load users for private chat dropdown
async function loadUsersForPrivateChat() {
  const currentUser = auth.currentUser;
  if (!currentUser) return;

  privateChatUserSelect.innerHTML = '<option value="">Pilih Pengguna</option>';
  try {
    const snapshot = await db.ref('users').once('value');
    snapshot.forEach(child => {
      const userData = child.val();
      if (child.key !== currentUser.uid) { // Don't list current user
        const option = document.createElement('option');
        option.value = child.key;
        option.textContent = userData.name;
        privateChatUserSelect.appendChild(option);
      }
    });
  } catch (error) {
    console.error("Error loading users for private chat:", error);
    showAlert(chatAlert, 'Gagal memuat daftar pengguna untuk chat privat.', 'error');
  }
}

// Start private chat
startPrivateChatBtn.addEventListener('click', () => {
  const selectedUserId = privateChatUserSelect.value;
  if (selectedUserId) {
    currentPrivateChatPartnerId = selectedUserId;
    loadChatMessages('private', selectedUserId);
    showAlert(chatAlert, `Anda sekarang chatting dengan ${privateChatUserSelect.options[privateChatUserSelect.selectedIndex].text}`, 'info');
  } else {
    showAlert(chatAlert, 'Harap pilih pengguna untuk memulai chat privat.', 'error');
  }
});


// Initial load check
auth.onAuthStateChanged(user => {
  if (!user) {
    hideAllPages();
    loginForm.classList.remove('hidden');
  } else {
    // If user is logged in, default to landing page
    hideAllPages();
    landingPage.classList.remove('hidden');
    loadAccounts(); // Load all accounts data for filtering later
  }
});

// Initial toggle for filters on page load
document.addEventListener("DOMContentLoaded", function() {
  toggleGameFilters(); // Ensure correct filter fields are shown/hidden initially

  // Event listeners for modals
  const accountDetailModal = document.getElementById('accountDetailModal');
  const closeAccountDetailModal = document.getElementById('closeAccountDetailModal');
  const imageViewerModal = document.getElementById('imageViewerModal');
  const closeImageViewerModal = document.getElementById('closeImageViewerModal');
  const modalMainImage = document.getElementById('modal-main-image');
  const prevImageBtn = document.getElementById('prevImage');
  const nextImageBtn = document.getElementById('nextImage');

  if (closeAccountDetailModal) {
    closeAccountDetailModal.addEventListener('click', () => {
      accountDetailModal.classList.remove('show'); // Remove 'show' class for transition
      accountDetailModal.addEventListener('transitionend', function handler() {
        accountDetailModal.style.display = 'none';
        accountDetailModal.removeEventListener('transitionend', handler);
      });
      currentAccountDetail = null; // Clear data
    });
  }

  if (accountDetailModal) {
    accountDetailModal.addEventListener('click', (e) => {
      if (e.target === accountDetailModal) { // Only close if modal background is clicked
        accountDetailModal.classList.remove('show');
        accountDetailModal.addEventListener('transitionend', function handler() {
          accountDetailModal.style.display = 'none';
          accountDetailModal.removeEventListener('transitionend', handler);
        });
        currentAccountDetail = null;
      }
    });
  }

  // --- Image Viewer Modal Functions ---
  if (modalMainImage) { // Check if element exists
    modalMainImage.addEventListener('click', () => {
      if (currentAccountDetail && currentAccountDetail.imageUrls && currentAccountDetail.imageUrls.length > 0) {
        currentImageViewerImages = currentAccountDetail.imageUrls;
        currentImageViewerIndex = currentImageViewerImages.indexOf(modalMainImage.src);
        if (currentImageViewerIndex === -1) currentImageViewerIndex = 0; // Fallback if current image not found

        showImageViewerModal(currentImageViewerIndex);
      }
    });
  }

  function showImageViewerModal(index) {
    if (currentImageViewerImages.length === 0) {
      if (imageViewerModal) imageViewerModal.style.display = 'none';
      return;
    }

    currentImageViewerIndex = index;
    if (document.getElementById('viewerImage')) {
      document.getElementById('viewerImage').src = currentImageViewerImages[currentImageViewerIndex];
    }

    if (prevImageBtn) prevImageBtn.style.display = (currentImageViewerIndex > 0) ? 'flex' : 'none'; // Use flex for centering
    if (nextImageBtn) nextImageBtn.style.display = (currentImageViewerIndex < currentImageViewerImages.length - 1) ? 'flex' : 'none'; // Use flex for centering

    if (imageViewerModal) {
      imageViewerModal.style.display = 'flex';
      setTimeout(() => imageViewerModal.classList.add('show'), 10); // Small delay to ensure display is set before transition
    }
  }

  if (prevImageBtn) {
    prevImageBtn.addEventListener('click', () => {
      if (currentImageViewerIndex > 0) {
        showImageViewerModal(currentImageViewerIndex - 1);
      }
    });
  }

  if (nextImageBtn) {
    nextImageBtn.addEventListener('click', () => {
      if (currentImageViewerIndex < currentImageViewerImages.length - 1) {
        showImageViewerModal(currentImageViewerIndex + 1);
      }
    });
  }

  if (closeImageViewerModal) {
    closeImageViewerModal.addEventListener('click', () => {
      if (imageViewerModal) {
        imageViewerModal.classList.remove('show');
        imageViewerModal.addEventListener('transitionend', function handler() {
          imageViewerModal.style.display = 'none';
          imageViewerModal.removeEventListener('transitionend', handler);
        });
      }
      currentImageViewerImages = [];
      currentImageViewerIndex = 0;
    });
  }

  if (imageViewerModal) {
    imageViewerModal.addEventListener('click', (e) => {
      if (e.target === imageViewerModal) {
        imageViewerModal.classList.remove('show');
        imageViewerModal.addEventListener('transitionend', function handler() {
          imageViewerModal.style.display = 'none';
          imageViewerModal.removeEventListener('transitionend', handler);
        });
        currentImageViewerImages = [];
        currentImageViewerIndex = 0;
      }
    });
  }

  // Existing image preview listener (moved inside DOMContentLoaded)
  const accountImagesInput = document.getElementById('account-images');
  if (accountImagesInput) {
    accountImagesInput.addEventListener('change', function(event) {
      const previewContainer = document.getElementById('image-previews');
      previewContainer.innerHTML = ''; // Clear previous previews
      previewContainer.classList.add('hidden');

      const files = event.target.files;
      if (files.length > 0) {
        if (files.length > 12) {
          showAlert(postAlert, 'Maksimal 12 gambar yang dapat diunggah.', 'error');
          event.target.value = ''; // Clear selected files
          return;
        }
        previewContainer.classList.remove('hidden');
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const reader = new FileReader();
          reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.alt = `Preview Gambar ${i + 1}`; // Add alt text
            img.style.objectFit = 'contain'; // Pastikan gambar preview tidak terpotong
            previewContainer.appendChild(img);
          }
          reader.readAsDataURL(file);
        }
      }
    });
  }

  // Existing image modal viewer (for profile page and post page previews)
  document.addEventListener('click', function(e) {
    if (e.target.tagName === 'IMG' && (e.target.closest('.image-gallery') || e.target.closest('#image-previews'))) {
      const modalImage = document.getElementById('modalImage');
      const imageModal = document.getElementById('imageModal');
      if (modalImage && imageModal) {
        modalImage.src = e.target.src;
        imageModal.style.display = 'flex'; // Use flex to center
      }
    }
  });

  const closeModalBtn = document.getElementById('closeModal');
  const imageModalDiv = document.getElementById('imageModal');
  if (closeModalBtn) {
    closeModalBtn.addEventListener('click', function() {
      if (imageModalDiv) {
        imageModalDiv.style.display = 'none';
        document.getElementById('modalImage').src = '';
      }
    });
  }

  if (imageModalDiv) {
    imageModalDiv.addEventListener('click', (e) => {
      if (e.target === imageModalDiv) { // Only close if modal background is clicked
        imageModalDiv.style.display = 'none';
        document.getElementById('modalImage').src = '';
      }
    });
  }

  // Event listener for category cards on buy page
  categorySelection.addEventListener('click', (e) => {
    const card = e.target.closest('.category-card');
    if (card) {
      const category = card.dataset.category;
      
      // Set filter kategori di dropdown
      filterCategorySelect.value = category;
      toggleGameFilters(); // Update tampilan filter spesifik game
      applyFilters(); // Terapkan filter

      categorySelection.classList.add('hidden'); // Sembunyikan pilihan kategori
      accountListingSection.classList.remove('hidden'); // Tampilkan daftar akun
    }
  });

  // Event listener for "Back to Categories" button
  backToCategoriesBtn.addEventListener('click', () => {
    categorySelection.classList.remove('hidden'); // Tampilkan pilihan kategori
    accountListingSection.classList.add('hidden'); // Sembunyikan daftar akun
    resetFilters(); // Reset filter saat kembali ke kategori
  });

  // Initial load of all accounts data when DOM is ready
  loadAccounts();

}); // End of DOMContentLoaded
</script>

<!-- Image Modal Viewer (old one, kept for profile/post page previews) -->
<div id="imageModal" class="hidden" style="position:fixed;z-index:9999;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;">
  <span id="closeModal" style="position:absolute;top:20px;right:30px;color:white;font-size:40px;cursor:pointer;">&times;</span>
  <img id="modalImage" src="" style="max-width:90%;max-height:90%;border-radius:10px;box-shadow:0 0 20px rgba(0,0,0,0.5);">
</div>


<script>
function loadCategoryIcons() {
    const storage = firebase.storage();
    const icons = {
        "mobile-legend": "mobile_legend_icon.jpg",
        "toram-online": "toram_online_icon.jpg",
        "life-after": "life_after_icon.jpg",
        "all-games": "all_games_icon.png"
    };

    for (let id in icons) {
        storage.ref(`category_icons/${icons[id]}`).getDownloadURL()
            .then(url => {
                const img = document.getElementById(`icon-${id}`);
                if (img) img.src = url;
            })
            .catch(err => console.error("Gagal load icon:", err));
    }
}
document.addEventListener("DOMContentLoaded", loadCategoryIcons);
</script>

</body>
</html>
